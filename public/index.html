<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Learning Platform - Student Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel='stylesheet' href='styles.css'>
    <style>
        /* Avatar Selector Styles */
        .avatar-section {
            margin-bottom: 20px;
        }

        .avatar-section h4 {
            color: #ccc;
            margin-bottom: 10px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .avatar-grid {
            display: flex;
            gap: 18px;
            flex-wrap: wrap;
            justify-content: center;
            /* Center align for better look */
        }

        .avatar-item {
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .avatar-item img {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 2px solid transparent;
            transition: 0.25s ease;
            object-fit: cover;
            background: #1e1e1e;
        }

        .avatar-item span {
            display: block;
            margin-top: 6px;
            font-size: 12px;
            color: #cfc7ff;
        }

        .avatar-item:hover img {
            transform: scale(1.1);
        }

        .avatar-item.selected img {
            border-color: #9b7cff;
            box-shadow: 0 0 12px rgba(155, 124, 255, 0.6);
            transform: scale(1.1);
        }
    </style>
</head>

<body>

    <!-- AUTH SECTION (Login/Signup) -->
    <div id="auth-container">
        <!-- Global Floating Back Button -->
        <div id="auth-back-btn" onclick="app.backToRoles()" title="Back to Role Selection" role="button" tabindex="0"
            onkeydown="if(event.key === 'Enter') app.backToRoles()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
        </div>

        <!-- Role Selection Card -->
        <div id="role-select-card" class="auth-card auth-card-responsive">
            <h2>Welcome to Day One AI</h2>
            <p>Choose how you want to continue</p>

            <div class="role-grid">
                <!-- Student Card -->
                <div class="role-card-item" onclick="app.selectRole('student')" id="role-card-student" role="button"
                    tabindex="0" onkeydown="if(event.key === 'Enter') app.selectRole('student')">
                    <div class="role-icon" aria-hidden="true">🎓</div>
                    <div class="role-title">Student</div>
                    <div class="role-desc">Learn, practice, and track your progress</div>
                    <div class="role-features">
                        <div class="role-feature-item">Personalized learning</div>
                        <div class="role-feature-item">Weekly & monthly tests</div>
                        <div class="role-feature-item">AI progress tracking</div>
                    </div>
                </div>

                <!-- Teacher Card -->
                <div class="role-card-item" onclick="app.selectRole('teacher')" id="role-card-teacher" role="button"
                    tabindex="0" onkeydown="if(event.key === 'Enter') app.selectRole('teacher')">
                    <div class="role-icon" aria-hidden="true">👨‍🏫</div>
                    <div class="role-title">Teacher</div>
                    <div class="role-desc">Guide students and monitor performance</div>
                    <div class="role-features">
                        <div class="role-feature-item">Create assessments</div>
                        <div class="role-feature-item">Monitor progress</div>
                        <div class="role-feature-item">AI insights</div>
                    </div>
                </div>

                <!-- Parent Card -->
                <div class="role-card-item" onclick="app.selectRole('parent')" id="role-card-parent" role="button"
                    tabindex="0" onkeydown="if(event.key === 'Enter') app.selectRole('parent')">
                    <div class="role-icon" aria-hidden="true">👨‍👩‍👧</div>
                    <div class="role-title">Parent</div>
                    <div class="role-desc">Monitor your child's learning journey</div>
                    <div class="role-features">
                        <div class="role-feature-item">View progress</div>
                        <div class="role-feature-item">Check attendance</div>
                        <div class="role-feature-item">Track assignments</div>
                    </div>
                </div>
            </div>

            <button id="role-continue-btn" class="btn-primary" onclick="app.confirmRole()" disabled>Continue</button>
        </div>

        <!-- Login Card -->
        <!-- Login Card -->
        <div id="login-card" class="auth-card hidden">
            <h2 class="auth-title">Student Portal</h2>
            <p class="auth-subtitle">Welcome back! Please login to continue.</p>
            <form id="login-form">
                <div class="input-group">
                    <input type="text" id="login-user" placeholder=" " required class="input-modern">
                    <label for="login-user">Username or Email</label>
                </div>
                <div class="input-group">
                    <input type="password" id="login-pass" placeholder=" " required class="input-modern">
                    <label for="login-pass">Password</label>
                    <button type="button" class="password-toggle" onclick="app.togglePass('login-pass', this)"
                        aria-label="Toggle password visibility">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                </div>
                <!-- Forgot Password Link -->
                <div class="forgot-pass-container">
                    <a href="#" class="forgot-pass-link" onclick="openForgotPassword()">Forgot Password?</a>
                </div>
                <button type="submit" class="btn-primary btn-login-action">
                    <span>Login</span>
                    <div class="btn-loader hidden"></div>
                </button>
            </form>
            <div class="auth-switch">
                <button type="button" class="btn-link-secondary" onclick="app.toggleAuth('signup')">Create
                    Account</button>
            </div>
        </div>

        <!-- Parent Login Card -->
        <div id="parent-login-card" class="auth-card hidden">
            <h2 class="auth-title">Parent Portal</h2>
            <p class="auth-subtitle">Logging in as Parent</p>
            <p class="auth-desc">
                Access your child’s learning progress and activity
            </p>
            <form id="parent-login-form" onsubmit="app.handleLogin(event)">
                <div class="input-group">
                    <input type="text" id="parent-login-user" placeholder=" " required class="input-modern">
                    <label for="parent-login-user">Student Email or Phone Number</label>
                </div>
                <div class="input-group">
                    <input type="password" id="parent-login-pass" placeholder=" " required class="input-modern">
                    <label for="parent-login-pass">Student Password</label>
                    <button type="button" class="password-toggle" onclick="app.togglePass('parent-login-pass', this)"
                        aria-label="Toggle password visibility">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                </div>

                <p class="auth-info-text text-center-small">
                    Parents log in using the student’s registered credentials.
                </p>

                <!-- Forgot Password Replacement -->
                <div class="forgot-pass-container">
                    <span class="forgot-pass-link auth-contact-text">
                        Contact the student to reset password
                    </span>
                </div>

                <button type="submit" class="btn-primary btn-login-action">
                    <span>Login as Parent</span>
                    <div class="btn-loader hidden"></div>
                </button>
            </form>
            <!-- No Signup for Parents -->
            <div class="auth-switch"></div>
        </div>

        <!-- Signup Card -->
        <div id="signup-card" class="auth-card hidden signup-card-anim">
            <h2>Join Now</h2>
            <p>Create your student profile.</p>
            <form id="signup-form">
                <!-- 1. Full Name -->
                <div class="input-group">
                    <input type="text" id="signup-name" placeholder=" " required>
                    <label for="signup-name">Full Name</label>
                </div>

                <!-- 2. Class / Grade (Dropdown) -->
                <div class="input-group">
                    <select id="signup-grade" required>
                        <option value="" disabled selected hidden></option> <!-- Hidden placeholder -->
                        <option value="1">1st Grade</option>
                        <option value="2">2nd Grade</option>
                        <option value="3">3rd Grade</option>
                        <option value="4">4th Grade</option>
                        <option value="5">5th Grade</option>
                        <option value="6">6th Grade</option>
                        <option value="7">7th Grade</option>
                        <option value="8">8th Grade</option>
                        <option value="9">9th Grade</option>
                        <option value="10">10th Grade</option>
                        <option value="11">11th Grade</option>
                        <option value="12">12th Grade</option>
                    </select>
                    <label for="signup-grade">Class / Grade</label>
                    <span class="dropdown-arrow" aria-hidden="true">▼</span>
                </div>

                <!-- 3. Date of Birth -->
                <div class="input-group">
                    <!-- Date input always "has value" visibly, so label floats permanently via CSS rule -->
                    <input type="date" id="signup-dob" required class="date-input-dark">
                    <label for="signup-dob">Date of Birth</label>
                </div>

                <!-- 4. Email or Mobile -->
                <div class="input-group">
                    <input type="text" id="signup-contact" placeholder=" " required>
                    <label for="signup-contact">Email or Mobile</label>
                </div>

                <!-- 5. Password -->
                <div class="input-group">
                    <input type="password" id="signup-pass" placeholder=" " required>
                    <label for="signup-pass">Password</label>
                </div>

                <!-- PARENT SPECIFIC FIELDS (Hidden by default) -->
                <div id="signup-fields-parent" class="hidden">
                    <p class="signup-parent-label">Link to Student
                        Account</p>
                    <div class="input-group">
                        <input type="email" id="signup-student-email" placeholder=" ">
                        <label for="signup-student-email">Student Email</label>
                    </div>
                    <div class="input-group">
                        <input type="password" id="signup-student-pass" placeholder=" ">
                        <label for="signup-student-pass">Student Password</label>
                    </div>
                </div>

                <button type="submit" class="btn-primary">Sign Up</button>
            </form>
            <div class="auth-switch">
                <button type="button" class="btn-link" onclick="app.toggleAuth('login')">Back to Login</button>
            </div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="dashboard-container">
        <!-- 1. Header -->
        <header class="dashboard-header">
            <!-- Left: Graduation Cap Icon + Greeting -->
            <div class="logo-section">
                <!-- SVG Graduation Cap -->
                <div class="app-icon app-icon-style">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 10v6M2 10l10-5 10 5-10 5-10-5z" />
                        <path d="M6 12v5c3 3 9 3 12 0v-5" />
                    </svg>
                </div>
                <div>
                    <h3 id="welcomeText" class="header-user-name-style">
                        Hi Student, ready to learn today?</h3>
                    <span id="header-user-grade" class="header-user-grade-style">Class 10 | Term
                        1</span>
                </div>
            </div>

            <!-- Center Spacer -->
            <div class="flex-spacer"></div>

            <!-- Right: Search, Bell, Profile Icons -->
            <div class="profile-section">

                <!-- Search -->
                <div class="search-container">
                    <input type="text" id="header-search-input" placeholder="Search topics..."
                        onblur="app.toggleSearch()">
                    <div class="header-icon" onclick="app.toggleSearch()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </div>
                </div>

                <!-- Notification Bell -->
                <div class="header-icon" onclick="app.toggleNotifications()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span class="notif-dot"></span>
                </div>

                <!-- Header Profile Icon (Avatar) -->
                <div class="header-icon header-profile-icon profile-img-container"
                    onclick="app.toggleProfileDropdown()">
                    <img src="" class="header-profile-img d-none profile-img-overlay" alt="Profile">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
            </div>

            <!-- PROFILE DROPDOWN (Level 1) -->
            <div id="profile-dropdown">
                <div class="profile-dd-header">
                    <div class="profile-dd-avatar profile-img-container">
                        <img src="" class="header-profile-img d-none profile-img-overlay" alt="Profile">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                            <circle cx="12" cy="7" r="4" />
                        </svg>
                    </div>
                    <div>
                        <div class="profile-dd-name" id="profileName">Student</div>
                        <div class="profile-dd-class">Class 10 | Term 1</div>
                        <div class="profile-dd-badge">🔥 Consistent Learner</div>
                    </div>
                </div>

                <div class="dd-stats-row">
                    <div class="dd-stat-item" title="Current learning streak">
                        <span class="dd-stat-val">12</span>
                        Days Streak 🔥
                    </div>
                    <div class="dd-stat-item" title="Class Rank">
                        <span class="dd-stat-val">#4</span>
                        Current Rank 🏆
                    </div>
                    <div class="dd-stat-item" title="Overall Completion">
                        <span class="dd-stat-val">75%</span>
                        Completion 📊
                    </div>
                </div>

                <button class="dd-action-btn btn-view-profile"
                    onclick="app.navTo('profile'); app.closeProfileDropdown()">
                    View Full Profile
                </button>

                <div class="dd-buttons-row">
                    <button class="dd-action-btn btn-flex-1"
                        onclick="app.closeProfileDropdown(); app.openEditProfile()">Edit Profile</button>
                    <button class="dd-action-btn btn-flex-1" onclick="app.toggleTheme()">Theme 🌗</button>
                </div>

                <div class="dd-divider"></div>

                <div class="dd-link-row" onclick="app.closeProfileDropdown(); app.navTo('profile')">
                    <span>📈</span> Progress Overview
                </div>
                <div class="dd-link-row" onclick="app.closeProfileDropdown(); app.navTo('achievements')">
                    <span>🏆</span> Achievements
                </div>
                <div class="dd-link-row">
                    <span>⚙️</span> Account Settings
                </div>
                <div class="dd-link-row" onclick="app.closeProfileDropdown(); app.navTo('help')">
                    <span>❓</span> Help & Support
                </div>
                <div class="dd-link-row logout-link" onclick="app.logout()">
                    <span>🚪</span> Logout
                </div>
            </div>
        </header>



        <!-- 2. Vertical Sidebar -->
        <nav class="side-nav">
            <!-- Dashboard (formerly Home) -->
            <div class="nav-item active" data-label="Dashboard" onclick="app.navTo('dashboard')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                    <polyline points="9 22 9 12 15 12 15 22" />
                </svg>
            </div>

            <!-- Assessment (Clipboard Check) -->
            <div class="nav-item hidden" id="studentAssessmentBtn" data-label="Assessment"
                onclick="app.openStudentAssessmentPage()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
                    <path d="M9 14l2 2 4-4" />
                </svg>
            </div>

            <!-- Modulator (AI Study Assistant) -->
            <div class="nav-item" data-label="Modulator" onclick="app.navTo('modulator')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M16 3h5v5" />
                    <path d="M4 20L21 3" />
                    <path d="M21 16v5h-5" />
                    <path d="M15 15l6 6" />
                    <path d="M4 4l5 5" />
                </svg>
            </div>



            <!-- Achievements (Trophy) -->
            <div class="nav-item" data-label="Achievements" onclick="app.navTo('achievements')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
                    <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
                    <path d="M4 22h16" />
                    <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" />
                    <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" />
                    <path d="M18 2H6v7a6 6 0 0 0 12 0V2z" />
                </svg>
            </div>

            <!-- Whiteboard (Pen/Notebook) -->
            <div class="nav-item" data-label="Whiteboard" onclick="app.navTo('whiteboard')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
                    <line x1="8" y1="21" x2="16" y2="21" />
                    <line x1="12" y1="17" x2="12" y2="21" />
                </svg>
            </div>

            <!-- TEACHER ITEMS (Hidden by default) -->
            <div class="nav-item teacher-item hidden" data-label="Attendance" onclick="app.openTeacherAttendance()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                    <path d="M9 12h6"></path>
                    <path d="M9 16h6"></path>
                </svg>
            </div>

            <div class="nav-item teacher-item hidden" data-label="Classes" onclick="app.openTeacherClasses()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>

            <div class="nav-item teacher-item hidden" data-label="Reports" onclick="app.openTeacherAnalytics()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
            </div>

            <div class="nav-item teacher-item hidden" data-label="Assessment" onclick="app.openTeacherAssessment()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
            </div>

            <!-- Help (Smart Support) -->
            <div class="nav-item has-notification" data-label="Help & Support" onclick="app.navTo('help')"
                id="nav-help-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </div>


        </nav>

        <!-- 3. Workspace Area -->
        <div class="dashboard-workspace">
            <!-- HOME SCREEN (Dashboard Cards) -->
            <main id="home-screen" class="screen active">

                <!-- MONTHLY QUIZ BANNER (Full Width) -->
                <div class="dashboard-card section full-width-card monthly-quiz-card">
                    <div class="quiz-deco-circle-1">
                    </div>
                    <div class="quiz-deco-circle-2">
                    </div>
                    <h2 class="quiz-title">Monthly
                        Science
                        Quiz Contest is LIVE!</h2>
                    <p class="quiz-desc">Participate, compete,
                        and
                        improve your rank</p>
                </div>

                <!-- ROW 1: STREAK & PERFORMANCE -->
                <div class="dashboard-card section streak-card-layout">
                    <div class="real-flame-container">
                        <div class="real-flame"></div>
                    </div>
                    <h3 class="streak-title">12 Days Streak</h3>
                    <p class="streak-desc">Consistency builds
                        success.</p>
                </div>

                <div class="dashboard-card section">
                    <div class="card-title">📊 Performance Meter</div>
                    <div class="circular-progress-container">
                        <div class="circular-progress" id="performance-ring">
                            <div class="inner-circle">
                                <span class="score-text" id="performance-text">0%</span>
                                <span class="score-label">Consistent Learner</span>
                            </div>
                        </div>
                    </div>
                    <p class="perf-card-desc">Based on
                        recent learning activity</p>
                </div>

                <!-- ROW 2: ASSESSMENT & ONGOING COURSES -->
                <!-- PENDING ASSESSMENTS MOVED TO SEPARATE PAGE -->

                <div class="dashboard-card section">
                    <div class="card-title">📚 Ongoing Courses</div>
                    <ul class="course-list">
                        <li class="course-item">
                            <div class="course-dot"></div> Science: Physics
                        </li>
                        <li class="course-item">
                            <div class="course-dot"></div> Mathematics: Algebra
                        </li>
                        <li class="course-item">
                            <div class="course-dot"></div> Environmental Studies
                        </li>
                        <li class="course-item">
                            <div class="course-dot course-dot-gray"></div> History (Upcoming)
                        </li>
                    </ul>
                </div>

                <!-- ROW 3: STUDY MATERIALS (Full Width) -->
                <div class="dashboard-card section full-width-card">
                    <div class="card-title">📂 Study Materials</div>
                    <div class="materials-grid materials-grid-cols">
                        <div class="material-icon" onclick="app.openSubject('Tamil')">
                            <div class="material-icon-lg">📖</div>
                            <div class="material-icon-label">Tamil</div>
                        </div>
                        <div class="material-icon" onclick="app.openSubject('English')">
                            <div class="material-icon-lg">📚</div>
                            <div class="material-icon-label">English</div>
                        </div>
                        <div class="material-icon" onclick="app.openSubject('Mathematics')">
                            <div class="material-icon-lg">🧮</div>
                            <div class="material-icon-label">Mathematics</div>
                        </div>
                        <div class="material-icon" onclick="app.openSubject('Science')">
                            <div class="material-icon-lg">🧬</div>
                            <div class="material-icon-label">Science</div>
                        </div>
                        <div class="material-icon" onclick="app.openSubject('Social Science')">
                            <div class="material-icon-lg">🌍</div>
                            <div class="material-icon-label">Social Science</div>
                        </div>
                    </div>
                </div>

                <!-- ROW 4: LEARNING ROADMAP (New Feature) -->
                <div class="dashboard-card section full-width-card margin-top-1-5">
                    <div class="roadmap-header">
                        <div>
                            <div class="card-title">🚗 Learning Roadmap</div>
                            <p class="roadmap-desc">Track your journey
                                from weekly practice to monthly mastery</p>
                        </div>
                        <div class="text-right">
                            <div class="roadmap-progress-text">Week 3 / 4
                            </div>
                            <div class="text-muted-sm">One step away from monthly test!
                            </div>
                        </div>
                    </div>

                    <div class="roadmap-container">
                        <!-- The Track -->
                        <div class="roadmap-track">
                            <!-- Progress Fill -->
                            <div class="roadmap-progress roadmap-progress-demo"></div>

                            <!-- The Car -->
                            <div class="roadmap-car roadmap-car-demo"></div>

                            <!-- Checkpoint 1 -->
                            <div class="checkpoint completed" onclick="alert('Week 1 Test Results: 85% Score')">
                                <span class="checkpoint-label">Week 1</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white"
                                    stroke-width="3">
                                    <polyline points="20 6 9 17 4 12" />
                                </svg>
                            </div>

                            <!-- Checkpoint 2 -->
                            <div class="checkpoint completed" onclick="alert('Week 2 Test Results: 92% Score')">
                                <span class="checkpoint-label">Week 2</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white"
                                    stroke-width="3">
                                    <polyline points="20 6 9 17 4 12" />
                                </svg>
                            </div>

                            <!-- Checkpoint 3 (Current) -->
                            <div class="checkpoint current" onclick="app.startQuiz()">
                                <!-- Reusing Start Quiz for demo -->
                                <span class="checkpoint-label">Week 3</span>
                                <div class="dot-purple-small"></div>
                            </div>

                            <!-- Checkpoint 4 (Locked) -->
                            <div class="checkpoint locked" title="Complete Week 3 to unlock">
                                <span class="checkpoint-label">Week 4</span>
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                                </svg>
                            </div>

                            <!-- Finish Line -->
                            <div class="finish-flag" title="Monthly Challenge Locked">
                                🏁
                            </div>
                        </div>
                    </div>

                    <div class="roadmap-action-container">
                        <button class="btn-primary btn-wide-glow" onclick="app.startQuiz()">
                            Start Weekly Test
                        </button>
                    </div>
                </div>

            </main>

            <!-- STUDENT ASSESSMENT PAGE (New Dedicated Page) -->
            <div id="student-assessment-page" class="screen hidden">
                <div class="screen-header-row">
                    <h2 class="page-title-large">Assessments</h2>
                    <p class="page-subtitle">View and take your scheduled assessments.</p>
                </div>

                <!-- PENDING ASSESSMENTS CONTAINER (Re-inserted here) -->
                <div id="pending-assessments-container" class="dashboard-card section full-width-card">
                    <div class="card-title">📝 Pending Assessments</div>
                    <div id="assessments-list" class="flex-col-gap-1">
                        <!-- Dynamic Assessment Cards Will Go Here -->
                    </div>
                </div>
            </div>

            <!-- TEACHER DASHBOARD SCREEN (Normally Hidden) -->
            <div id="teacher-dashboard-screen" class="screen screen-container">
                <!-- Header Greetings -->
                <div class="screen-header-row">
                    <div>
                        <h2 class="page-title-large">Welcome
                            back, <span id="teacher-welcome-name">Teacher 👨‍🏫</span></h2>
                        <p class="page-subtitle" id="teacher-welcome-subtitle">Here’s what’s
                            happening with your students
                            today</p>
                    </div>
                    <div class="teacher-header-date">
                        <!-- Can add date/time here logic later -->
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="teacher-stats-grid">
                    <div class="dashboard-card section teacher-stat-card">
                        <div class="teacher-stat-icon">👥</div>
                        <h3 class="teacher-stat-value" id="t-stat-students">42
                        </h3>
                        <div class="card-title teacher-stat-label">Total Students</div>
                    </div>
                    <div class="dashboard-card section teacher-stat-card">
                        <div class="teacher-stat-icon">🏫</div>
                        <h3 class="teacher-stat-value" id="t-stat-classes">3</h3>
                        <div class="card-title teacher-stat-label">Active Classes</div>
                    </div>
                    <div class="dashboard-card section teacher-stat-card">
                        <div class="teacher-stat-icon">📝</div>
                        <h3 class="teacher-stat-value" id="t-stat-assessments">15
                        </h3>
                        <div class="card-title teacher-stat-label">Eval Pending</div>
                    </div>
                    <div class="dashboard-card section teacher-stat-card">
                        <div class="teacher-stat-icon">📊</div>
                        <h3 class="teacher-stat-value" id="t-stat-performance">85%
                        </h3>
                        <div class="card-title teacher-stat-label">Avg Performance</div>
                    </div>
                </div>

                <div class="teacher-main-layout">
                    <!-- Left Column -->
                    <div class="flex-col-gap-2">

                        <!-- 2. Today's Highlights (New) -->
                        <div class="dashboard-card full-width-card">
                            <h3 class="section-title">Today's
                                Overview</h3>
                            <div class="action-card-grid">
                                <div class="teacher-action-card" onclick="app.openTeacherClasses()">
                                    <div class="status-icon-green">🟢</div>
                                    <div class="status-label">3 Classes</div>
                                    <div class="status-sublabel">Scheduled Today</div>
                                </div>
                                <div class="teacher-action-card" onclick="app.openTeacherAssessment()">
                                    <div class="status-icon-yellow">🔔</div>
                                    <div class="status-label">2 Tests</div>
                                    <div class="status-sublabel">Ongoing</div>
                                </div>
                                <div class="teacher-action-card" onclick="app.openTeacherAttendance()">
                                    <div class="status-icon-red">📌</div>
                                    <div class="status-label">Pending</div>
                                    <div class="status-sublabel">Attendance & Reports</div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Class Snapshot Section (Refined) -->
                        <div class="dashboard-card full-width-card">
                            <div class="section-header-row">
                                <h3 class="section-title-marginless">Class
                                    Snapshots</h3>
                                <button class="btn-secondary btn-sm" onclick="app.openTeacherClasses()">View
                                    All</button>
                            </div>
                            <!-- Horizontal Scroll Container -->
                            <div class="horizontal-scroll-container">
                                <!-- Snapshot Card 1 -->
                                <div class="class-card class-snap-card-min" onclick="app.openTeacherClasses()">
                                    <div class="class-card-title">
                                        Class 10 - A</div>
                                    <div class="class-card-subtitle">
                                        Science</div>
                                    <div class="class-stat-row">
                                        <span class="text-muted-span">Attendance</span>
                                        <span class="text-green">92%</span>
                                    </div>
                                    <div class="class-stat-row-last">
                                        <span class="text-muted-span">Weekly Test</span>
                                        <span class="text-yellow">78%</span>
                                    </div>
                                </div>
                                <!-- Snapshot Card 2 -->
                                <div class="class-card class-snap-card-min" onclick="app.openTeacherClasses()">
                                    <div class="class-card-title">
                                        Class 9 - B</div>
                                    <div class="class-card-subtitle-light">
                                        Physics</div>
                                    <div class="class-stat-row">
                                        <span class="text-muted-span">Attendance</span>
                                        <span class="text-yellow">85%</span>
                                    </div>
                                    <div class="class-stat-row-last">
                                        <span class="text-muted-span">Weekly Test</span>
                                        <span class="text-green">88%</span>
                                    </div>
                                </div>
                                <!-- Snapshot Card 3 -->
                                <div class="class-card class-snap-card-min" onclick="app.openTeacherClasses()">
                                    <div class="class-card-title">
                                        Class 10 - B</div>
                                    <div class="class-card-subtitle-light">
                                        Maths</div>
                                    <div class="class-stat-row">
                                        <span class="text-muted-span">Attendance</span>
                                        <span class="text-red">72%</span>
                                    </div>
                                    <div class="class-stat-row-last">
                                        <span class="text-muted-span">Weekly Test</span>
                                        <span class="text-yellow">65%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 4. Weekly Progress Analytics (New) -->
                        <div class="dashboard-card full-width-card">
                            <div class="chart-header">
                                <h3 class="section-title-marginless">Weekly
                                    Progress</h3>
                                <div class="legend-container">
                                    <div class="legend-item">
                                        <div class="dot-green-small">
                                        </div> Improved
                                    </div>
                                    <div class="legend-item">
                                        <div class="dot-yellow-small">
                                        </div> Stable
                                    </div>
                                </div>
                            </div>
                            <!-- Fake Chart Representation -->
                            <div class="chart-container">
                                <div class="chart-bar-wrapper">
                                    <div class="bar-purple-light height-60">
                                    </div>
                                    <span class="chart-label-sm">Mon</span>
                                </div>
                                <div class="chart-bar-wrapper">
                                    <div class="bar-purple-med height-80">
                                    </div>
                                    <span class="chart-label-sm">Tue</span>
                                </div>
                                <div class="chart-bar-wrapper">
                                    <div class="bar-purple-med height-75">
                                    </div>
                                    <span class="chart-label-sm">Wed</span>
                                </div>
                                <div class="chart-bar-group">
                                    <div class="bar-green-glow height-110">
                                    </div>
                                    <span class="chart-label">Thu</span>
                                </div>
                                <div class="chart-bar-group">
                                    <div class="bar-purple-light height-50 bar-top-accent">
                                    </div>
                                    <span class="chart-label">Fri</span>
                                </div>
                            </div>
                        </div>

                        <!-- 6. Reports & Communication Panel (New) -->
                        <div class="dashboard-card full-width-card">
                            <h3 class="section-title">Reports
                                & Communication</h3>
                            <div class="teacher-action-grid">
                                <div class="teacher-action-card" onclick="app.openTeacherAnalytics()">
                                    <div class="action-icon-large">📄</div>
                                    <div class="action-title">Weekly Report</div>
                                    <div class="action-meta">Last: 2 days ago</div>
                                </div>
                                <div class="teacher-action-card" onclick="alert('Sending to Parents...')">
                                    <div class="action-icon-large">📤</div>
                                    <div class="action-title">Send to Parents</div>
                                    <div class="action-meta">Last: 1 month ago</div>
                                </div>
                                <div class="teacher-action-card" onclick="alert('Downloading...')">
                                    <div class="action-icon-large">📥</div>
                                    <div class="action-title">Download Summary</div>
                                    <div class="action-meta">Format: PDF</div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Right Column -->
                    <div class="flex-col-gap-2">

                        <!-- 5. AI Teaching Assistant (Keep) -->
                        <div class="dashboard-card ai-assistant-panel">
                            <div class="ai-panel-header">
                                <div class="ai-avatar">
                                    🤖</div>
                                <div>
                                    <h3 class="ai-title">AI Co-Pilot</h3>
                                    <div class="ai-status">Always active</div>
                                </div>
                            </div>
                            <p class="ai-desc">
                                Need help creating a lesson plan, quiz, or explaining a concept? Just ask.
                            </p>
                            <div class="ai-input-container">
                                <input type="text" id="teacher-ai-input" placeholder="Generate MCQs for Algebra..."
                                    class="ai-input">
                                <button onclick="app.askTeacherAI()" class="ai-send-btn" aria-label="Send to AI">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                    </svg>
                                </button>
                            </div>
                            <div id="teacher-ai-response" class="ai-response-box"></div>
                        </div>

                        <!-- 7. Upcoming Tasks Widget (Update with new Requirements) -->
                        <div class="dashboard-card section">
                            <h3 class="widget-title">
                                Upcoming Tasks</h3>
                            <div class="task-list">
                                <!-- Task 1 -->
                                <div class="task-item task-item-red text-muted">
                                    <div class="task-dot-red">
                                    </div>
                                    <div>
                                        <div class="task-header">
                                            Attendance: Class 9</div>
                                        <div class="task-subheader">Due Today</div>
                                    </div>
                                </div>
                                <!-- Task 2 -->
                                <div class="task-item task-item-yellow">
                                    <div class="task-dot-yellow">
                                    </div>
                                    <div>
                                        <div class="task-header">
                                            Weekly Test Review</div>
                                        <div class="task-subheader">Pending</div>
                                    </div>
                                </div>
                                <!-- Task 3 -->
                                <div class="task-item task-item-green">
                                    <div class="task-dot-green">
                                    </div>
                                    <div>
                                        <div class="task-title">
                                            Monthly Report</div>
                                        <div class="task-meta">Due Tomorrow</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 5. Student Attention Needed (New Smart Section - Replaces Insights) -->
                        <div class="dashboard-card section padding-1-5">
                            <h3 class="widget-title-sm">Attention
                                Needed ⚠️</h3>

                            <div class="attention-list">
                                <div class="attention-item">
                                    <div>
                                        <div class="attn-item-name">Rahul Verma
                                        </div>
                                        <div class="attn-item-subtitle">Class 10 - B</div>
                                    </div>
                                    <span class="tag-red">Low
                                        Score</span>
                                </div>
                                <div class="attention-item">
                                    <div>
                                        <div class="attn-item-name">Simran K.</div>
                                        <div class="attn-item-subtitle">Class 9 - A</div>
                                    </div>
                                    <span class="tag-yellow">Absent</span>
                                </div>
                                <div class="attention-item-last">
                                    <div>
                                        <div class="attn-name">Amit Roy</div>
                                        <div class="attn-class">Class 10 - A</div>
                                    </div>
                                    <span class="tag-purple">Skill
                                        Gap</span>
                                </div>
                            </div>

                            <button class="btn-secondary btn-full-width">View Details</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TEACHER ASSESSMENT: LANDING SCREEN -->
            <div id="teacher-assessment-landing" class="screen screen-container">
                <div class="screen-header-row">
                    <div>
                        <h2 class="page-title-large">Build Assessments</h2>
                        <p class="page-subtitle">Create, schedule, and manage subject-wise tests</p>
                    </div>
                    <button class="btn-primary" onclick="app.openCreateAssessment()">
                        <span class="flex-center-gap-05">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Create New Assessment
                        </span>
                    </button>
                </div>

                <div class="assessment-grid">
                    <!-- Subject Cards -->
                    <div class="subject-card" onclick="app.openSubjectAssessments('Tamil')">
                        <div class="subject-icon-large">🕉️</div>
                        <div class="subject-title">Tamil</div>
                        <div class="subject-status">No Tests Created</div>
                        <button class="btn-subject-action">View</button>
                    </div>
                    <div class="subject-card" onclick="app.openSubjectAssessments('English')">
                        <div class="subject-icon-large">📝</div>
                        <div class="subject-title">English</div>
                        <div class="subject-status">2 Scheduled</div>
                        <button class="btn-subject-action">Manage</button>
                    </div>
                    <div class="subject-card" onclick="app.openSubjectAssessments('Mathematics')">
                        <div class="subject-icon-large">📐</div>
                        <div class="subject-title">Mathematics</div>
                        <div class="subject-status">1 Scheduled</div>
                        <button class="btn-subject-action">Manage</button>
                    </div>
                    <div class="subject-card" onclick="app.openSubjectAssessments('Science')">
                        <div class="subject-icon-large">🔬</div>
                        <div class="subject-title">Science</div>
                        <div class="subject-status">3 Tests Live</div>
                        <button class="btn-subject-action">Manage</button>
                    </div>
                    <div class="subject-card" onclick="app.openSubjectAssessments('Social Science')">
                        <div class="subject-icon-large">🌍</div>
                        <div class="subject-title">Social Science</div>
                        <div class="subject-status">No Tests Created</div>
                        <button class="btn-subject-action">View</button>
                    </div>
                </div>
            </div>

            <!-- TEACHER ASSESSMENT: SUBJECT LIST SCREEN -->
            <div id="teacher-assessment-subject-list" class="screen screen-container">
                <div class="assessment-header-row">
                    <button class="back-btn" onclick="app.openTeacherAssessment()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                        Back to Assessments
                    </button>
                    <button class="btn-primary" onclick="app.openCreateAssessment()">
                        + Create Assessment
                    </button>
                </div>

                <h2 class="page-title-large mb-1" id="subject-list-title">Mathematics – Assessments</h2>

                <div class="assessment-list-container" id="assessment-list-content">
                    <!-- Dynamic Content -->
                    <div class="assessment-item">
                        <div class="assess-info">
                            <h4>Unit Test - Algebra</h4>
                            <div class="assess-meta">
                                <span>Class: 8A</span>
                                <span>Date: 15 Feb 2026</span>
                                <span>Time: 10:00 AM - 10:45 AM</span>
                            </div>
                        </div>
                        <div class="assess-actions">
                            <div class="status-badge upcoming">Upcoming</div>
                            <button class="btn-icon-action" title="Edit"><svg width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg></button>
                            <button class="btn-icon-action" title="View Questions"><svg width="18" height="18"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TEACHER ASSESSMENT: CREATE / EDIT SCREEN -->
            <div id="teacher-assessment-create" class="screen screen-container">
                <div class="assessment-header-row">
                    <button class="back-btn" onclick="app.openTeacherAssessment()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                        Cancel & Exit
                    </button>
                    <div class="header-content flex-center">
                        <h3 class="mb-0">Create Assessment</h3>
                        <div id="assessmentStatus" class="status-badge hidden margin-left-1">
                            🟡 Draft
                        </div>
                    </div>
                </div>

                <div class="create-form-layout">
                    <!-- Left: Basic Details -->
                    <div class="form-section">
                        <h4 class="form-title">Basic Details</h4>

                        <div class="input-group">
                            <input type="text" id="assess-title" placeholder=" " class="input-modern">
                            <label>Assessment Title</label>
                        </div>

                        <div class="input-group">
                            <select id="assess-subject" class="input-modern" title="Select Subject">
                                <option value="" disabled selected hidden></option>
                                <option value="Tamil">Tamil</option>
                                <option value="English">English</option>
                                <option value="Mathematics">Mathematics</option>
                                <option value="Science">Science</option>
                                <option value="Social Science">Social Science</option>
                            </select>
                            <label>Subject</label>
                            <span class="dropdown-arrow">▼</span>
                        </div>

                        <div class="input-group">
                            <select id="assess-class" class="input-modern" title="Select Class">
                                <option value="" disabled selected hidden></option>
                                <option value="8A">Class 8 - A</option>
                                <option value="9B">Class 9 - B</option>
                                <option value="10A">Class 10 - A</option>
                            </select>
                            <label>Class / Section</label>
                            <span class="dropdown-arrow">▼</span>
                        </div>

                        <div class="input-group">
                            <input type="date" id="assess-date" class="input-modern">
                            <label>Date</label>
                        </div>

                        <div class="flex-center gap-1">
                            <div class="input-group flex-1">
                                <input type="time" id="assess-start" class="input-modern">
                                <label>Start Time</label>
                            </div>
                            <div class="input-group flex-1">
                                <input type="time" id="assess-end" class="input-modern">
                                <label>End Time</label>
                            </div>
                        </div>

                        <!-- Assessment Status Notification (Added for Requirement) -->
                        <div id="assessmentStatusBox" class="assessment-status hidden">
                            <div id="assessmentStatusText" class="assessment-status-title"></div>
                            <div id="assessmentScheduleText"></div>
                        </div>
                    </div>

                    <!-- Right: Question Builder -->
                    <div class="form-section">
                        <div class="q-header">
                            <h4 class="form-title mb-0">Questions (MCQ)</h4>
                            <span class="text-muted" id="question-count">0 Questions Added</span>
                        </div>

                        <div id="questions-container" class="question-builder-container">
                            <!-- Questions will be added here via JS -->
                        </div>

                        <div class="flex-gap-1 mt-1">
                            <button class="btn-secondary btn-dashed-full flex-1" onclick="app.addQuestion()">
                                + Add Question
                            </button>
                            <button class="btn-primary flex-1" onclick="app.autoAdd30MCQs()">
                                ⚡ Auto Add 30 MCQs
                            </button>
                        </div>
                    </div>
                </div>

                <div class="sticky-footer">
                    <button class="btn-link-secondary" onclick="app.openTeacherAssessment()">Cancel</button>
                    <button id="saveDraftBtn" class="btn-secondary" onclick="app.saveDraft(event)">Save Draft</button>
                    <button id="publishAssessmentBtn" class="btn-primary btn-publish-action" type="button">Publish
                        Assessment</button>

                    <!-- Post-Publish Actions (Hidden Initially) -->
                    <button id="viewStudentBtn" class="btn-secondary hidden"
                        onclick="alert('Student View - Coming Soon')">👁 View as Student</button>
                    <button id="viewResultsBtn" class="btn-primary hidden"
                        onclick="alert('Results View - Coming Soon')">📊 View Results</button>
                </div>
            </div>

            <!-- TEACHER CLASSES SCREEN -->
            <div id="teacher-classes-screen" class="screen screen-container">
                <!-- Header -->
                <div class="screen-header-row">
                    <div>
                        <h2 class="page-title-large">My Classes
                        </h2>
                        <p class="page-subtitle">Manage classes, subjects, and student
                            performance</p>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filter-row">
                    <select class="t-filter-select" id="tc-filter-class" onchange="app.renderTeacherClasses()"
                        aria-label="Filter by Class" title="Filter by Class">
                        <option value="all">All Classes</option>
                        <option value="10">Class 10</option>
                        <option value="9">Class 9</option>
                    </select>
                    <select class="t-filter-select" id="tc-filter-subject" onchange="app.renderTeacherClasses()"
                        aria-label="Filter by Subject" title="Filter by Subject">
                        <option value="all">All Subjects</option>
                        <option value="Science">Science</option>
                        <option value="Physics">Physics</option>
                        <option value="Maths">Maths</option>
                    </select>
                </div>

                <!-- Class Grid -->
                <div id="tc-class-grid" class="class-grid">
                    <!-- Injected via JS -->
                </div>

                <!-- Class Detail Panel (Overlay style or In-place? Prompt says "Expand it", let's do a full screen switch or overlay) -->
                <!-- Let's do a dedicated view section that toggles with grid -->
                <div id="tc-class-detail-view" class="hidden">
                    <button class="btn-secondary margin-bottom-1-5" onclick="app.closeClassDetail()">← Back
                        to Classes</button>

                    <div class="dashboard-card full-width-card margin-bottom-2">
                        <h2 id="tc-detail-title" class="text-white">Class 10 - Science</h2>
                        <div class="tabs-container">
                            <div class="tc-tab active" onclick="app.switchClassTab('students')">📋 Students</div>
                            <div class="tc-tab" onclick="app.switchClassTab('tests')">📝 Tests</div>
                            <div class="tc-tab" onclick="app.switchClassTab('performance')">📊 Performance</div>
                            <div class="tc-tab" onclick="app.switchClassTab('skills')">⚠️ Skill Gaps</div>
                        </div>

                        <div id="tc-tab-content" class="padding-top-2">
                            <!-- Content injected via JS -->
                        </div>
                    </div>
                </div>
            </div>


            <!-- TEACHER ANALYTICS SCREEN -->
            <div id="teacher-analytics-screen" class="screen screen-container">
                <!-- Header -->
                <div class="margin-bottom-2">
                    <h2 class="page-title-large">Class Analytics
                        & Insights</h2>
                    <p class="page-subtitle">Track performance, attendance, and learning
                        progress in real time</p>
                </div>

                <!-- Filter Row (Sticky) -->
                <div class="fixed-filter-bar">
                    <div class="filter-label">Filters:</div>
                    <select class="t-filter-select select-pad" aria-label="Filter by class">
                        <option>Class 10 - A</option>
                        <option>Class 9 - B</option>
                        <option>Class 8 - A</option>
                    </select>
                    <select class="t-filter-select select-pad" aria-label="Filter by subject">
                        <option>Maths</option>
                        <option>Science</option>
                        <option>English</option>
                    </select>
                    <select class="t-filter-select select-pad" aria-label="Filter by time">
                        <option>Last Week</option>
                        <option>Last Month</option>
                        <option>This Term</option>
                    </select>
                </div>

                <!-- 1. Overview Analytics Cards (Top Row) -->
                <div class="analytics-overview-grid">
                    <!-- Total Students -->
                    <div class="dashboard-card section analytics-card-centered">
                        <div class="analytics-label">Total Students
                        </div>
                        <div class="analytics-value analytics-value-white">42</div>
                        <div class="analytics-trend analytics-trend-green">100% Active</div>
                    </div>

                    <!-- Avg Attendance -->
                    <div class="dashboard-card section analytics-card-centered">
                        <div class="analytics-label">Avg Attendance
                        </div>
                        <div class="analytics-value analytics-value-yellow">88%
                        </div>
                        <div class="analytics-trend analytics-trend-muted">Weekly Average</div>
                    </div>

                    <!-- Weekly Test Average -->
                    <div class="dashboard-card section analytics-card-centered">
                        <div class="analytics-label">Weekly Test Avg
                        </div>
                        <div class="analytics-value analytics-value-purple">76%
                        </div>
                        <div class="analytics-trend analytics-trend-green">↑ 2% from last week</div>
                    </div>

                    <!-- Monthly Test Performance -->
                    <div class="dashboard-card section analytics-card-centered">
                        <div class="analytics-label">Monthly
                            Performance</div>
                        <div class="analytics-value analytics-value-green">82%
                        </div>
                        <div class="analytics-trend analytics-trend-white">Top 10% School-wide</div>
                    </div>
                </div>

                <!-- Main Grid -->
                <div class="analytics-main-grid">

                    <!-- Left Column -->
                    <div class="flex-col-gap-2">

                        <!-- 3. Attendance Analytics Section -->
                        <div class="dashboard-card full-width-card">
                            <h3 class="section-header-large">
                                Attendance Analytics</h3>

                            <!-- Mock Visualization -->
                            <div class="flex-gap-2">
                                <!-- Line Chart Mock -->
                                <div class="chart-wrapper">
                                    <div class="chart-label-abs">
                                        Daily Trend</div>
                                    <svg width="100%" height="100%" viewBox="0 0 400 150" class="margin-top-1">
                                        <!-- Grid Lines -->
                                        <line x1="0" y1="30" x2="400" y2="30" stroke="rgba(255,255,255,0.05)" />
                                        <line x1="0" y1="70" x2="400" y2="70" stroke="rgba(255,255,255,0.05)" />
                                        <line x1="0" y1="110" x2="400" y2="110" stroke="rgba(255,255,255,0.05)" />
                                        <!-- Line -->
                                        <path d="M0,100 L50,80 L100,85 L150,40 L200,60 L250,50 L300,30 L350,40 L400,20"
                                            fill="none" stroke="#10b981" stroke-width="3" />
                                    </svg>
                                </div>
                                <!-- Legend -->
                                <div class="legend-col">
                                    <div class="legend-row-sm">
                                        <div class="legend-rect-green">
                                        </div>
                                        <div class="legend-text-sm">Present (92%)</div>
                                    </div>
                                    <div class="legend-row-sm">
                                        <div class="legend-rect-red">
                                        </div>
                                        <div class="legend-text-sm">Absent (8%)</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 4. Test Performance Analytics -->
                        <div class="dashboard-card full-width-card">
                            <div class="section-header-row">
                                <h3 class="widget-title-marginless">Test
                                    Performance</h3>
                                <div class="legend-container">
                                    <span><span class="text-purple">●</span> Class Avg</span>
                                    <span><span class="text-yellow">●</span> Top Performer</span>
                                </div>
                            </div>

                            <!-- Bar Chart Mock -->
                            <div class="chart-container-sm">
                                <div class="bar-wrapper">
                                    <div class="bar-bg height-60-pct">
                                        <div class="bar-fill height-70-pct">
                                        </div>
                                    </div>
                                    <div class="chart-label-mt">
                                        1</div>
                                </div>
                                <div class="bar-wrapper">
                                    <div class="bar-bg height-75-pct">
                                        <div class="bar-fill height-60-pct">
                                        </div>
                                    </div>
                                    <div class="chart-label-mt">
                                        2</div>
                                </div>
                                <div class="bar-wrapper">
                                    <div class="bar-bg height-65-pct">
                                        <div class="bar-fill height-85-pct">
                                        </div>
                                    </div>
                                    <div class="chart-label-mt">
                                        3</div>
                                </div>
                                <div class="bar-wrapper">
                                    <div class="bar-bg height-85-pct">
                                        <div class="bar-fill height-90-pct">
                                        </div>
                                    </div>
                                    <div class="chart-label-mt">
                                        4</div>
                                </div>
                            </div>
                        </div>

                        <!-- 5. Skill Gap Analytics (AI-Assisted) -->
                        <div class="dashboard-card full-width-card">
                            <div class="section-header-compact">
                                <h3 class="widget-title-marginless">AI Skill Gaps
                                    Analysis</h3>
                                <span class="badge-ai">AI
                                    Generated</span>
                            </div>

                            <div class="flex-col-gap-1">
                                <!-- Item 1 -->
                                <div class="alert-card-red">
                                    <div class="flex-between-mb-half">
                                        <div class="text-bold-white">Algebra Basics</div>
                                        <div class="text-red-sm">High Gap (65% Struggling)</div>
                                    </div>
                                    <div class="text-muted-sm">
                                        🤖 <span class="text-lavender-light">AI Insight:</span> Majority
                                        struggling with quadratic factorization.
                                    </div>
                                    <div class="margin-top-08">
                                        <button class="btn-secondary btn-xs">Assign Practice
                                            Drill</button>
                                    </div>
                                </div>
                                <!-- Item 2 -->
                                <div class="alert-card-yellow">
                                    <div class="flex-between-mb-half">
                                        <div class="text-bold-white">Optics & Light</div>
                                        <div class="text-yellow-sm">Medium Gap (35% Struggling)
                                        </div>
                                    </div>
                                    <div class="text-muted-sm">
                                        🤖 <span class="text-lavender-light">AI Insight:</span> Confusion
                                        observed in ray diagram conventions.
                                    </div>
                                    <div class="margin-top-08">
                                        <button class="btn-secondary btn-xs">View Recommended
                                            Videos</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="flex-col-gap-2">

                        <!-- 4. Student Performance Distribution -->
                        <div class="dashboard-card section">
                            <h3 class="section-header-large">Student
                                Distribution</h3>
                            <div class="donut-chart-conic">
                                <div class="donut-hole">
                                    <span class="donut-center-num">42</span>
                                    <span class="donut-center-label">Total</span>
                                </div>
                            </div>
                            <div class="mt-15-col-gap-08">
                                <div class="list-item-hoverable">
                                    <div class="dist-list-item-header">
                                        <div class="dot-green">
                                        </div> Strong
                                    </div>
                                    <div class="text-white">30%</div>
                                </div>
                                <div class="list-item-hoverable">
                                    <div class="dist-list-item-header">
                                        <div class="dot-yellow">
                                        </div> Average
                                    </div>
                                    <div class="text-white">50%</div>
                                </div>
                                <div class="list-item-hoverable">
                                    <div class="dist-list-item-header">
                                        <div class="dot-red">
                                        </div> Weak
                                    </div>
                                    <div class="text-white">20%</div>
                                </div>
                            </div>
                        </div>

                        <!-- 7. Actionable Insights -->
                        <div class="dashboard-card section card-gradient-purple">
                            <h3 class="section-header-mb1">💡 Smart
                                Insights</h3>
                            <ul class="insight-list">
                                <li><strong>Class 10B</strong> shows improvement after weekly tests.</li>
                                <li>Low attendance impacting monthly physics scores.</li>
                                <li>Students improve <strong>18%</strong> after revision drills.</li>
                            </ul>
                        </div>

                        <!-- 8. Export & Reports -->
                        <div class="dashboard-card section">
                            <h3 class="widget-title">Exports
                            </h3>
                            <div class="flex-col-gap-1">
                                <button class="btn-secondary btn-icon-left" onclick="alert('Downloading PDF...')">
                                    📥 Download Report (PDF)
                                </button>
                                <button class="btn-secondary btn-icon-left" onclick="alert('Sending Summary...')">
                                    📤 Send Summary to Parents
                                </button>
                                <button class="btn-secondary btn-icon-left" onclick="alert('Exporting CSV...')">
                                    📊 Export Class Data
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- TEACHER ATTENDANCE SCREEN -->
            <div id="teacher-attendance-screen" class="screen screen-limited-width">

                <!-- 1. Header -->
                <div class="margin-bottom-2">
                    <h2 class="page-title-large">Attendance
                        Management</h2>
                    <p class="page-subtitle">Track, mark, and analyze student attendance</p>
                </div>

                <!-- 2. Attendance Overview Cards (4 Cards) -->
                <div class="teacher-stats-grid">
                    <!-- Total Students -->
                    <div class="dashboard-card section stat-card-padded">
                        <div class="stat-label-mb">Total Students
                        </div>
                        <div class="stat-value-large">42</div>
                        <div class="text-green-sm">Class Strength</div>
                    </div>

                    <!-- Present Today -->
                    <div class="dashboard-card section stat-card-padded">
                        <div class="stat-label-mb">Present Today
                        </div>
                        <div class="text-green-large">38
                        </div>
                        <div class="text-green-sm">90.4%</div>
                    </div>

                    <!-- Absent Today -->
                    <div class="dashboard-card section stat-card-padded">
                        <div class="stat-label-mb">Absent Today
                        </div>
                        <div class="text-red-large">04
                        </div>
                        <div class="text-red-sm">Needs Attention</div>
                    </div>

                    <!-- Attendance % -->
                    <div class="dashboard-card section stat-card-padded">
                        <div class="stat-label-mb">Attendance %
                        </div>
                        <div class="text-purple-large">92%
                        </div>
                        <div class="text-lavender-light">Weekly Avg</div>
                    </div>
                </div>

                <!-- 3. Class & Subject Filter Row -->
                <div class="dashboard-card full-width-card filter-bar-card">
                    <div class="filter-label-white">Filter By:</div>
                    <select class="t-filter-select select-pad" aria-label="Filter by class">
                        <option>Class 10</option>
                        <option>Class 9</option>
                    </select>
                    <select class="t-filter-select select-pad" aria-label="Filter by section">
                        <option>Section A</option>
                        <option>Section B</option>
                    </select>
                    <select class="t-filter-select select-pad" aria-label="Filter by subject">
                        <option>Physics</option>
                        <option>Maths</option>
                    </select>
                    <input type="date" class="t-filter-select date-picker-styled" aria-label="Select date">
                    <button class="btn-primary btn-right-refresh" onclick="alert('Refreshed!')">Refresh</button>
                </div>

                <!-- Add Student Form (New) -->
                <div class="add-student-box">
                    <input type="text" id="rollNoInput" placeholder="Roll No">
                    <input type="text" id="studentNameInput" placeholder="Student Name">
                    <button onclick="app.addStudent()">+ Add Student</button>
                </div>

                <!-- 4. Attendance Table (Full Width) -->
                <div class="dashboard-card full-width-card margin-bottom-2">
                    <div class="section-header-compact">
                        <h3 class="section-header-compact-white">Mark Attendance</h3>
                        <div class="selection-info">Current Selection: <span class="text-white">Class 10 - A
                                (Physics)</span></div>
                    </div>

                    <div class="table-overflow">
                        <table class="table-styled">
                            <thead>
                                <tr class="th-row">
                                    <th class="th-cell">Roll No</th>
                                    <th class="th-cell">Student Name</th>
                                    <th class="th-cell-center">Status</th>
                                    <th class="th-cell-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                                <!-- Dynamic Rows will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 5. Action Buttons (Bottom Row) -->
                <div class="action-row-right">
                    <button class="btn-primary btn-wide" onclick="app.saveAttendance()">Save
                        Attendance</button>
                </div>
            </div>

            <!-- Attendance Report Modal (New) -->
            <div id="attendanceModal" class="modal-overlay">
                <div class="modal-card">
                    <header class="modal-header">
                        <h2 id="reportStudentName">Student Name</h2>
                        <p>Attendance Report</p>
                    </header>

                    <div class="stat-row">
                        <span class="stat-label">Total Days:</span>
                        <span id="totalDays" class="stat-val">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Present:</span>
                        <span id="presentDays" class="stat-val text-green">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Absent:</span>
                        <span id="absentDays" class="stat-val text-red">0</span>
                    </div>

                    <div class="progress-bar">
                        <div id="attendanceProgress" class="progress-fill"></div>
                    </div>

                    <h3 id="attendancePercent" class="percent-display">0%</h3>

                    <button class="modal-btn-close" onclick="app.closeAttendanceModal()">Close Report</button>
                </div>
            </div>

            <!-- HELP CENTRE SCREEN (Rebuilt) -->
            <div id="help-centre" class="screen help-container">

                <!-- Header -->
                <div class="text-center-mb-25">
                    <h2 class="page-title-dark">
                        Help & Support</h2>
                    <p class="page-subtitle-dark">Get instant help, guides, and AI assistance</p>
                </div>

                <!-- 1. Smart Search -->
                <div class="search-wrapper-centered">
                    <input type="text" id="help-search-input"
                        placeholder="Search issues, features, or ask a question..." oninput="app.handleHelpSearch(this)"
                        class="search-input-glass">
                    <div class="search-icon-abs">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </div>
                </div>

                <!-- 2. Quick Action Cards (2x2 Grid) -->
                <div class="grid-2-gap-15">

                    <!-- Card 1: Getting Started -->
                    <div class="help-action-card" onclick="app.toggleHelpTopic('getting-started', this)">
                        <div class="help-icon-box icon-box-blue">🚀</div>
                        <div>
                            <h3 class="help-card-title">Getting Started</h3>
                            <p class="help-card-desc">Setup, dashboard, first assessment</p>
                        </div>
                    </div>

                    <!-- Card 2: Assessments -->
                    <div class="help-action-card" onclick="app.toggleHelpTopic('assessments', this)">
                        <div class="help-icon-box icon-box-green">📊</div>
                        <div>
                            <h3 class="help-card-title">Assessments & Scores</h3>
                            <p class="help-card-desc">Attempts, scores, AI explanations</p>
                        </div>
                    </div>

                    <!-- Card 3: Modulator -->
                    <div class="help-action-card" onclick="app.toggleHelpTopic('modulator', this)">
                        <div class="help-icon-box icon-box-purple">✨</div>
                        <div>
                            <h3 class="help-card-title">Modulator Help</h3>
                            <p class="help-card-desc">Uploads, AI actions, limits</p>
                        </div>
                    </div>

                    <!-- Card 4: Account -->
                    <div class="help-action-card" onclick="app.toggleHelpTopic('account', this)">
                        <div class="help-icon-box icon-box-yellow">👤</div>
                        <div>
                            <h3 class="help-card-title">Account & Profile</h3>
                            <p class="help-card-desc">Login, profile, privacy</p>
                        </div>
                    </div>

                </div>

                <!-- Dynamic Expandable Panel (Initially Hidden) -->
                <div id="help-topic-panel" class="hidden help-panel-expanded">
                    <div class="chart-header margin-bottom-1">
                        <h3 id="help-panel-title" class="panel-title">Topic Title</h3>
                        <button onclick="document.getElementById('help-topic-panel').classList.add('hidden')"
                            class="btn-close-simple">✕</button>
                    </div>
                    <div id="help-panel-content" class="panel-content">
                        <!-- Content -->
                    </div>
                </div>

                <!-- 3. AI Helper & Support Row -->
                <div class="grid-2-1">

                    <!-- AI Assistant -->
                    <div class="card-glass-padded">
                        <div class="margin-bottom-1">
                            <h3 class="ai-card-title">
                                <span class="emoji-lg">🤖</span> Ask AI for Help
                            </h3>
                        </div>

                        <!-- AI Response Area -->
                        <div id="help-ai-response" class="hidden ai-response-box">
                        </div>

                        <div class="margin-top-auto">
                            <div class="input-wrapper-relative">
                                <input type="text" id="help-ai-input"
                                    placeholder="Ask AI about any feature or problem..." class="chat-input-dark">
                            </div>
                            <div class="flex-gap-08">
                                <button class="btn-primary btn-chat" onclick="app.askHelpAI()">Ask AI</button>
                                <button class="btn-secondary btn-chat" onclick="alert('Feature coming soon')">Report
                                    Issue</button>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Support -->
                    <div class="support-card">
                        <h3 class="support-card-title">Still need
                            help?</h3>
                        <p class="support-card-desc">Our support team
                            is ready to assist you.</p>

                        <button class="btn-secondary btn-full-width-mb">📩 Email
                            Support</button>
                        <button class="btn-secondary btn-report-bug">🐞
                            Report a Bug</button>

                        <div class="text-sm-muted">
                            Usually replies within <span class="text-lavender-light">24 hours</span>
                        </div>
                    </div>
                </div>

            </div> <!-- End of Help Centre Screen -->

            <!-- PROFILE SCREEN (Full Page) -->
            <div id="profile-screen-legacy" class="screen">
                <div class="profile-container">

                    <!-- 1. Header -->
                    <div class="profile-header-card">
                        <div class="profile-avatar-glow">ABI</div>
                        <div class="flex-1">
                            <h1 class="profile-title-large">Abi</h1>
                            <div class="profile-subtitle">Class 10 |
                                Term 1</div>
                            <span class="badge-consistent">
                                🔥 Consistent Learner
                            </span>
                        </div>
                        <button class="btn-secondary width-auto" onclick="app.navTo('home')">Back to
                            Dashboard</button>
                    </div>

                    <!-- 2. Heatmap -->
                    <div class="heatmap-container">
                        <div class="flex-between-center">
                            <h3 class="heatmap-title-text">Learning Activity</h3>
                            <div class="text-sm-muted">Last 30 Days</div>
                        </div>
                        <div class="heatmap-grid" id="profile-heatmap-grid">
                            <!-- Injected by JS -->
                        </div>
                        <div class="heatmap-legend-row">
                            <span>Less</span>
                            <div class="heatmap-legend-box">
                            </div>
                            <div class="hm-cell hm-level-2"></div>
                            <div class="hm-cell hm-level-3"></div>
                            <div class="hm-cell hm-level-4"></div>
                            <span>More</span>
                        </div>
                    </div>

                    <!-- 3. Performance Cards -->
                    <div class="perf-grid">
                        <div class="perf-card">
                            <div class="real-flame-container-sm">
                                <div class="real-flame"></div>
                            </div>
                            <div class="val-large">12 Days</div>
                            <div class="text-muted-sm">Current Streak</div>
                        </div>
                        <div class="perf-card">
                            <div class="emoji-icon-lg">📝</div>
                            <div class="val-large">42</div>
                            <div class="text-muted-sm">Assessments Done</div>
                        </div>
                        <div class="perf-card">
                            <div class="emoji-icon-lg">🎯</div>
                            <div class="val-large">88%</div>
                            <div class="text-muted-sm">Average Score</div>
                        </div>
                        <div class="perf-card">
                            <div class="emoji-icon-lg">🧪</div>
                            <div class="val-large">Science</div>
                            <div class="text-muted-sm">Best Subject</div>
                        </div>
                    </div>

                    <div class="grid-2-gap-2">
                        <!-- 4. Subject Progress -->
                        <div class="heatmap-container subject-prog-container">
                            <h3 class="section-heading">Subject Progress</h3>

                            <div class="subject-prog-bar-container"
                                onclick="alert('Details: Mathematics - 85% Complete')">
                                <div class="subject-prog-header"><span>Mathematics</span><span>85%</span></div>
                                <div class="subject-prog-track">
                                    <div class="subject-prog-fill bg-red width-85-pct"></div>
                                </div>
                            </div>
                            <div class="subject-prog-bar-container" onclick="alert('Details: Science - 92% Complete')">
                                <div class="subject-prog-header"><span>Science</span><span>92%</span></div>
                                <div class="subject-prog-track">
                                    <div class="subject-prog-fill bg-blue width-92-pct"></div>
                                </div>
                            </div>
                            <div class="subject-prog-bar-container" onclick="alert('Details: English - 70% Complete')">
                                <div class="subject-prog-header"><span>English</span><span>70%</span></div>
                                <div class="subject-prog-track">
                                    <div class="subject-prog-fill bg-yellow width-70-pct"></div>
                                </div>
                            </div>
                            <div class="subject-prog-bar-container">
                                <div class="subject-prog-header"><span>Social Studies</span><span>60%</span></div>
                                <div class="subject-prog-track">
                                    <div class="subject-prog-fill bg-green width-60-pct"></div>
                                </div>
                            </div>
                            <div class="subject-prog-bar-container">
                                <div class="subject-prog-header"><span>Tamil</span><span>50%</span></div>
                                <div class="subject-prog-track">
                                    <div class="subject-prog-fill bg-purple width-50-pct"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 5. Achievements -->
                        <div class="heatmap-container subject-prog-container">
                            <h3 class="section-heading">Achievements</h3>
                            <div class="badge-grid">
                                <div class="badge-item unlocked" title="First Steps">🚀</div>
                                <div class="badge-item unlocked" title="Quiz Master">🧠</div>
                                <div class="badge-item unlocked" title="7 Day Streak">🔥</div>
                                <div class="badge-item" title="Subject Expert">📚</div>
                                <div class="badge-item" title="Night Owl">🦉</div>
                                <div class="badge-item" title="Perfect Score">💯</div>
                                <div class="badge-item" title="Social Butterfly">🤝</div>
                                <div class="badge-item unlocked" title="Fast Learner">⚡</div>
                                <div class="badge-item" title="Bookworm">📖</div>
                            </div>
                            <button class="btn-secondary btn-full-width margin-top-2"
                                onclick="app.navTo('achievements')">View All Achievements</button>
                        </div>
                    </div>

                    <!-- 6. Bottom Actions -->
                    <div class="action-buttons-row">
                        <button class="btn-secondary" onclick="alert('Edit Profile')">Edit Profile</button>
                        <button class="btn-secondary" onclick="alert('Detailed Analytics')">Detailed Analytics</button>
                        <button class="btn-primary" onclick="alert('Downloading Report...')">Download Progress
                            Report</button>
                    </div>

                </div>
            </div>





            <!-- ASSESSMENT WORKSPACE -->
            <div id="assessment-container" class="screen">
                <!-- 1. Intro Screen -->
                <div id="assess-intro" class="screen active">
                    <div class="intro-card">
                        <h2 class="intro-title">Pythagoras Theorem</h2>
                        <p class="intro-subtitle">Mathematics · 30 Minutes</p>

                        <div class="intro-meta">
                            <span class="meta-badge">Adaptive Difficulty</span>

                        </div>

                        <div class="intro-note">
                            “This assessment adjusts based on your answers.”
                        </div>

                        <div class="action-buttons action-buttons-col">
                            <button class="btn-primary" onclick="app.startQuiz()">Begin Assessment</button>
                            <button class="btn-secondary" onclick="app.closeAssessment()">Back to
                                Dashboard</button>
                        </div>
                    </div>
                </div>

                <!-- 2. Quiz Screen -->
                <div id="assess-quiz" class="screen">
                    <header class="assessment-header">
                        <div class="progress-track">
                            <div class="progress-fill width-10-pct" id="quiz-progress"></div>
                        </div>
                        <div class="q-counter width-60px">Q <span id="q-current">1</span>/<span id="q-total">4</span>
                        </div>
                        <div class="timer-display" id="timer-display">
                            <span id="timer-text">30:00</span>
                        </div>
                    </header>

                    <div class="question-card-container">
                        <div class="question-box">
                            <h3 class="q-text" id="q-text">Loading Question...</h3>
                            <div class="options-grid" id="q-options"></div>
                            <div class="hint-section">
                                <button class="hint-btn" onclick="app.useHint()">
                                    <span>Need a Hint?</span>
                                </button>
                                <div id="hint-display-area"></div>
                            </div>
                        </div>
                        <div id="q-feedback" class="feedback-area hidden">
                            <div class="feedback-msg" id="feedback-text"></div>
                        </div>
                    </div>
                </div>

                <!-- 3. Result Screen -->
                <div id="assess-result" class="screen">
                    <div class="result-stats">
                        <div class="stat-box">
                            <div class="stat-label">Final Score</div>
                            <div id="result-score" class="stat-value">0%</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Accuracy</div>
                            <div id="result-accuracy" class="stat-value">0/0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Time Taken</div>
                            <div id="result-time" class="stat-value">0:00</div>
                        </div>
                    </div>

                    <div class="text-left-margin-v">
                        <div class="margin-bottom-1">
                            <div class="text-label-sm margin-bottom-05">
                                Strength Topics</div>
                            <div class="chips-container" id="strength-topics">
                            </div>
                        </div>
                        <div>
                            <div class="text-label-sm margin-bottom-05">
                                Weak
                                Topics</div>
                            <div class="chips-container" id="weak-topics"></div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn-primary" onclick="app.showExplanation()">View AI Explanation</button>
                        <button class="btn-secondary" onclick="app.retryWeakAreas()">Retry Weak Areas</button>
                        <button class="btn-secondary" onclick="app.goToAchievements()">Go to
                            Achievements</button>
                    </div>
                </div>

                <!-- 4. AI Explanation Screen -->
                <div id="assess-explanation" class="screen">
                    <header class="assessment-header">
                        <button class="back-btn" onclick="app.backToResults()">Back to Results</button>
                        <div class="explanation-mode-selector">
                            <button class="mode-btn active"
                                onclick="app.switchExplanationMode('normal')">Normal</button>
                            <button class="mode-btn"
                                onclick="app.switchExplanationMode('example')">Example-based</button>
                            <button class="mode-btn" onclick="app.switchExplanationMode('story')">Story-based</button>
                        </div>
                    </header>
                    <div class="explanation-content padding-2" id="explanation-content"></div>
                </div>
            </div>
            <!-- ASSESSMENT WORKSPACE (Merged into dashboard workspace) -->

            <!-- PROFILE SCREEN (Level 2) -->
            <div id="profile-screen" class="screen">
                <!-- 1. HEADER SECTION -->
                <div class="profile-header-new">
                    <!-- Left: Avatar & Info -->
                    <div class="profile-avatar-section">
                        <div class="pos-relative">
                            <div class="profile-dd-avatar-lg profile-img-container">
                                <img src="" class="profile-pic-img-lg profile-img-overlay d-none" alt="Profile">
                                👤
                            </div>
                            <div class="avatar-badge-container">
                                <div class="profile-fire-anim">🔥</div>
                            </div>
                        </div>
                        <div>
                            <h1 class="profile-name-lg" id="profileFullName">Student</h1>
                            <div class="profile-meta-text" id="profileClass">Class 10 | Term 1</div>
                            <div class="profile-status-badge">Consistent Learner</div>
                            <div class="profile-joined-text">Joined: Dec
                                2024</div>
                        </div>
                    </div>

                    <!-- Right: Quick Stats -->
                    <div class="profile-stats-grid">
                        <div class="p-stat-card">
                            <div class="p-stat-val">42</div>
                            <div class="p-stat-label">Assessments</div>
                        </div>
                        <div class="p-stat-card">
                            <div class="p-stat-val">12</div>
                            <div class="p-stat-label">Best Streak</div>
                        </div>
                        <div class="p-stat-card">
                            <div class="p-stat-val">#4</div>
                            <div class="p-stat-label">Class Rank</div>
                        </div>
                        <div class="p-stat-card">
                            <div class="p-stat-val">78%</div>
                            <div class="p-stat-label">Completion</div>
                        </div>
                    </div>
                </div>

                <!-- 2. PROGRESS OVERVIEW -->
                <div class="progress-overview-section">
                    <div class="prog-card">
                        <div class="val-xl">5.2h</div>
                        <div class="label-sub">Weekly Learning Time</div>
                    </div>
                    <div class="prog-card">
                        <div class="val-xl-green">88%</div>
                        <div class="text-sm-muted">Avg. Accuracy</div>
                        <div class="label-trend-green">▲ 2% vs last week</div>
                    </div>
                    <div class="prog-card card-border-left-yellow">
                        <div class="label-upper-yellow">
                            Strongest</div>
                        <div class="val-md-white">Mathematics</div>
                    </div>
                    <div class="prog-card card-border-left-purple">
                        <div class="label-upper-purple">
                            Assessment</div>
                        <div class="text-white-sm">12 Completed</div>
                        <div class="prog-mini-track">
                            <div class="prog-mini-fill"></div>
                        </div>
                    </div>
                </div>

                <!-- 3. LEARNING HEATMAP -->
                <div class="heatmap-section">
                    <div class="ai-insight-badge" id="hm-ai-badge">AI Insight: Consistent!</div>
                    <div class="heatmap-header-row">
                        <div class="flex-col">
                            <h3 class="heatmap-title">Learning Heatmap</h3>
                            <span class="heatmap-sub">Your daily learning
                                activity</span>
                        </div>
                        <select class="heatmap-filter-select" id="hm-filter"
                            onchange="populateProfileHeatmap(this.value)" aria-label="Heatmap Filter">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>

                    <div id="profile-heatmap" class="heatmap-grid-calendar">
                        <!-- Injected via JS -->
                    </div>

                    <!-- Legend -->
                    <div class="heatmap-legend">
                        <span>Less</span>
                        <div class="hm-cell hm-level-0 hm-cell-sm"></div>
                        <div class="hm-cell hm-level-1 hm-cell-sm"></div>
                        <div class="hm-cell hm-level-2 hm-cell-sm"></div>
                        <div class="hm-cell hm-level-3 hm-cell-sm"></div>
                        <div class="hm-cell hm-level-4 hm-cell-sm"></div>
                        <span>More</span>
                    </div>

                    <!-- Insight Strip -->
                    <div class="insight-strip-card">
                        <div class="emoji-icon-mid">🧠</div>
                        <div>
                            <div class="text-white-bold">AI Analysis</div>
                            <div class="insight-text" id="hm-insight-text">You learn best on weekends! Your
                                streak improves after Whiteboard practice.</div>
                        </div>
                    </div>
                </div>

                <!-- 4. SUBJECT PERFORMANCE -->
                <h3 class="section-title-sm">Subject Performance</h3>
                <div class="subject-perf-grid">
                    <div class="sub-perf-card strong">
                        <div class="sub-name">Mathematics</div>
                        <div class="sub-acc">92%</div>
                        <div class="sub-label label-bg-green">Strong
                        </div>
                    </div>
                    <div class="sub-perf-card improving">
                        <div class="sub-name">Science</div>
                        <div class="sub-acc">78%</div>
                        <div class="sub-label label-bg-yellow">Improving
                        </div>
                    </div>
                    <div class="sub-perf-card strong">
                        <div class="sub-name">English</div>
                        <div class="sub-acc">85%</div>
                        <div class="sub-label label-bg-green">Strong
                        </div>
                    </div>
                    <div class="sub-perf-card focus">
                        <div class="sub-name">Social Studies</div>
                        <div class="sub-acc">65%</div>
                        <div class="sub-label label-bg-red">Needs Focus
                        </div>
                    </div>
                    <div class="sub-perf-card improving">
                        <div class="sub-name">Tamil</div>
                        <div class="sub-acc">72%</div>
                        <div class="sub-label label-bg-yellow">Improving
                        </div>
                    </div>
                </div>

                <!-- 5. ACHIEVEMENTS -->
                <div class="achievements-banner" onclick="app.navTo('achievements')">
                    <div class="achievements-content">
                        <div class="emoji-icon-lg">🏆</div>
                        <div>
                            <div class="achievements-text">Achievements & Badges</div>
                            <div class="achievements-desc">View your collection and earned
                                certificates</div>
                        </div>
                    </div>
                    <div class="view-all-link">View All -></div>
                </div>

                <!-- 6. ACTIONS -->
                <div class="profile-actions-bar">
                    <button class="p-action-btn" onclick="app.openEditProfile()">
                        <span>✏️</span> Edit Profile
                    </button>
                    <button class="p-action-btn">
                        <span>📥</span> Download Report
                    </button>
                    <button class="p-action-btn">
                        <span>⚙️</span> Account Settings
                    </button>
                    <button class="p-action-btn btn-danger-soft" onclick="app.logout()">
                        <span>🚪</span> Logout
                    </button>
                </div>
            </div>

            <!-- HEATMAP DETAIL MODAL -->
            <div id="hm-detail-modal" class="full-leaderboard-modal"
                onclick="if(event.target === this) this.style.display='none'">
                <div class="modal-body modal-body-sm">
                    <header class="modal-header">
                        <h3 class="modal-h3-marginless" id="hm-modal-date">Date</h3>
                        <button onclick="document.getElementById('hm-detail-modal').style.display='none'"
                            class="btn-close-transparent">✕</button>
                    </header>
                    <div class="padding-1-5-rem">
                        <div class="flex-between-mb-1">
                            <span class="text-muted-color">Time Spent</span>
                            <span class="text-white-bold" id="hm-modal-time">0m</span>
                        </div>
                        <div class="flex-between-mb-1">
                            <span class="text-muted-color">Assessments</span>
                            <span class="text-white-bold" id="hm-modal-assess">0</span>
                        </div>
                        <div class="flex-between-mb-1-5">
                            <span class="text-muted-color">Streak</span>
                            <span class="text-green-bold" id="hm-modal-streak">Active 🔥</span>
                        </div>
                        <button class="btn-primary btn-full-width"
                            onclick="document.getElementById('hm-detail-modal').style.display='none'">Practice
                            Again</button>
                    </div>
                </div>
            </div>

            <!-- EDIT PROFILE MODAL -->
            <div id="edit-profile-modal" class="edit-profile-modal"
                onclick="if(event.target === this) app.closeEditProfile()">
                <div class="edit-profile-content">
                    <header class="edit-profile-header">
                        <h3 class="edit-profile-title">Edit Profile</h3>
                        <button class="btn-close-modal" onclick="app.closeEditProfile()">✕</button>
                    </header>

                    <div class="profile-edit-form">
                        <!-- Profile Pic -->
                        <!-- Avatar Selection -->
                        <!-- Avatar Selection -->
                        <!-- Avatar Selection -->
                        <div class="avatar-section">
                            <h4>Choose Your Avatar</h4>

                            <div class="avatar-grid">
                                <div class="avatar-item" onclick="selectAvatar('programmer')">
                                    <img src="public/assets/avatars/careers/programmer.png" alt="Programmer">
                                    <span>Programmer</span>
                                </div>

                                <div class="avatar-item" onclick="selectAvatar('doctor')">
                                    <img src="public/assets/avatars/careers/doctor.png" alt="Doctor">
                                    <span>Doctor</span>
                                </div>

                                <div class="avatar-item" onclick="selectAvatar('gamer')">
                                    <img src="public/assets/avatars/careers/gamer.png" alt="Gamer">
                                    <span>Gamer</span>
                                </div>

                                <div class="avatar-item" onclick="selectAvatar('engineer')">
                                    <img src="public/assets/avatars/careers/engineer.png" alt="Engineer">
                                    <span>Engineer</span>
                                </div>

                                <div class="avatar-item" onclick="selectAvatar('teacher')">
                                    <img src="public/assets/avatars/careers/teacher.png" alt="Teacher">
                                    <span>Teacher</span>
                                </div>
                            </div>
                        </div>

                        <!-- Name -->
                        <div class="edit-field-group">
                            <label class="edit-label">Full Name</label>
                            <input type="text" id="editFullName" class="edit-input" placeholder="Your Name">
                        </div>

                        <!-- Class (Read Only) -->
                        <div class="edit-field-group">
                            <label class="edit-label">Class / Grade</label>
                            <input type="text" id="editClass" class="edit-input" placeholder="Class 10 - A" disabled>
                        </div>

                        <!-- Bio -->
                        <div class="edit-field-group">
                            <label class="edit-label">Bio</label>
                            <textarea id="editBio" class="edit-input"
                                placeholder="Short description about you..."></textarea>
                        </div>

                        <!-- Actions -->
                        <div class="modal-actions">
                            <button class="btn-cancel" onclick="app.closeEditProfile()">Cancel</button>
                            <button class="btn-primary" onclick="app.saveProfileChanges()">Save Changes</button>
                        </div>
                    </div>

                    <div id="save-success-msg" class="save-success-msg">Profile updated successfully</div>
                </div>
            </div>

            <!-- FULL LEADERBOARD MODAL -->
            <div id="leaderboard-modal" class="full-leaderboard-modal"
                onclick="if(event.target === this) this.style.display='none'">
                <div class="modal-body">
                    <header class="modal-header">
                        <h3 class="modal-h3-marginless">Full Class Ranking</h3>
                        <button class="back-btn" class="btn-close-transparent-pad"
                            onclick="document.getElementById('leaderboard-modal').style.display='none'">
                            ✕
                        </button>
                    </header>
                    <div class="leaderboard-filters">
                        <button class="filter-btn active" onclick="app.filterLeaderboard('week', this)">This
                            Week</button>
                        <button class="filter-btn" onclick="app.filterLeaderboard('month', this)">This
                            Month</button>
                        <button class="filter-btn" onclick="app.filterLeaderboard('overall', this)">Overall</button>
                    </div>
                    <div class="scrollable-list" id="modal-list">
                        <!-- Rows will be injected by JS -->
                    </div>
                </div>
            </div>


            <!-- PARENT DASHBOARD SCREEN -->
            <div id="parent-dashboard-screen" class="screen">
                <header class="header-margin-bottom">
                    <h1 class="text-heading-lg">Parent Dashboard</h1>
                    <p class="text-body">Monitor and support your child’s learning journey</p>
                </header>

                <div class="parent-grid">
                    <!-- 1. Teacher Reports -->
                    <div class="parent-card min-h-300">
                        <div class="parent-card-header">
                            <h3 class="parent-card-title">📄 Teacher Reports</h3>
                        </div>
                        <div class="report-list" id="parent-reports-list">
                            <!-- Injected via JS -->
                            <div class="text-muted-center">Loading reports...</div>
                        </div>
                    </div>

                    <!-- 2. Leave Message -->
                    <div class="parent-card">
                        <div class="parent-card-header">
                            <h3 class="parent-card-title">✉️ Send Leave Reason</h3>
                        </div>
                        <div class="leave-form">
                            <textarea id="leave-reason-input" class="leave-textarea"
                                placeholder="Enter reason for leave (e.g., Sick leave, Family event)..." maxlength="250"
                                oninput="app.updateCharCount(this)"></textarea>
                            <div class="char-limit"><span id="char-count">0</span>/250</div>
                            <button class="btn-primary btn-full-width" onclick="app.sendLeaveReason()">Send to Class
                                Teacher</button>
                        </div>
                    </div>

                    <!-- 3. Attendance Calendar -->
                    <div class="parent-card">
                        <div class="parent-card-header">
                            <h3 class="parent-card-title">📅 Monthly Attendance (Oct)</h3>
                        </div>
                        <div class="calendar-grid">
                            <div class="cal-day-header">Mon</div>
                            <div class="cal-day-header">Tue</div>
                            <div class="cal-day-header">Wed</div>
                            <div class="cal-day-header">Thu</div>
                            <div class="cal-day-header">Fri</div>
                            <div class="cal-day-header">Sat</div>
                            <div class="cal-day-header">Sun</div>
                            <!-- Static Calendar for Prototype -->
                            <div class="cal-day"></div>
                            <div class="cal-day">1</div>
                            <div class="cal-day">2</div>
                            <div class="cal-day">3</div>
                            <div class="cal-day">4</div>
                            <div class="cal-day weekend">5</div>
                            <div class="cal-day weekend">6</div>

                            <div class="cal-day">7</div>
                            <div class="cal-day leave" title="Sick Leave">8</div>
                            <div class="cal-day">9</div>
                            <div class="cal-day">10</div>
                            <div class="cal-day">11</div>
                            <div class="cal-day weekend">12</div>
                            <div class="cal-day weekend">13</div>

                            <div class="cal-day">14</div>
                            <div class="cal-day leave" title="Family Event">15</div>
                            <div class="cal-day leave" title="Family Event">16</div>
                            <div class="cal-day">17</div>
                            <div class="cal-day today">18</div>
                            <div class="cal-day weekend">19</div>
                            <div class="cal-day weekend">20</div>

                            <div class="cal-day">21</div>
                            <div class="cal-day">22</div>
                            <div class="cal-day">23</div>
                            <div class="cal-day">24</div>
                            <div class="cal-day">25</div>
                            <div class="cal-day weekend">26</div>
                            <div class="cal-day weekend">27</div>

                            <div class="cal-day">28</div>
                            <div class="cal-day">29</div>
                            <div class="cal-day">30</div>
                            <div class="cal-day">31</div>
                            <div class="cal-day"></div>
                            <div class="cal-day"></div>
                            <div class="cal-day"></div>
                        </div>
                        <div class="cal-summary">
                            <span>Total Leave Days: <strong class="text-white">3</strong></span>
                            <span><span class="leave-badge-dot"></span> Leave</span>
                        </div>
                    </div>

                    <!-- 4. Missed Topics -->
                    <div class="parent-card">
                        <div class="parent-card-header">
                            <h3 class="parent-card-title">📚 Topics Covered During Leave</h3>
                        </div>
                        <div class="accordion-list" id="parent-missed-topics">
                            <!-- Injected via JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODULATOR SCREEN (REBUILT - IMAGE MATCHED) -->
            <div id="modulator-screen" class="screen">
                <header class="modulator-header header-margin-bottom">
                    <div class="flex-center-gap-1">
                        <button class="nav-btn-icon" onclick="app.navTo('home')" title="Back">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="19" y1="12" x2="5" y2="12"></line>
                                <polyline points="12 19 5 12 12 5"></polyline>
                            </svg>
                        </button>
                        <div>
                            <h2 class="widget-title-marginless">
                                MODULATOR</h2>
                            <p class="text-body-marginless">Turn any content into
                                simple learning</p>
                        </div>
                    </div>
                </header>

                <div class="modulator-layout">

                    <!-- LEFT PANEL: UPLOAD -->
                    <div class="upload-panel" id="drop-zone-area">

                        <input type="file" id="mod-file-upload" hidden onchange="app.handleFileUpload(this)">

                        <div id="upload-content-state">
                            <div class="icon-xl-lavender">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                            </div>
                            <h3 class="text-heading-md">Upload
                                your file</h3>
                            <p class="text-body-sm-mb1">Drag & drop or <span class="link-primary"
                                    onclick="document.getElementById('mod-file-upload').click()">click to browse</span>
                            </p>
                            <p class="text-desc-xs">Supports: PDF, Text, Images</p>
                        </div>

                        <!-- File Loaded State (Hidden by default) -->
                        <div id="file-loaded-state" class="hidden width-100">
                            <div class="file-loaded-wrapper">
                                <div class="file-icon-box">
                                    📄</div>
                                <div class="file-info-col">
                                    <div id="uploaded-filename" class="file-name-trunc">
                                        filename.pdf</div>
                                    <div class="text-ready">Ready to process</div>
                                </div>
                                <button onclick="app.resetModulator()" class="btn-close-red">✕</button>
                            </div>
                            <p class="text-ai-ready">AI is ready to analyze this
                                content.</p>
                        </div>
                    </div>

                    <!-- RIGHT PANEL: INTERACTION -->
                    <div class="interaction-panel">

                        <!-- Top Action Pills -->
                        <div class="ai-actions ai-actions-row">
                            <button class="mod-pill-btn disabled" onclick="app.handleModulatorAction('simplify')"
                                disabled>
                                ⚡ Simplify More
                            </button>
                            <button class="mod-pill-btn disabled" onclick="app.handleModulatorAction('example')"
                                disabled>
                                💡 Give Example
                            </button>
                            <button class="mod-pill-btn disabled" onclick="app.handleModulatorAction('eli5')" disabled>
                                👤 Explain Like I'm 10
                            </button>
                            <button class="mod-pill-btn disabled" onclick="app.handleModulatorAction('quiz')" disabled>
                                📝 Create Quiz
                            </button>
                        </div>

                        <!-- Response Area -->
                        <div id="mod-response-area" class="mod-response-area">
                            <!-- Placeholder -->
                            <div id="mod-placeholder" class="mod-placeholder">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="1.5" class="svg-placeholder-mb">
                                    <path
                                        d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                                    </path>
                                </svg>
                                <p>AI explanation will appear here</p>
                            </div>
                            <!-- Actual Content -->
                            <div id="mod-ai-content" class="hidden content-full-dimensions">
                                <!-- Dynamic Text -->
                            </div>
                        </div>

                        <!-- Bottom Input Bar -->
                        <div class="chat-input-bar">
                            <input type="text" id="mod-chat-input" placeholder="Type text or ask..."
                                class="mod-chat-input" onkeydown="if(event.key === 'Enter') app.handleModulatorChat()">
                            <button id="mod-send-btn" onclick="app.handleModulatorChat()" class="mod-send-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </div>
                    </div>

                </div>
            </div> <!-- End of modulator-screen -->

            <!-- WHITEBOARD SCREEN -->
            <div id="whiteboard-screen" class="screen">
                <header class="wb-header-margin">
                    <h1 class="wb-title-large">Whiteboard</h1>
                    <p class="wb-subtitle">Practice, test, and improve instantly</p>
                </header>

                <!-- Subject Selection Grid -->
                <div id="wb-subjects-grid" class="wb-grid">
                    <!-- Cards injected via JS -->
                </div>

                <!-- Lesson Selection View (Hidden by default) -->
                <div id="wb-lessons-view" class="d-none">
                    <div class="wb-lessons-view">
                        <button class="btn-secondary btn-back-wb" onclick="app.backToWhiteboardSubjects()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 12H5" />
                                <path d="M12 19l-7-7 7-7" />
                            </svg>
                            Back
                        </button>
                        <h2 id="wb-lessons-title" class="wb-lessons-heading">Lessons</h2>
                    </div>
                    <div id="wb-lessons-list" class="wb-list">
                        <!-- Lessons injected via JS -->
                    </div>
                </div>

                <!-- MCQ Test View (Hidden by default) -->
                <div id="wb-mcq-view" class="d-none">
                    <!-- Injected by JS -->
                </div>
            </div>

            <!-- ACHIEVEMENTS SCREEN -->
            <div id="achievements-screen" class="screen achievements-wrapper">
                <!-- Header -->
                <div class="achievements-header">
                    <h2 class="achievements-title">
                        Achievements</h2>
                    <p class="achievements-subtitle">Your learning milestones and rewards</p>
                </div>

                <!-- Stats Row -->
                <div class="achieve-stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">🏆</div>
                        <div class="stat-number">5</div>
                        <div class="stat-label">Total Badges</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📊</div>
                        <div class="stat-number">#4</div>
                        <div class="stat-label">Current Rank</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🔥</div>
                        <div class="stat-number">12</div>
                        <div class="stat-label">Best Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📝</div>
                        <div class="stat-number">8</div>
                        <div class="stat-label">Assessments</div>
                    </div>
                </div>

                <!-- Rank & Progress -->
                <div class="rank-progress-card">
                    <div class="rank-header-row">
                        <span class="rank-current">Current Rank: #4</span>
                        <span class="rank-next">Next Rank: Top 3</span>
                    </div>
                    <div class="rank-progress-track">
                        <div class="rank-progress-fill width-75-pct"></div>
                    </div>
                    <p class="rank-prompt">
                        Complete 2 more assessments to improve your rank!
                    </p>
                </div>

                <!-- Badges Section -->
                <h3 class="badges-title">Your Badges</h3>
                <div class="badges-grid">
                    <!-- Owned Badges -->
                    <div class="badge-card owned">
                        <div class="badge-shine"></div>
                        <div class="badge-icon">🌟</div>
                        <div class="badge-name">First Steps</div>
                        <div class="badge-desc">Completed 1st Assessment</div>
                    </div>
                    <div class="badge-card owned">
                        <div class="badge-shine"></div>
                        <div class="badge-icon">🔥</div>
                        <div class="badge-name">On Fire</div>
                        <div class="badge-desc">7 Day Streak Achieved</div>
                    </div>
                    <div class="badge-card owned">
                        <div class="badge-shine"></div>
                        <div class="badge-icon">📚</div>
                        <div class="badge-name">Scholar</div>
                        <div class="badge-desc">Scored 100% once</div>
                    </div>
                    <div class="badge-card owned">
                        <div class="badge-shine"></div>
                        <div class="badge-icon">⚡</div>
                        <div class="badge-name">Fast Learner</div>
                        <div class="badge-desc">Finished under 10 mins</div>
                    </div>

                    <!-- Locked Badges -->
                    <div class="badge-card locked">
                        <div class="badge-icon">🔒</div>
                        <div class="badge-name">Quiz Master</div>
                        <div class="badge-desc">Score 100% on 5 quizzes</div>
                    </div>
                    <div class="badge-card locked">
                        <div class="badge-icon">🔒</div>
                        <div class="badge-name">Month Legend</div>
                        <div class="badge-desc">30 Day Streak</div>
                    </div>
                    <div class="badge-card locked">
                        <div class="badge-icon">🔒</div>
                        <div class="badge-name">Top Topper</div>
                        <div class="badge-desc">Reach Rank #1</div>
                    </div>
                    <div class="badge-card locked">
                        <div class="badge-icon">🔒</div>
                        <div class="badge-name">Subject Pro</div>
                        <div class="badge-desc">Master all Math topics</div>
                    </div>
                </div>
            </div>

            <!-- EMPTY STATE SCREEN -->
            <div id="empty-state" class="screen">
                <div class="empty-state">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
                        class="empty-icon">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
                    </svg>
                    <h2>Select a topic to begin</h2>
                    <p>Choose any lesson or tool from the sidebar to continue your journey.</p>
                </div>
            </div>

        </div> <!-- End of dashboard-workspace -->
    </div> <!-- End of dashboard-container -->


    <script>
        // --- HELPER FUNCTIONS ---
        // ✅ STEP 1: Global User Helper
        function getLoggedInUser() {
            const user = localStorage.getItem("user");
            return user ? JSON.parse(user) : null;
        }

        function setLoggedInUser(user) {
            localStorage.setItem("user", JSON.stringify(user));
        }

        // ✅ STEP 2: Avatar Mapping
        const AVATAR_MAP = {
            programmer: "public/assets/avatars/careers/programmer.png",
            doctor: "public/assets/avatars/careers/doctor.png",
            gamer: "public/assets/avatars/careers/gamer.png",
            engineer: "public/assets/avatars/careers/engineer.png",
            teacher: "public/assets/avatars/careers/teacher.png",
            // Fallbacks for legacy/default
            boy1: "public/assets/avatars/boys/boy1.svg",
            default: "public/assets/avatars/careers/programmer.png"
        };


        // --- UI RENDERING (Strictly from LocalStorage) ---
        function renderUserUI(user) {
            // Backward compatibility wrapper
            if (!user) user = getLoggedInUser();
            if (!user) return;

            renderHeaderUser(user);
            renderProfilePage(user);

            // Also sidebar name if it exists separately
            // (No specific sidebar render requested but good to keep consistent)
        }

        // ✅ STEP 4: Header Rendering
        function renderHeaderUser(user) {
            if (!user) user = getLoggedInUser();
            if (!user) return;

            const nameEl = document.getElementById("header-user-name"); // Using ID from HTML
            // Note: User prompt asked for "headerUserName", but HTML uses "header-user-name" (via dynamic update) or "welcomeText"
            // Let's update both to be safe
            if (nameEl) nameEl.textContent = user.fullName || "Student";

            const welcomeEl = document.getElementById("welcomeText");
            if (welcomeEl) welcomeEl.innerText = `Hi ${user.fullName || "Student"}, ready to learn today?`;

            // Avatar
            const avatarKey = user.avatar || "programmer";
            const avatarSrc = AVATAR_MAP[avatarKey] || AVATAR_MAP['default'];

            // Update all header/dropdown images
            document.querySelectorAll(".header-profile-img, .profile-img-overlay").forEach(img => {
                img.src = avatarSrc;
                img.classList.remove('d-none');

                // Hide SVG sibling
                if (img.parentElement && img.parentElement.classList.contains('profile-img-container')) {
                    const svg = img.parentElement.querySelector('svg');
                    if (svg) svg.style.display = 'none';
                }
            });
        }

        // ✅ STEP 5: View Profile Page Rendering
        function renderProfilePage(user) {
            if (!user) user = getLoggedInUser();
            if (!user) return;

            // Using IDs from HTML
            // Note: User prompt asked for "profileFullName", HTML has "profileFullName" (line ~6486 targets it)
            const nameEl = document.getElementById("profileFullName");
            if (nameEl) nameEl.innerText = user.fullName || "Student";

            const classEl = document.getElementById("profileClass");
            if (classEl) classEl.innerText = `Class ${user.class || '10'} | Term 1`;

            const avatarKey = user.avatar || "programmer";
            const avatarSrc = AVATAR_MAP[avatarKey] || AVATAR_MAP['default'];

            const profileAvatars = document.querySelectorAll(".profile-pic-img-lg");
            profileAvatars.forEach(img => {
                img.src = avatarSrc;
            });

            // Bio
            const bioDisplay = document.querySelector(".profile-bio");
            if (bioDisplay) {
                bioDisplay.textContent = user.bio || "";
            }
        }

        function loadEditProfile() {
            const user = getLoggedInUser();
            if (!user) return;

            const nameInput = document.getElementById("editFullName");
            if (nameInput) nameInput.value = user.fullName || "";

            const classInput = document.getElementById("editClass");
            if (classInput) classInput.value = user.class || "";

            const bioInput = document.getElementById("editBio");
            if (bioInput) bioInput.value = user.bio || "";

            // Pre-select current avatar
            const currentAvatar = user.avatar || "programmer";
            selectAvatar(currentAvatar);
        }


        // --- BACKEND AUTHENTICATION SYSTEM (SIMULATED) ---
        class AuthBackend {
            constructor() {
                // Initialize Simulated DB if empty
                if (!localStorage.getItem('db_users')) localStorage.setItem('db_users', JSON.stringify([]));
                if (!localStorage.getItem('db_students')) localStorage.setItem('db_students', JSON.stringify([]));
                if (!localStorage.getItem('db_teachers')) localStorage.setItem('db_teachers', JSON.stringify([]));
                if (!localStorage.getItem('db_parents')) localStorage.setItem('db_parents', JSON.stringify([])); // Added for Parents
            }

            // Helper: Mock Hash (using simple btoa for demo as crypto.subtle is async and might complicate sync flows if strict)
            // ideally use crypto.subtle but let's stick to a reversible mock for prototype speed unless requested.
            // User asked for "hashed", so let's do a pseudo-hash.
            hashPassword(pwd) {
                let hash = 0;
                for (let i = 0; i < pwd.length; i++) {
                    const char = pwd.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return "h_" + Math.abs(hash).toString(16);
            }

            // 1. Signup
            signup(details) {
                const users = JSON.parse(localStorage.getItem('db_users'));
                const students = JSON.parse(localStorage.getItem('db_students'));
                const teachers = JSON.parse(localStorage.getItem('db_teachers'));
                const parents = JSON.parse(localStorage.getItem('db_parents'));

                // Check Duplicates
                if (details.role !== 'parent' && users.find(u => u.email === details.email)) throw new Error("Email already registered.");

                if (details.role === 'student') {
                    if (students.find(s => s.reg_no === details.reg_no)) throw new Error("Registration Number already exists.");
                } else if (details.role === 'teacher') {
                    if (teachers.find(t => t.emp_id === details.emp_id)) throw new Error("Employee ID already exists.");
                } else if (details.role === 'parent') {
                    // Parent Validation
                    const studentUser = users.find(u => u.email === details.student_email);
                    if (!studentUser) throw new Error("Student email not found.");

                    // Verify Student Password
                    const studentHash = this.hashPassword(details.student_password);
                    if (studentHash !== studentUser.password_hash) throw new Error("Invalid Student Password.");

                    // Check if Parent already exists for this student
                    if (parents.find(p => p.student_id === studentUser.user_id)) throw new Error("Parent already registered for this student.");

                    const parentId = Date.now();
                    // Link Parent to Student
                    parents.push({
                        parent_id: parentId,
                        name: details.name,
                        student_id: studentUser.user_id,
                        created_at: new Date().toISOString()
                    });
                    localStorage.setItem('db_parents', JSON.stringify(parents));

                    // Auto Login as Parent
                    return this.createSession({
                        user_id: parentId,
                        role: 'parent',
                        name: details.name,
                        linked_student: studentUser
                    });
                }

                // Create User
                const userId = Date.now();
                const passwordHash = this.hashPassword(details.password);

                const newUser = {
                    user_id: userId,
                    name: details.name,
                    email: details.email,
                    role: details.role,
                    password_hash: passwordHash,
                    created_at: new Date().toISOString()
                };

                users.push(newUser);
                localStorage.setItem('db_users', JSON.stringify(users));

                // Create Role Specific Entry
                if (details.role === 'student') {
                    students.push({
                        student_id: userId + 1,
                        user_id: userId,
                        reg_no: details.reg_no
                    });
                    localStorage.setItem('db_students', JSON.stringify(students));
                } else {
                    teachers.push({
                        teacher_id: userId + 2,
                        user_id: userId,
                        emp_id: details.emp_id
                    });
                    localStorage.setItem('db_teachers', JSON.stringify(teachers));
                }

                return this.createSession(newUser);
            }

            // 2. Login
            login(email, password, requestedRole) {
                const users = JSON.parse(localStorage.getItem('db_users'));

                // If Parent, we just verify student credentials but grant Parent Role
                if (requestedRole === 'parent') {
                    const student = users.find(u => u.email === email && u.role === 'student');
                    if (!student) throw new Error("Student account not found.");

                    const inputHash = this.hashPassword(password);
                    if (inputHash !== student.password_hash) throw new Error("Invalid Password.");

                    // Find Parent Name if registered, else imply "Parent of X"
                    const parents = JSON.parse(localStorage.getItem('db_parents'));
                    const registeredParent = parents.find(p => p.student_id === student.user_id);

                    const parentName = registeredParent ? registeredParent.name : "Parent of " + student.name;

                    return this.createSession({
                        user_id: registeredParent ? registeredParent.parent_id : Date.now(),
                        role: 'parent',
                        name: parentName,
                        linked_student: student
                    });
                }

                const user = users.find(u => u.email === email); // Using email as username for now

                if (!user) throw new Error("User not found.");

                const inputHash = this.hashPassword(password);
                if (inputHash !== user.password_hash) throw new Error("Invalid password.");

                return this.createSession(user);
            }

            // 3. Session Management
            createSession(user) {
                const session = {
                    token: 'sess_' + Math.random().toString(36).substr(2),
                    user_id: user.user_id,
                    role: user.role,
                    name: user.name,
                    expiry: Date.now() + 86400000 // 24 hours
                };
                localStorage.setItem('auth_session', JSON.stringify(session));
                return session;
            }

            getSession() {
                const sess = JSON.parse(localStorage.getItem('auth_session'));
                if (!sess) return null;
                if (Date.now() > sess.expiry) {
                    this.logout();
                    return null;
                }
                return sess;
            }

            logout() {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('auth_session'); // Keep for safety
                window.location.href = "index.html"; // Or login.html, but index handles auth check
            }
        }

        const authSystem = new AuthBackend();

        const app = {
            data: {
                user: "Student",
                grade: "10",
                streak: 12,
                performanceScore: 75, // 0 to 100
                mockQuestionBank: [
                    // Mock Questions for Auto-Add Feature (Normally from DB)
                    // We need at least 30+ questions to demonstrate
                    ...Array.from({ length: 40 }, (_, i) => ({
                        id: `bank-${i + 1}`,
                        text: `Auto-Generated Mock Question ${i + 1} for Testing purpose. What is the value of X?`,
                        options: ['Option A', 'Option B', 'Option C', 'Option D'],
                        subject: 'Mathematics',
                        class: '10' // Matches default or can be generic
                    })),
                    ...Array.from({ length: 10 }, (_, i) => ({
                        id: `bank-sci-${i + 1}`,
                        text: `Science Question ${i + 1}: Photosynthesis occurs in?`,
                        options: ['Roots', 'Leaves', 'Stems', 'Flowers'],
                        subject: 'Science',
                        class: '10'
                    }))
                ],
                modSelectedType: null, // Added for Modulator
                currentFile: null, // Store uploaded file
                teacherClassesData: [
                    { id: 1, name: "Class 10 - A", subject: "Science", students: 42, avg: 85, attendance: 92 },
                    { id: 2, name: "Class 9 - B", subject: "Physics", students: 38, avg: 78, attendance: 88 },
                    { id: 3, name: "Class 10 - B", subject: "Maths", students: 40, avg: 72, attendance: 85 }
                ]
            },

            init() {
                // Check Session
                const session = authSystem.getSession();
                if (session) {
                    this.onAuthSuccess(session);
                }

                // Silent Error Handling
                window.onerror = (message) => {
                    console.warn("System error caught and handled silently:", message);
                    return true; // Prevents the browser's default error popup
                };

                // Listeners
                // Listeners
                document.getElementById('login-form').addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('signup-form').addEventListener('submit', (e) => this.handleSignup(e));

                // Image Input Listener (Global for Edit Profile)
                const imgInput = document.getElementById("imageInput");
                if (imgInput) {
                    imgInput.addEventListener("change", function () {
                        const file = this.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const preview = document.getElementById("editProfileImage");
                            const initials = document.getElementById("edit-pic-initials");
                            if (preview) {
                                preview.src = e.target.result;
                                preview.style.display = 'block';
                            }
                            if (initials) initials.style.display = 'none';
                        };
                        reader.readAsDataURL(file);
                    });
                }


                // Initialize Modulator Drag & Drop
                this.initDragAndDrop();

                // Input Focus Animation Hooks (CSS covers this, but we ensure values stick)
                document.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        e.target.setAttribute('value', e.target.value);
                    });
                });

                // Scroll Observer
                this.observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('visible');
                        }
                    });
                }, { threshold: 0.15 });
            },

            // --- HELPERS ---
            renderEmptyState(containerId, message = "No data available") {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`renderEmptyState: Container '${containerId}' not found`);
                    return;
                }
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📂</div>
                        <p>${message}</p>
                    </div>
                `;
            },

            toggleAuthMode(target) {
                this.toggleAuth(target);
            },

            toggleAuth(target) {
                const loginCard = document.getElementById('login-card');
                const signupCard = document.getElementById('signup-card');
                const parentLoginCard = document.getElementById('parent-login-card');

                if (target === 'signup') {
                    if (loginCard) {
                        loginCard.style.opacity = '0';
                        loginCard.style.transform = 'translateY(-20px)';
                        setTimeout(() => loginCard.classList.add('hidden'), 300);
                    }
                    if (parentLoginCard) parentLoginCard.classList.add('hidden');

                    signupCard.classList.remove('hidden');
                    setTimeout(() => {
                        signupCard.style.opacity = '1';
                        signupCard.style.transform = 'translateY(0)';
                    }, 50);

                    // Toggle Parent Fields
                    const parentFields = document.getElementById('signup-fields-parent');
                    if (this.selectedRole === 'parent') {
                        if (parentFields) parentFields.classList.remove('hidden');
                        document.getElementById('signup-grade').parentElement.classList.add('hidden');
                        document.getElementById('signup-dob').parentElement.classList.add('hidden');
                    } else {
                        if (parentFields) parentFields.classList.add('hidden');
                        document.getElementById('signup-grade').parentElement.classList.remove('hidden');
                        document.getElementById('signup-dob').parentElement.classList.remove('hidden');
                    }
                } else {
                    // Target is Login
                    if (signupCard) {
                        signupCard.style.opacity = '0';
                        signupCard.style.transform = 'translateX(50px)';
                        setTimeout(() => signupCard.classList.add('hidden'), 300);
                    }

                    if (this.selectedRole === 'parent') {
                        if (loginCard) loginCard.classList.add('hidden');
                        if (parentLoginCard) {
                            parentLoginCard.classList.remove('hidden');
                            setTimeout(() => {
                                parentLoginCard.style.opacity = '1';
                                parentLoginCard.style.transform = 'translateY(0)';
                            }, 50);
                        }
                    } else {
                        if (parentLoginCard) parentLoginCard.classList.add('hidden');
                        if (loginCard) {
                            loginCard.classList.remove('hidden');
                            setTimeout(() => {
                                loginCard.style.opacity = '1';
                                loginCard.style.transform = 'translateY(0)';
                            }, 50);
                        }
                    }
                }
            },

            togglePass(id, btn) {
                const input = document.getElementById(id);
                if (input) {
                    const isPass = input.type === "password";
                    input.type = isPass ? "text" : "password";

                    // Toggle Icon
                    if (btn) {
                        if (isPass) {
                            // Shown -> Show Eye Off
                            btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-eye-off"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M1 1l22 22"></path><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"></path></svg>`;
                        } else {
                            // Hidden -> Show Eye
                            btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-eye"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
                        }
                    }
                }
            },

            /* --- AUTH METHODS --- */
            onAuthSuccess(session) {
                this.data.currentUser = session;
                this.data.user = session.name;
                localStorage.setItem('user_role', session.role);

                if (session.role === 'student') {
                    // Update Class from Session Info if available (stored in info field by backend)
                    if (session.info) this.data.class = session.info;
                    this.loadDashboard();
                } else if (session.role === 'parent') {
                    this.loadParentDashboard();
                } else {
                    this.loadTeacherDashboard();
                }
            },

            async fetchTeacherStats() {
                try {
                    const res = await fetch('/api/teacher/stats', {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    const data = await res.json();
                    if (data.success && data.stats) {
                        this.data.teacherStats = data.stats;

                        // Default Fallbacks
                        const s = data.stats;

                        // Update Dashboard Cards
                        if (document.getElementById('t-stat-students')) document.getElementById('t-stat-students').textContent = s.totalStudents;
                        if (document.getElementById('t-stat-classes')) document.getElementById('t-stat-classes').textContent = s.activeClasses;
                        if (document.getElementById('t-stat-assessments')) document.getElementById('t-stat-assessments').textContent = s.assessmentsCreated;
                        if (document.getElementById('t-stat-performance')) document.getElementById('t-stat-performance').textContent = s.avgPerformance + "%";

                        // Refresh Dropdown if open or created
                        const user = getLoggedInUser();
                        this.renderProfileDropdownUI('teacher', user);
                    }
                } catch (e) {
                    console.error("Teacher stats fetch failed", e);
                }
            },

            loadTeacherDashboard() {
                this.fetchTeacherStats(); // Call Stats Fetch

                // 1. Hide Auth Container
                const authContainer = document.getElementById('auth-container');
                if (authContainer) {
                    authContainer.style.opacity = '0';
                    setTimeout(() => authContainer.style.display = 'none', 300);
                }

                // 2. Show Main Dashboard Container
                const dashboardContainer = document.getElementById('dashboard-container');
                if (dashboardContainer) {
                    dashboardContainer.style.display = 'block';
                    dashboardContainer.offsetHeight; // Reflow
                    dashboardContainer.style.opacity = '1';
                }

                // 3. Hide Student Dashboard
                const studentScreen = document.getElementById('home-screen');
                if (studentScreen) {
                    studentScreen.style.display = 'none';
                    studentScreen.classList.remove('active');
                }

                // 4. Show Teacher Dashboard
                const teacherScreen = document.getElementById('teacher-dashboard-screen');
                if (teacherScreen) {
                    teacherScreen.style.display = 'block';
                    teacherScreen.classList.add('active');
                    teacherScreen.style.opacity = '1';

                    // Update Text
                    const tName = document.getElementById('teacher-welcome-name');
                    if (tName) tName.textContent = this.data.user + " 👨‍🏫";
                }

                // 5. Update Header
                const welcomeEl = document.getElementById('welcomeText');
                if (welcomeEl) welcomeEl.textContent = `Teacher ${this.data.user} 👨‍🏫`;
                document.getElementById('header-user-grade').textContent = "Teacher Portal";

                // 6. Manage Sidebar (Strict Role-Based)
                this.updateSidebar('teacher');

                // Background
                const bg = document.querySelector('.quantum-bg');
                if (bg) bg.classList.add('dashboard-active');

                // 7. Trigger Animations for Teacher Cards
                // We strictly target cards within the teacher screen to avoid conflict
                const teacherCards = teacherScreen.querySelectorAll('.dashboard-card');
                teacherCards.forEach((card, index) => {
                    setTimeout(() => {
                        card.classList.add('visible');
                    }, index * 100); // 100ms stagger
                });
            },

            async handleLogin(e) {
                e.preventDefault();
                let userInputStr, passInputStr;

                if (this.selectedRole === 'parent') {
                    // Get values from Parent Login Form
                    const uIn = document.getElementById('parent-login-user');
                    const pIn = document.getElementById('parent-login-pass');
                    userInputStr = uIn ? uIn.value.trim() : "";
                    passInputStr = pIn ? pIn.value.trim() : "";
                } else {
                    // Get values from Standard Login Form
                    const uIn = document.getElementById('login-user');
                    const pIn = document.getElementById('login-pass');
                    userInputStr = uIn ? uIn.value.trim() : "";
                    passInputStr = pIn ? pIn.value.trim() : "";
                }

                if (!userInputStr || !passInputStr) {
                    alert("Enter credentials.");
                    return;
                }

                // UI Loading
                const btn = document.querySelector('.btn-login-action');
                const originalText = btn ? btn.innerHTML : "";
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = "Verifying...";
                }

                try {
                    // CONNECT TO REAL SQL BACKEND
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: userInputStr,
                            password: passInputStr,
                            role: this.selectedRole
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        // 2️⃣ STORE TOKEN ON FRONTEND
                        localStorage.setItem("token", result.token);
                        localStorage.setItem("authToken", result.token); // Keep legacy support just in case

                        // 🔧 FIX 1 — ENSURE STUDENT CLASS IS STORED AT LOGIN
                        if (!result.user) {
                            alert("Login failed: Incomplete profile data");
                            throw new Error("Missing user profile");
                        }

                        // ALWAYS Overwrite localStorage with fresh data from DB
                        setLoggedInUser(result.user); // ✅ REQUIRED

                        // Success: Use session from backend
                        this.onAuthSuccess(result.session);
                    } else {
                        // Error: Show message (e.g., "Account disabled")
                        alert(result.message);
                    }

                } catch (err) {
                    console.error(err);
                    alert("Login Connection Failed. Is server running?");
                } finally {
                    if (btn) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                }
            },

            async handleSignup(e) {
                e.preventDefault();
                const role = localStorage.getItem('user_role') || 'student';
                const name = document.getElementById('signup-name').value.trim();
                const contact = document.getElementById('signup-contact').value.trim();
                const pass = document.getElementById('signup-pass').value.trim();

                if (!name || !contact || !pass) {
                    alert("Please fill in all fields.");
                    return;
                }

                // Loading State
                const btn = document.querySelector('#signup-form button');
                const originalText = btn ? btn.innerText : "Create Account";
                if (btn) {
                    btn.disabled = true;
                    btn.innerText = "Creating...";
                }

                try {
                    // Detect if input is email or phone
                    const isEmail = contact.includes('@');
                    const payload = {
                        name: name,
                        password: pass,
                        role: role
                    };

                    if (isEmail) payload.email = contact;
                    else payload.phone = contact;

                    // Parent Link Fields (if present)
                    const studentEmail = document.getElementById('signup-student-email');
                    if (studentEmail && studentEmail.value) payload.student_email = studentEmail.value;

                    // CALL REAL BACKEND
                    const response = await fetch('/api/signup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert("Account created successfully! Please login with your credentials.");
                        // Switch to Login View
                        this.toggleAuth('login');

                        // Pre-fill login
                        const loginUser = document.getElementById('login-user');
                        if (loginUser) loginUser.value = contact;
                    } else {
                        throw new Error(result.message || "Signup failed");
                    }

                } catch (err) {
                    console.error("Signup Error:", err);
                    alert("Signup Failed: " + err.message);
                } finally {
                    if (btn) {
                        btn.disabled = false;
                        btn.innerText = originalText;
                    }
                }
            },

            updateSidebar(role) {
                const allNavs = document.querySelectorAll('.side-nav .nav-item');

                if (role === 'teacher') {
                    // Show Teacher Items, Hide Student Specifics
                    allNavs.forEach(el => {
                        if (el.classList.contains('teacher-item')) {
                            el.classList.remove('hidden');
                        } else if (el.dataset.label === 'Dashboard' || el.dataset.label === 'Help & Support') {
                            el.classList.remove('hidden');
                        } else {
                            // Hide Student Assessment, Modulator, Achievements, Whiteboard
                            el.classList.add('hidden');
                        }
                    });
                } else if (role === 'parent') {
                    // Only Dashboard + Help
                    allNavs.forEach(el => {
                        const label = el.dataset.label;
                        if (label === 'Dashboard' || label === 'Help & Support') {
                            el.classList.remove('hidden');
                        } else {
                            el.classList.add('hidden');
                        }
                    });
                } else {
                    // Student: Show Standard, Hide Teacher
                    allNavs.forEach(el => {
                        if (el.classList.contains('teacher-item')) {
                            el.classList.add('hidden');
                        } else {
                            el.classList.remove('hidden');
                        }
                    });
                }
            },

            loadDashboard() {
                // 1. Hide Auth
                const authContainer = document.getElementById('auth-container');
                authContainer.style.opacity = '0';
                authContainer.style.transform = 'scale(0.9)';

                setTimeout(() => {
                    authContainer.style.display = 'none';

                    // 2. Populate Data
                    this.updateDashboardData();

                    // 3. Show Dashboard Container
                    const dashboard = document.getElementById('dashboard-container');
                    dashboard.style.display = 'block';
                    dashboard.offsetHeight; // Reflow
                    dashboard.style.opacity = '1';

                    // 4. Ensure Student View is Active & Teacher View is Hidden
                    const homeScreen = document.getElementById('home-screen');
                    const teacherScreen = document.getElementById('teacher-dashboard-screen');

                    if (homeScreen) {
                        homeScreen.style.display = 'grid';
                        homeScreen.classList.add('active');
                    }
                    if (teacherScreen) {
                        teacherScreen.style.display = 'none';
                        teacherScreen.classList.remove('active');
                    }

                    // 5. Trigger Animations
                    this.animateProgress();

                    // 6. Manage Sidebar (Strict Role-Based)
                    this.updateSidebar('student');

                    // 7. Observe Sections
                    document.querySelectorAll('.section').forEach(sec => this.observer.observe(sec));

                }, 600);
            },

            // 🔧 FIX 2 — RENDER LOGIC (VERY IMPORTANT)
            renderAssessments(assessments) {
                const container = document.getElementById("assessments-list");
                if (!container) return;

                container.innerHTML = ""; // clear ONCE

                if (!assessments || assessments.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <p>No published assessments available for your class.</p>
                        </div>
                    `;
                    return;
                }

                assessments.forEach(a => {
                    const card = document.createElement("div");
                    card.className = "assessment-card";

                    card.innerHTML = `
                    <h3>${a.title}</h3>
                    <p>${a.subject} · ${a.duration} Mins</p>
                    <p>${a.date} | ${a.start_time} – ${a.end_time}</p>
                    <button class="start-btn" onclick="event.stopPropagation(); app.openAssessment('${a.id}');">Start</button>
                    `;

                    // Apply styles dynamically for robustness if CSS is missing
                    card.style.padding = "1.5rem";
                    card.style.background = "rgba(255,255,255,0.05)";
                    card.style.borderRadius = "12px";
                    card.style.marginBottom = "1rem";
                    card.style.border = "1px solid var(--card-border)";

                    container.appendChild(card);
                });

                console.log("Rendered", assessments.length, "assessments");
            },

            async fetchAssessments() {
                try {
                    // Retrieve User 
                    const user = JSON.parse(localStorage.getItem("user"));
                    const studentClass = user ? user.class : null;

                    if (!studentClass) {
                        console.warn("Student class missing, skipping assessment fetch");
                        return;
                    }

                    console.log("Student class used for fetch:", studentClass);

                    const response = await fetch(`/api/student/assessments?class=${encodeURIComponent(studentClass)}`, {
                        headers: {
                            Authorization: `Bearer ${localStorage.getItem("token") || ""}`
                        }
                    });

                    const assessments = await response.json();

                    console.log("Student assessments loaded:", assessments); // DEBUG LOG

                    this.renderAssessments(assessments);

                } catch (e) {
                    console.error("Failed to fetch assessments", e);
                }
            },

            hideAllStudentSections() {
                const sections = [
                    'home-screen',
                    'student-assessment-page',
                    'help-centre',
                    'modulator-screen',
                    'profile-screen',
                    'empty-state',
                    'teacher-dashboard-screen'
                ];

                sections.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.style.display = 'none';
                        el.classList.remove('active');
                    }
                });
            },

            openStudentAssessmentPage() {
                try {
                    // 1. GLOBAL VIEW SWITCHER
                    this.hideAllStudentSections();

                    // 2. Show Assessment Page Strict
                    const assessPage = document.getElementById('student-assessment-page');
                    if (assessPage) {
                        assessPage.classList.remove('hidden');
                        assessPage.style.display = 'block';

                        // Force Reflow
                        void assessPage.offsetWidth;

                        assessPage.classList.add('active');
                        assessPage.style.opacity = '1';
                    } else {
                        console.error("Assessment Page container missing!");
                        return;
                    }

                    // 3. Update Sidebar Active State
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    const navItem = document.querySelector('.nav-item[data-label="Assessment"]');
                    if (navItem) navItem.classList.add('active');

                    // 4. Load Data
                    // 4. Load Data - NO FETCH HERE, reliance on window load or manual refresh if needed
                    // this.fetchAssessments();

                } catch (e) {
                    console.error("Error opening assessments:", e);
                }
            },



            updateDashboardData() {
                const role = localStorage.getItem('user_role');
                const isTeacher = role === 'teacher';
                const isParent = role === 'parent';

                // --- FIX: UNIVERSAL USER SOURCE ---
                const user = getLoggedInUser();
                const fullName = user?.fullName || this.data.user || "Student";

                // 1. Shared Header (Top Bar)
                if (role === 'student') {
                    // this.fetchAssessments(); // REMOVED to prevent duplicates, handled by window.load
                }

                const nameEl = document.getElementById('welcomeText'); // Using new ID
                if (nameEl) {
                    if (isTeacher) {
                        nameEl.textContent = "Hi " + fullName + ", ready to inspire?";
                    } else if (isParent) {
                        nameEl.textContent = "Welcome, Parent. Viewing Student Progress.";
                    } else {
                        nameEl.textContent = "Hi " + fullName + ", ready to learn today?";
                    }
                }

                // 1b. Update Profile Image from Session/DB
                const sessionStr = localStorage.getItem('auth_session');
                if (sessionStr) {
                    const session = JSON.parse(sessionStr);
                    // Explicitly fetch latest from DB to be sure (in case session is stale)
                    const users = JSON.parse(localStorage.getItem('db_users') || '[]');
                    const userRecord = users.find(u => u.user_id == session.user_id);

                    const imgUrl = (userRecord && userRecord.profileImage) ? userRecord.profileImage : session.profileImage;

                    if (imgUrl) {
                        // All avatar images
                        // Note: You might need to add specific classes to header icons if they don't have them
                        // Assuming header icon is an IMG or needs to be replaced. 
                        // The current HTML uses an SVG in .header-icon usually. 
                        // Let's assume there's a place for it or we replace the content.

                        // Wait, looking at index.html (lines 350-400 not fully seen but typically header has profile)
                        // If standard header has an icon, we might need to inject an img tag.
                        // Let's target any .profile-pic-img (Dashboard) and #edit-pic-img

                        const profileImgs = document.querySelectorAll('.profile-pic-img, #edit-pic-img, .header-profile-img, .profile-pic-img-lg');
                        profileImgs.forEach(img => {
                            img.src = imgUrl;
                            img.style.display = 'block';
                        });

                        // Hide initials
                        const initials = document.querySelectorAll('.profile-initials, #edit-pic-initials');
                        initials.forEach(el => el.style.display = 'none');

                        // HEADER ICON UPDATE:
                        // The header usually has a generic icon. We should check if we can replace it. 
                        // For now, let's update the Dashboard Profile Section specifically (line 2000-ish)
                        // Line 2000 shows: <div class="profile-pic-lg"> ... <img ... class="profile-pic-img d-none">

                    }
                }

                const gradeEl = document.getElementById('header-user-grade');
                if (gradeEl) {
                    if (isTeacher) gradeEl.textContent = "Teacher Account";
                    else if (isParent) gradeEl.textContent = "Parent View | Read Only";
                    else gradeEl.textContent = "Class " + this.data.grade + " | Term 1";
                }

                // 2. Profile Dropdown
                // FIX: Use profileName ID populated from Universal Source
                const profileDdName = document.getElementById('profileName');
                if (profileDdName) profileDdName.innerText = fullName;

                const profileDdGrade = document.getElementById('profile-dd-grade');
                if (profileDdGrade) {
                    if (isTeacher) profileDdGrade.textContent = "Teacher";
                    else if (isParent) profileDdGrade.textContent = "Parent";
                    else profileDdGrade.textContent = "Class " + this.data.grade;
                }

                // 3. Teacher Dashboard Specifics
                if (isTeacher) {
                    const tName = document.getElementById('teacher-welcome-name');
                    if (tName) tName.textContent = this.data.user + " 👨‍🏫";

                    // Stats
                    // Stats
                    if (document.getElementById('t-stat-students')) document.getElementById('t-stat-students').textContent = "42";
                    if (document.getElementById('t-stat-classes')) document.getElementById('t-stat-classes').textContent = "3";
                    if (document.getElementById('t-stat-assessments')) document.getElementById('t-stat-assessments').textContent = "15";
                    if (document.getElementById('t-stat-performance')) document.getElementById('t-stat-performance').textContent = "85%";
                }

                // 4. Render Profile Dropdown based on Role (Dynamic Injection)
                this.renderProfileDropdownUI(role, user);
            },

            renderProfileDropdownUI(role, user) {
                const dropdown = document.getElementById('profile-dropdown');
                if (!dropdown) return;

                const fullName = user?.fullName || this.data.user || (role === 'teacher' ? 'Teacher' : 'Student');
                const profileImg = user?.profileImage || ''; // URL

                if (role === 'teacher') {
                    // TEACHER VIEW
                    dropdown.innerHTML = `
                        <div class="profile-dd-header">
                            <div class="profile-dd-avatar profile-img-container">
                                <img src="${profileImg}" class="header-profile-img ${profileImg ? '' : 'd-none'} profile-img-overlay" alt="Profile">
                                <div style="font-size: 1.5rem;">👨‍🏫</div>
                            </div>
                            <div>
                                <div class="profile-dd-name">${fullName}</div>
                                <div class="profile-dd-class">Mathematics, Physics</div>
                                <div class="profile-dd-badge" style="background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3);">
                                    🧑‍🏫 Teacher
                                </div>
                            </div>
                        </div>

                        <div class="dd-stats-row" style="grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div class="dd-stat-item">
                                <span class="dd-stat-val">${app.data.teacherStats?.totalStudents || 0}</span>
                                Students 👥
                            </div>
                            <div class="dd-stat-item">
                                <span class="dd-stat-val">${app.data.teacherStats?.activeClasses || 0}</span>
                                Classes 🏫
                            </div>
                            <div class="dd-stat-item">
                                <span class="dd-stat-val">${app.data.teacherStats?.assessmentsCreated || 0}</span>
                                Assessments 📝
                            </div>
                            <div class="dd-stat-item">
                                <span class="dd-stat-val">${app.data.teacherStats?.avgPerformance || 0}%</span>
                                Avg Perf 📊
                            </div>
                        </div>

                        <div class="dd-buttons-row" style="margin-top: 1rem;">
                             <button class="dd-action-btn btn-flex-1" onclick="app.closeProfileDropdown(); app.openTeacherClasses()">
                                📋 Classes
                            </button>
                            <button class="dd-action-btn btn-flex-1" onclick="app.closeProfileDropdown(); app.openTeacherAssessment()">
                                📝 Assessment
                            </button>
                        </div>
                        
                        <div class="dd-buttons-row" style="margin-top: 0.5rem;">
                             <button class="dd-action-btn btn-flex-1" onclick="app.closeProfileDropdown(); app.openTeacherAnalytics()">
                                📊 Reports
                            </button>
                             <button class="dd-action-btn btn-flex-1" onclick="app.toggleTheme()">
                                Theme 🌗
                            </button>
                        </div>
                        
                        <div class="dd-divider"></div>

                         <div class="dd-link-row" onclick="app.closeProfileDropdown(); app.openEditProfile()">
                            <span>⚙️</span> Account Settings
                        </div>
                         <div class="dd-link-row logout-link" onclick="app.logout()">
                            <span>🚪</span> Logout
                        </div>
                    `;
                } else if (role === 'parent') {
                    // PARENT VIEW
                    dropdown.innerHTML = `
                         <div class="profile-dd-header">
                            <div class="profile-dd-avatar profile-img-container">
                                <div style="font-size: 1.5rem;">👨‍👩‍👧</div>
                            </div>
                            <div>
                                <div class="profile-dd-name">Parent</div>
                                <div class="profile-dd-class" style="font-size:0.8rem; opacity:0.8;">Student: ${user.linked_student?.name || 'Linked Student'}</div>
                                <div class="profile-dd-badge" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24;">Parent Portal</div>
                            </div>
                        </div>
                        <div class="dd-divider"></div>
                        <div class="dd-link-row" onclick="app.toggleTheme()">
                            <span>🌗</span> Theme
                        </div>
                        <div class="dd-link-row logout-link" onclick="app.logout()">
                            <span>🚪</span> Logout
                        </div>
                    `;
                } else {
                    // STUDENT VIEW (Default Restoration)
                    // We reconstruct the default student HTML to ensure we can switch back
                    const studentClassRaw = user ? user.class : null;
                    // Normalize: "Class 10 - A" -> "10A" for display maybe? Or just keep raw.
                    const displayClass = studentClassRaw ? `Class ${studentClassRaw}` : "Class 10 | Term 1";

                    dropdown.innerHTML = `
                        <div class="profile-dd-header">
                            <div class="profile-dd-avatar profile-img-container">
                                <img src="${profileImg}" class="header-profile-img ${profileImg ? '' : 'd-none'} profile-img-overlay" alt="Profile">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                    <circle cx="12" cy="7" r="4" />
                                </svg>
                            </div>
                            <div>
                                <div class="profile-dd-name" id="profileName">${fullName}</div>
                                <div class="profile-dd-class">${displayClass}</div>
                                <div class="profile-dd-badge">🔥 Consistent Learner</div>
                            </div>
                        </div>

                        <div class="dd-stats-row">
                            <div class="dd-stat-item" title="Current learning streak">
                                <span class="dd-stat-val">${user.streak || 12}</span>
                                Days Streak 🔥
                            </div>
                            <div class="dd-stat-item" title="Class Rank">
                                <span class="dd-stat-val">#4</span>
                                Current Rank 🏆
                            </div>
                            <div class="dd-stat-item" title="Overall Completion">
                                <span class="dd-stat-val">75%</span>
                                Completion 📊
                            </div>
                        </div>

                        <button class="dd-action-btn btn-view-profile" onclick="app.navTo('profile'); app.closeProfileDropdown()">
                            View Full Profile
                        </button>

                        <div class="dd-buttons-row">
                            <button class="dd-action-btn btn-flex-1" onclick="app.closeProfileDropdown(); app.openEditProfile()">Edit Profile</button>
                            <button class="dd-action-btn btn-flex-1" onclick="app.toggleTheme()">Theme 🌗</button>
                        </div>

                        <div class="dd-divider"></div>

                        <div class="dd-link-row" onclick="app.closeProfileDropdown(); app.navTo('profile')">
                            <span>📈</span> Progress Overview
                        </div>
                        <div class="dd-link-row" onclick="app.closeProfileDropdown(); app.navTo('achievements')">
                            <span>🏆</span> Achievements
                        </div>
                        <div class="dd-link-row">
                            <span>⚙️</span> Account Settings
                        </div>
                        <div class="dd-link-row" onclick="app.closeProfileDropdown(); app.navTo('help')">
                            <span>❓</span> Help & Support
                        </div>
                        <div class="dd-link-row logout-link" onclick="app.logout()">
                            <span>🚪</span> Logout
                        </div>
                    `;
                }
            },

            animateProgress() {
                const ring = document.getElementById('performance-ring');
                const text = document.getElementById('performance-text');
                const targetScore = this.data.performanceScore; // e.g. 75
                let currentScore = 0;

                // Animate slightly slower for smooth fill
                const interval = setInterval(() => {
                    if (currentScore >= targetScore) {
                        clearInterval(interval);
                    } else {
                        currentScore++;
                        // Update text
                        if (text) text.textContent = currentScore + "%";

                        // Update ring gradient
                        // 360 degrees * (percentage / 100)
                        const degrees = currentScore * 3.6;
                        if (ring) ring.style.background = `conic-gradient(var(--lavender-main) ${degrees}deg, rgba(255, 255, 255, 0.05) ${degrees}deg)`;
                    }
                }, 20); // 20ms per 1% = ~1.5s total animation for 75%
            },



            /* --- MODULATOR REBUILT LOGIC --- */

            /* --- MODULATOR REBUILT LOGIC (New Design) --- */

            resetModulator() {
                try {
                    // 1. Reset File Logic
                    this.data.currentFile = null;
                    const fileInput = document.getElementById('mod-file-upload');
                    if (fileInput) fileInput.value = '';

                    document.getElementById('upload-content-state').style.display = 'block';
                    document.getElementById('file-loaded-state').classList.add('hidden');

                    // 2. Reset AI Panel
                    const pills = document.querySelectorAll('.mod-pill-btn');
                    pills.forEach(p => {
                        p.classList.add('disabled');
                        p.classList.remove('active');
                        p.disabled = true;
                    });

                    document.getElementById('mod-ai-content').innerHTML = '';
                    document.getElementById('mod-ai-content').classList.add('hidden');
                    document.getElementById('mod-placeholder').style.display = 'block';

                    const chatInput = document.getElementById('mod-chat-input');
                    if (chatInput) {
                        // chatInput.disabled = true; // No longer disable
                        chatInput.value = '';
                    }
                    // const sendBtn = document.getElementById('mod-send-btn');
                    // if (sendBtn) sendBtn.style.pointerEvents = 'none'; // No longer disable

                } catch (e) {
                    console.warn("Reset Modulator Error:", e);
                }
            },

            handleFileUpload(input) {
                if (input.files && input.files[0]) {
                    const file = input.files[0];
                    this.data.currentFile = file;
                    const fileName = document.getElementById('uploaded-filename');
                    if (fileName) fileName.textContent = file.name;

                    // Switch Left Panel State
                    document.getElementById('upload-content-state').style.display = 'none';
                    document.getElementById('file-loaded-state').classList.remove('hidden');

                    // Activate Right Panel
                    this.enableModulatorInteractions();
                }
            },

            enableModulatorInteractions() {
                // Enable Pills
                document.querySelectorAll('.mod-pill-btn').forEach(p => {
                    p.classList.remove('disabled');
                    p.disabled = false;
                });

                const chatInput = document.getElementById('mod-chat-input');
                if (chatInput) {
                    chatInput.placeholder = "Ask something about the document...";
                }
            },

            handleModulatorAction(actionType) {
                // 1. Highlight Button
                document.querySelectorAll('.mod-pill-btn').forEach(p => p.classList.remove('active'));
                event.currentTarget.classList.add('active');

                // 2. Generate Content
                let prompt = "";
                if (actionType === 'simplify') prompt = "Simplifying the content...";
                else if (actionType === 'example') prompt = "Generating real-world examples...";
                else if (actionType === 'eli5') prompt = "Explaining like you're 10...";
                else if (actionType === 'quiz') prompt = "Creating a quick quiz...";

                this.generateAIResponse(prompt, actionType);
            },

            handleModulatorChat() {
                const input = document.getElementById('mod-chat-input');
                const text = input.value.trim();
                if (!text) return;

                // Clear Input
                input.value = '';

                // Simulate Response
                this.generateAIResponse("Thinking...", 'chat', text);
            },

            async generateAIResponse(loadingText, type, userQuery = "") {
                const contentArea = document.getElementById('mod-ai-content');
                const placeholder = document.getElementById('mod-placeholder');

                placeholder.style.display = 'none';
                contentArea.classList.remove('hidden');

                // Loading State
                contentArea.innerHTML = `
    <div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--lavender-light); gap:0.5rem;">
        <span class="loader-ring"></span>
        ${loadingText}
    </div>
`;

                try {
                    let response;

                    // Requirement: Send JSON for text-only requests (Frontend Fix)
                    if (type === 'chat') {
                        // Use RAG Endpoint for Chat
                        response = await fetch('/api/modulator/rag', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ question: userQuery })
                        });
                    } else if (!this.data.currentFile) {
                        response = await fetch('/api/modulator', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: type,
                                question: userQuery, // Required by backend
                                text: userQuery,
                                query: userQuery
                            })
                        });
                    } else {
                        // Use FormData for File Uploads
                        const formData = new FormData();
                        formData.append('file', this.data.currentFile);
                        formData.append('action', type);
                        formData.append('query', userQuery);

                        response = await fetch('/api/modulator', {
                            method: 'POST',
                            body: formData
                        });
                    }

                    // Safe Response Handling (Prevent "Unexpected token <" crash)
                    const textData = await response.text();
                    let data;

                    try {
                        data = JSON.parse(textData);
                    } catch (e) {
                        console.error("Non-JSON Response received:", textData.substring(0, 100));
                        throw new Error(`Server returned unexpected format (${response.status})`);
                    }

                    if (!response.ok) {
                        throw new Error(data.message || `Server Error: ${response.status}`);
                    }

                    if (data.answer) {
                        contentArea.innerHTML = data.answer.replace(/\n/g, '<br>');
                    } else if (data.success && (data.answer || data.message)) {
                        // Fallback for old/other endpoints
                        contentArea.innerHTML = data.answer || data.message;
                    } else {
                        contentArea.innerHTML = "No relevant answer found from study materials.";
                    }

                } catch (error) {
                    console.error("Modulator API Error:", error);
                    let displayError = error.message;

                    if (error.message.includes("Failed to fetch") || error.message.includes("NetworkError")) {
                        displayError = "Unable to connect to the Learning Service.";
                    }

                    contentArea.innerHTML = `
    <div class="mod-error-box">
        <h4>⚠️ AI Error</h4>
        <p>${displayError}</p>
        <button class="btn-secondary btn-sm" onclick="app.resetModulator()">Try Again</button>
    </div>
`;
                }
            },

            /* --- HELP CENTRE LOGIC --- */
            toggleHelpTopic(topic, element) {
                const panel = document.getElementById('help-topic-panel');
                const title = document.getElementById('help-panel-title');
                const content = document.getElementById('help-panel-content');

                if (!panel || !title || !content) return;

                // Content Map
                const data = {
                    'getting-started': {
                        title: '🚀 Getting Started',
                        html: `
    <p><strong>Welcome to your AI Learning Platform!</strong> Here is how to begin:</p>
    <ul class="help-content-list">
        <li><strong>Dashboard:</strong> Your central hub for daily progress.</li>
        <li><strong>Assessments:</strong> Take the initial diagnostic test to set your baseline.</li>
        <li><strong>Profile:</strong> Update your class and subjects in the settings.</li>
    </ul>
`
                    },
                    'assessments': {
                        title: '📊 Assessments & Scores',
                        html: `
    <p><strong>Understanding your scores:</strong></p>
    <ul class="help-content-list">
        <li><strong>Adaptive Difficulty:</strong> Questions get harder as you answer correctly.</li>
        <li><strong>Hints:</strong> Using hints reduces the score slightly but helps learning.</li>
        <li><strong>Review:</strong> Always check the "AI Explanation" after a test to learn.</li>
    </ul>
`
                    },
                    'modulator': {
                        title: '✨ Modulator Help',
                        html: `
    <p><strong>Turn content into learning:</strong></p>
    <ul class="help-content-list">
        <li><strong>Upload:</strong> PDF, Images, or Text files supported.</li>
        <li><strong>AI Actions:</strong> Use "Simplify", "Quiz", or "Examples" to process content.</li>
        <li><strong>Limits:</strong> Currently supports files up to 10MB.</li>
    </ul>
`
                    },
                    'account': {
                        title: '👤 Account & Profile',
                        html: `
    <p><strong>Manage your account:</strong></p>
    <ul class="help-content-list">
        <li><strong>Password:</strong> Can be reset from the login screen.</li>
        <li><strong>Privacy:</strong> Your data is encrypted and never shared.</li>
        <li><strong>Logout:</strong> Access via the Profile menu.</li>
    </ul>
`
                    }
                };

                const item = data[topic];
                if (item) {
                    title.textContent = item.title;
                    content.innerHTML = item.html;
                    panel.classList.remove('hidden');
                    panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            },

            handleHelpSearch(input) {
                const term = input.value.toLowerCase().trim();
                const cards = document.querySelectorAll('.help-action-card');

                cards.forEach(card => {
                    const title = card.querySelector('.help-card-title').textContent.toLowerCase();
                    const desc = card.querySelector('.help-card-desc').textContent.toLowerCase();

                    if (title.includes(term) || desc.includes(term)) {
                        card.style.display = 'flex';
                    } else {
                        card.style.display = 'none';
                    }
                });
            },

            askHelpAI() {
                const input = document.getElementById('help-ai-input');
                const responseArea = document.getElementById('help-ai-response');
                if (!input || !responseArea) return;

                const query = input.value.trim();
                if (!query) return;

                // Loading
                responseArea.classList.remove('hidden');
                responseArea.innerHTML = "🤖 AI is thinking...";

                setTimeout(() => {
                    responseArea.innerHTML = `
                        <strong>AI Answer:</strong><br>
                        Based on your query "<em>${query}</em>", here is a quick step:
                        <br><br>
                        1. Navigate to the relevant section.<br>
                        2. Look for the settings icon.<br>
                        3. If issue persists, use "Report a Bug".
                    `;
                    input.value = '';
                }, 1000);
            },

            askTeacherAI() {
                alert("AI Co-Pilot is analysing your request... (Feature coming soon!)");
            },

            reportIssueAI() {
                alert("Bug report feature coming soon. Please use email for now.");
            },

            initDragAndDrop() {
                const dropZone = document.getElementById('drop-zone-area');
                if (!dropZone) return;

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, e => {
                        e.preventDefault();
                        e.stopPropagation();
                    }, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
                });

                dropZone.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    this.handleFileUpload({ files: files });
                }, false);
            },

            toggleSearch() {
                const input = document.getElementById('header-search-input');
                if (!input) return;

                if (input.classList.contains('active')) {
                    input.classList.remove('active');
                    // Blur after small delay to allow click to register if needed
                    setTimeout(() => {
                        // input.style.display = 'none'; // Optional: hide completely if needed
                    }, 300);
                } else {
                    // input.style.display = 'block';
                    input.classList.add('active');
                    input.focus();
                }
            },

            toggleNotifications() {
                console.log('Toggling notifications dropdown...');
                // Logic for dropdown would go here
                // For now, just a visual feedback or toast
            },

            async openSubject(subjectName) {
                // Enabled subjects whitelist
                const enabledSubjects = ["Mathematics", "Tamil", "English", "Science", "Social Science"];

                if (!enabledSubjects.includes(subjectName)) {
                    // console.log("Subject not yet enabled:", subjectName);
                    return;
                }

                try {
                    const res = await fetch(`/api/student/study-materials?subject=${encodeURIComponent(subjectName)}`);
                    const data = await res.json();

                    if (data.success && data.materials && data.materials.length > 0) {
                        // Open the first material found (e.g. Full Textbook)
                        const materialId = data.materials[0].id;
                        const pdfUrl = `/api/student/study-materials/view/${materialId}`;
                        // Use custom PDF.js viewer with search
                        const viewerUrl = `pdf_viewer.html?file=${encodeURIComponent(pdfUrl)}&title=${encodeURIComponent(subjectName)}`;
                        window.open(viewerUrl, '_blank');
                    } else {
                        alert(`No study materials found for ${subjectName}.`);
                    }
                } catch (err) {
                    console.error("Error opening subject:", err);
                    alert("Failed to load study materials. Please try again.");
                }
            },

            toggleTheme() {
                document.body.classList.toggle('theme-indigo');
                const isIndigo = document.body.classList.contains('theme-indigo');
                localStorage.setItem('theme', isIndigo ? 'indigo' : 'default');
            },

            /* --- VIEW RENDERERS --- */
            renderDashboard() {
                const role = localStorage.getItem('user_role');

                if (role === 'parent') {
                    this.loadParentDashboard();
                    return;
                }

                const isTeacher = role === 'teacher';

                // Update Sidebar based on role
                this.updateSidebar(isTeacher ? 'teacher' : 'student');

                if (isTeacher) {
                    // Hide Student Dashboard
                    const homeScreen = document.getElementById('home-screen');
                    if (homeScreen) {
                        homeScreen.style.display = 'none';
                        homeScreen.classList.remove('active');
                    }

                    // Show Teacher Dashboard
                    const teachScreen = document.getElementById('teacher-dashboard-screen');
                    if (teachScreen) {
                        teachScreen.style.display = 'block';
                        setTimeout(() => {
                            teachScreen.classList.add('active');
                            teachScreen.style.opacity = '1';
                        }, 10);
                    }
                } else {
                    // Hide Teacher Dashboard
                    const teachScreen = document.getElementById('teacher-dashboard-screen');
                    if (teachScreen) {
                        teachScreen.style.display = 'none';
                        teachScreen.classList.remove('active');
                    }

                    // Show Student Dashboard
                    const homeScreen = document.getElementById('home-screen');
                    if (homeScreen) {
                        homeScreen.style.display = 'grid'; // Original Grid Layout
                        try {
                            this.updateDashboardData();
                            this.animateProgress();
                            if (this.observer) {
                                document.querySelectorAll('.section').forEach(sec => this.observer.observe(sec));
                            }
                        } catch (e) {
                            console.warn("Dashboard data update failed:", e);
                        }

                        // Force visibility
                        setTimeout(() => {
                            homeScreen.classList.add('active');
                            homeScreen.style.opacity = '1';
                        }, 10);
                    }
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },

            updateSidebar(role) {
                const nav = document.querySelector('.side-nav');
                if (!nav) return;

                if (role === 'teacher') {
                    nav.innerHTML = `
                        <div class="nav-item active" data-label="Dashboard" onclick="app.navTo('dashboard')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        </div>
                        <div class="nav-item" data-label="Attendance" onclick="app.openTeacherAttendance()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M9 12h6"></path><path d="M9 16h6"></path></svg>
                        </div>
                        <div class="nav-item" data-label="Classes" onclick="app.openTeacherClasses()">
                             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        </div>
                        <div class="nav-item" data-label="Reports" onclick="app.openTeacherAnalytics()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                        </div>
                        <div class="nav-item" data-label="Assessment" onclick="app.openTeacherAssessment()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        </div>
                        <div class="nav-item" data-label="Help & Support" onclick="app.navTo('help')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        </div>
                    `;
                } else if (role === 'parent') {
                    nav.innerHTML = `
                         <div class="nav-item active" data-label="Dashboard" onclick="app.loadParentDashboard()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        </div>
                        <div class="nav-item" data-label="Reports" onclick="document.getElementById('parent-reports-list') && document.getElementById('parent-reports-list').scrollIntoView({behavior:'smooth'})">
                             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        </div>
                        <div class="nav-item" data-label="Help & Support" onclick="app.navTo('help')">
                             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        </div>
                    `;
                } else {
                    nav.innerHTML = `
                        <div class="nav-item active" data-label="Dashboard" onclick="app.navTo('dashboard')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></svg>
                        </div>
                        <div class="nav-item" data-label="Assessment" onclick="app.openAssessment()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><rect x="8" y="2" width="8" height="4" rx="1" ry="1" /><path d="M9 14l2 2 4-4" /></svg>
                        </div>
                        <div class="nav-item" data-label="Modulator" onclick="app.navTo('modulator')">
                           <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 3h5v5" /><path d="M4 20L21 3" /><path d="M21 16v5h-5" /><path d="M15 15l6 6" /><path d="M4 4l5 5" /></svg>
                        </div>
                        <div class="nav-item" data-label="Achievements" onclick="app.navTo('achievements')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" /><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" /><path d="M4 22h16" /><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" /><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" /><path d="M18 2H6v7a6 6 0 0 0 12 0V2z" /></svg>
                        </div>
                        <div class="nav-item" data-label="Whiteboard" onclick="app.navTo('whiteboard')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2" /><line x1="8" y1="21" x2="16" y2="21" /><line x1="12" y1="17" x2="12" y2="21" /></svg>
                        </div>
                        <div class="nav-item has-notification" data-label="Help & Support" onclick="app.navTo('help')" id="nav-help-btn">
                             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        </div>
                   `;
                }

                // Restore active state based on current page if known?
                // Simplification based on navTo re-running active check
            },

            renderModulator() {
                const modulatorScreen = document.getElementById('modulator-screen');
                if (modulatorScreen) {
                    modulatorScreen.style.display = 'block';
                    setTimeout(() => {
                        modulatorScreen.classList.add('active');
                        modulatorScreen.style.opacity = '1';
                    }, 10);

                    try {
                        if (typeof this.resetModulator === 'function') this.resetModulator();
                    } catch (e) { console.warn("Modulator reset error:", e); }
                } else {
                    this.navTo('home');
                }
            },

            renderHelp() {
                const helpScreen = document.getElementById('help-centre');
                if (helpScreen) {
                    helpScreen.style.display = 'block';
                    void helpScreen.offsetWidth; // Force Reflow
                    helpScreen.classList.add('active');
                    helpScreen.style.opacity = '1';

                    const helpIcon = document.querySelector('.nav-item[data-label="Help & Support"]');
                    if (helpIcon) helpIcon.classList.remove('has-notification');
                    localStorage.setItem('help_visited', 'true');
                }
            },

            renderProfile() {
                const profileScreen = document.getElementById('profile-screen');
                if (profileScreen) {
                    profileScreen.style.display = 'block';
                    void profileScreen.offsetWidth;
                    profileScreen.classList.add('active');
                    profileScreen.style.opacity = '1';
                    this.closeProfileDropdown();

                    // --- FIX: UNIVERSAL USER SOURCE for Profile Page ---
                    const user = getLoggedInUser();
                    if (user) {
                        const fullName = user.fullName || "Student";
                        const className = user.class ? `Class ${user.class}` : "Class 10";
                        const term = user.term ? ` | Term ${user.term}` : " | Term 1";

                        // Update DOM Elements
                        const profileNameEl = document.getElementById("profileFullName");
                        const profileClassEl = document.getElementById("profileClass");

                        if (profileNameEl) profileNameEl.innerText = fullName;
                        if (profileClassEl) profileClassEl.innerText = className + term;
                    }

                    // Populate Heatmap
                    // ... existing heatmap logic ...
                    if (typeof populateProfileHeatmap === 'function') populateProfileHeatmap();
                }
            },

            renderAchievements() {
                const achScreen = document.getElementById('achievements-screen');
                if (achScreen) {
                    achScreen.style.display = 'block';
                    void achScreen.offsetWidth;
                    achScreen.classList.add('active');
                    achScreen.style.opacity = '1';
                } else {
                    this.navTo('home');
                }
            },

            renderAssessment() {
                const assessScreen = document.getElementById('assessment-container');
                if (assessScreen) {
                    assessScreen.style.display = 'block';
                    setTimeout(() => assessScreen.classList.add('active'), 10);
                } else {
                    this.navTo('home');
                }
            },

            renderWhiteboard() {
                const wbScreen = document.getElementById('whiteboard-screen');
                if (wbScreen) {
                    wbScreen.style.display = 'block';
                    setTimeout(() => {
                        wbScreen.classList.add('active');
                        wbScreen.style.opacity = '1';
                    }, 10);

                    // Reset views: always show subjects grid first
                    const subjectsGrid = document.getElementById('wb-subjects-grid');
                    const lessonsView = document.getElementById('wb-lessons-view');
                    const mcqView = document.getElementById('wb-mcq-view');

                    if (subjectsGrid) subjectsGrid.style.display = 'grid';
                    if (lessonsView) lessonsView.style.display = 'none';
                    if (mcqView) mcqView.style.display = 'none';

                    // Populate if empty
                    const grid = document.getElementById('wb-subjects-grid');
                    if (grid && grid.children.length === 0) {
                        const subjects = [
                            { name: 'Mathematics', icon: '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" /><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />' },
                            { name: 'Science', icon: '<circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" />' },
                            { name: 'English', icon: '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" /><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />' },
                            { name: 'Social Studies', icon: '<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>' },
                            { name: 'Tamil', icon: '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" /><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />' }
                        ];

                        grid.innerHTML = subjects.map(sub => `
                            <div class="wb-card" onclick="app.openWhiteboardSubject('${sub.name}')">
    <svg class="wb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        ${sub.icon}
    </svg>
    <h3 class="wb-card-title">${sub.name}</h3>
</div>
                        `).join('');
                    }
                } else {
                    this.navTo('home');
                }
            },

            openWhiteboardSubject(subject) {
                const grid = document.getElementById('wb-subjects-grid');
                const view = document.getElementById('wb-lessons-view');
                const title = document.getElementById('wb-lessons-title');
                const list = document.getElementById('wb-lessons-list');

                if (grid && view && list) {
                    grid.style.display = 'none';
                    view.style.display = 'block';
                    if (title) title.textContent = subject + " Lessons";

                    // Mock Lessons
                    const lessons = [
                        { name: 'Introduction to ' + subject, time: '10 mins', level: 'Easy' },
                        { name: 'Intermediate Concepts', time: '15 mins', level: 'Medium' },
                        { name: 'Advanced Problem Solving', time: '20 mins', level: 'Hard' },
                        { name: 'Quick Revision', time: '5 mins', level: 'Easy' },
                        { name: 'Topic Test 1', time: '10 mins', level: 'Medium' }
                    ];

                    list.innerHTML = lessons.map(l => `
                        <div class="wb-lesson-card" onclick="app.startWhiteboardTest('${l.name}')">
    <div>
        <div class="wb-lesson-title">${l.name}</div>
        <div class="wb-lesson-tags">
            <span class="wb-tag">${l.time}</span>
            <span class="wb-tag ${l.level === 'Easy' ? 'wb-tag-easy' : l.level === 'Medium' ? 'wb-tag-medium' : 'wb-tag-hard'}">${l.level}</span>
        </div>
    </div>
    <svg class="wb-arrow-icon" viewBox="0 0 24 24">
        <path d="M9 18l6-6-6-6"/>
    </svg>
</div>
                    `).join('');
                }
            },

            backToWhiteboardSubjects() {
                const grid = document.getElementById('wb-subjects-grid');
                const view = document.getElementById('wb-lessons-view');
                if (grid && view) {
                    view.style.display = 'none';
                    grid.style.display = 'grid';
                }
            },

            /* --- WHITEBOARD TEST LOGIC --- */
            wbState: {
                questions: [],
                currentIdx: 0,
                score: 0,
                timer: null
            },

            startWhiteboardTest(lessonName) {
                const lessonView = document.getElementById('wb-lessons-view');
                const mcqView = document.getElementById('wb-mcq-view');
                if (lessonView && mcqView) {
                    lessonView.style.display = 'none';
                    mcqView.style.display = 'block';

                    // Mock Questions
                    this.wbState.questions = Array(10).fill(null).map((_, i) => ({
                        id: i,
                        text: `This is a sample question ${i + 1} about ${lessonName}. What is the correct answer?`,
                        options: ["Option A: The most likely answer", "Option B: A plausible distractor", "Option C: Clearly wrong", "Option D: None of these"],
                        correct: 0, // Always A for demo
                        explanation: "Option A is correct because of the fundamental principles discussed in this chapter."
                    }));

                    this.wbState.currentIdx = 0;
                    this.wbState.score = 0;
                    this.renderWhiteboardQuestion();
                }
            },

            renderWhiteboardQuestion() {
                const view = document.getElementById('wb-mcq-view');
                const q = this.wbState.questions[this.wbState.currentIdx];
                const progress = ((this.wbState.currentIdx + 1) / this.wbState.questions.length) * 100;

                view.innerHTML = `
    <div class="wb-mcq-container">
        <div class="mcq-meta">
            <span>Question ${this.wbState.currentIdx + 1} / ${this.wbState.questions.length}</span>
            <span>Timer: 00:00 (Demo)</span>
        </div>
        <div class="mcq-progress-bar"><div class="mcq-progress-fill width-${Math.round(progress)}-pct" style="width:${progress}%"></div></div>
        
        <h3 class="mcq-question-text">${q.text}</h3>
        
        <div id="wb-options-list">
            ${q.options.map((opt, i) => `
                <div class="mcq-option" onclick="app.checkWhiteboardAnswer(${i}, this)">
                    <span class="mcq-option-letter">${String.fromCharCode(65 + i)}</span>
                    ${opt}
                </div>
            `).join('')}
        </div>

        <div id="wb-feedback" class="wb-feedback">
            <!-- Injected Feedback -->
        </div>
        
        <div class="wb-controls">
            <button class="ai-helper-btn" onclick="app.wbAIHelp('explain')">✨ Explain Simply</button>
            <button class="ai-helper-btn" onclick="app.wbAIHelp('example')">💡 Give Example</button>
            <div class="flex-1"></div>
            <button id="wb-next-btn" class="btn-primary wb-next-btn" onclick="app.nextWhiteboardQuestion()">
                ${this.wbState.currentIdx === 9 ? 'Finish Test' : 'Next Question'}
            </button>
        </div>
    </div>
`;
            },

            checkWhiteboardAnswer(selectedIndex, element) {
                const q = this.wbState.questions[this.wbState.currentIdx];
                const options = document.querySelectorAll('.mcq-option');
                const feedback = document.getElementById('wb-feedback');
                const nextBtn = document.getElementById('wb-next-btn');

                // Disable all
                options.forEach(opt => opt.classList.add('disabled'));

                if (selectedIndex === q.correct) {
                    element.classList.add('correct');
                    this.wbState.score++;
                    feedback.innerHTML = `<div class="wb-feedback-correct"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> <strong>Correct!</strong> Great job.</div>`;
                } else {
                    element.classList.add('wrong');
                    options[q.correct].classList.add('correct'); // Show right answer
                    feedback.innerHTML = `<div class="wb-feedback-wrong"><strong>Incorrect.</strong> The right answer is A.</div><div class="wb-explanation">${q.explanation}</div>`;
                }

                feedback.style.display = 'block';
                if (nextBtn) nextBtn.style.display = 'block';
            },

            nextWhiteboardQuestion() {
                if (this.wbState.currentIdx < this.wbState.questions.length - 1) {
                    this.wbState.currentIdx++;
                    this.renderWhiteboardQuestion();
                } else {
                    this.showWhiteboardResults();
                }
            },

            showWhiteboardResults() {
                const view = document.getElementById('wb-mcq-view');
                const percentage = (this.wbState.score / this.wbState.questions.length) * 100;

                view.innerHTML = `
    <div class="wb-mcq-container wb-results-container">
        <h2 class="wb-results-title">Test Complete!</h2>
        <div class="wb-results-score ${percentage >= 70 ? 'wb-results-score-high' : 'wb-results-score-mid'}">${percentage}%</div>
        <p class="wb-results-sub">You got ${this.wbState.score} out of ${this.wbState.questions.length} correct.</p>
        
        <div class="wb-results-actions">
            <button class="btn-secondary" onclick="app.navTo('whiteboard')">Back to Subjects</button>
            <button class="btn-primary" onclick="alert('Revision mode coming soon')">Revise Weak Areas</button>
        </div>
    </div>
`;
            },

            wbAIHelp(type) {
                alert(type === 'explain' ? "AI is generating a simple explanation..." : "AI is creating a real-world example...");
            },

            /* --- NAVIGATION LOGIC --- */

            navTo(rawPage) {
                const page = rawPage ? String(rawPage).toLowerCase().trim() : 'dashboard';

                // 2. Check if already on Dashboard (Home) - Optimized Return
                if (page === 'dashboard' || page === 'home') {
                    const homeScreen = document.getElementById('home-screen');
                    // Check if strictly active (class content and display style)
                    if (homeScreen && homeScreen.classList.contains('active') && homeScreen.style.display !== 'none') {
                        return;
                    }
                }

                // 3. Define Views Map
                const views = {
                    'home': () => this.renderDashboard(),
                    'dashboard': () => this.renderDashboard(), // Alias
                    'modulator': () => this.renderModulator(),
                    'converter': () => this.renderModulator(),
                    'help': () => this.renderHelp(),
                    'profile': () => this.renderProfile(),
                    'achievements': () => this.renderAchievements(),
                    'assessment': () => this.renderAssessment(),
                    'whiteboard': () => this.renderWhiteboard(),
                    'classes': () => alert('Classes View coming soon!'),
                    'analytics': () => alert('Analytics View coming soon!')
                };

                // 4. Hide All & Deactivate Nav
                const screens = document.querySelectorAll('.dashboard-workspace > .screen');
                const navItems = document.querySelectorAll('.side-nav .nav-item');
                const dashContainer = document.getElementById('dashboard-container');

                if (dashContainer) {
                    dashContainer.style.display = 'block';
                    dashContainer.style.opacity = '1';
                }

                screens.forEach(s => {
                    s.classList.remove('active');
                    s.style.display = 'none';
                    s.style.opacity = '0';
                });

                navItems.forEach(item => {
                    item.classList.remove('active');
                    const label = item.getAttribute('data-label')?.toLowerCase();
                    if (label === page || (page === 'help' && label === 'help & support') || (page === 'dashboard' && label === 'dashboard') || (page === 'home' && label === 'dashboard')) {
                        item.classList.add('active');
                    }
                });

                // 5. Route
                if (views[page]) {
                    views[page]();
                } else {
                    const emptyState = document.getElementById('empty-state');
                    if (emptyState) {
                        emptyState.style.display = 'flex';
                        setTimeout(() => emptyState.classList.add('active'), 10);
                    }
                    console.warn(`Navigated to unhandled state: ${page}`);
                }

            },

            openFullLeaderboard() {
                const modal = document.getElementById('leaderboard-modal');
                modal.style.display = 'flex';
                this.filterLeaderboard('week', document.querySelector('.filter-btn.active'));
            },

            filterLeaderboard(period, btn) {
                // Update active state
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                if (btn) btn.classList.add('active');

                const list = document.getElementById('modal-list');
                list.innerHTML = `<div class="updating-msg">Updating ${period} data...</div>`;

                // Mock data for different periods
                setTimeout(() => {
                    const mockData = {
                        week: [
                            { rank: 1, name: "Aarav", perf: 98, crown: true },
                            { rank: 2, name: "Vihaan", perf: 92 },
                            { rank: 3, name: "Anaya", perf: 88 },
                            { rank: 4, name: "You", perf: 84, me: true },
                            { rank: 5, name: "Ishani", perf: 78 },
                            { rank: 6, name: "Kabir", perf: 75 },
                            { rank: 7, name: "Zoya", perf: 72 }
                        ],
                        month: [
                            { rank: 1, name: "Vihaan", perf: 95, crown: true },
                            { rank: 2, name: "Aarav", perf: 94 },
                            { rank: 3, name: "You", perf: 91, me: true },
                            { rank: 4, name: "Anaya", perf: 89 },
                            { rank: 5, name: "Ishani", perf: 82 }
                        ],
                        overall: [
                            { rank: 1, name: "Aarav", perf: 97, crown: true },
                            { rank: 2, name: "Vihaan", perf: 96 },
                            { rank: 3, name: "Ishani", perf: 93 },
                            { rank: 4, name: "Anaya", perf: 90 },
                            { rank: 5, name: "You", perf: 88, me: true }
                        ]
                    };

                    const data = mockData[period] || mockData.week;
                    list.innerHTML = "";

                    data.forEach(item => {
                        const row = document.createElement('div');
                        row.className = `leaderboard-row ${item.me ? 'me' : ''}`;
                        row.innerHTML = `
    <span class="row-rank">
        ${item.crown ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="#fbbf24" class="row-rank-crown-icon"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>' : ''}
        ${item.rank}
    </span>
    <span class="row-name">${item.name}</span>
    <div class="row-progress"><div class="progress-bar" style="width: ${item.perf}%;"></div></div>
    <span class="row-indicator ${item.perf > 90 ? 'row-indicator-high' : 'row-indicator-mid'}">${item.perf}%</span>
`;
                        list.appendChild(row);
                    });
                }, 400);
            },

            /* --- SMART ASSESSMENT LOGIC --- */
            assessment: {
                questions: [
                    {
                        type: "MCQ",
                        text: "In a right-angled triangle, if sides are 6cm and 8cm, what is the length of the hypotenuse?",
                        options: ["10 cm", "12 cm", "14 cm", "16 cm"],
                        correct: 0,
                        hints: [
                            "Concept: In a right triangle, a² + b² = c².",
                            "Formula: 6² + 8² = c²",
                            "Partial Solution: 36 + 64 = 100. Now find √100."
                        ],
                        difficulty: "Easy",
                        topic: "Calculations"
                    },
                    {
                        type: "MCQ",
                        text: "Which of these sets of numbers form a Pythagorean triplet?",
                        options: ["3, 4, 6", "5, 12, 13", "7, 24, 26", "8, 15, 18"],
                        correct: 1,
                        hints: [
                            "Concept: Triplet satisfies a² + b² = c².",
                            "Formula: Smallest² + Middle² = Largest²",
                            "Partial Solution: For 5,12,13: 25 + 144 = 169. Since 13² = 169, it works."
                        ],
                        difficulty: "Medium",
                        topic: "Triplets"
                    },
                    {
                        type: "MCQ",
                        text: "If the hypotenuse is 13cm and one side is 5cm, find the third side.",
                        options: ["10 cm", "11 cm", "12 cm", "8 cm"],
                        correct: 2,
                        hints: [
                            "Concept: Rearrange formula to find a side: b² = c² - a².",
                            "Formula: b² = 13² - 5²",
                            "Partial Solution: 169 - 25 = 144. Find √144."
                        ],
                        difficulty: "Medium",
                        topic: "Calculations"
                    },
                    {
                        type: "MCQ",
                        text: "A ladder 15m long reaches a window 12m high. How far is the base from the wall?",
                        options: ["7m", "9m", "10m", "11m"],
                        correct: 1,
                        hints: [
                            "Concept: The ladder forms the hypotenuse, wall is height.",
                            "Formula: Base² = 15² - 12²",
                            "Partial Solution: 225 - 144 = 81. Find √81."
                        ],
                        difficulty: "Hard",
                        topic: "Applications"
                    }
                ],
                currentIdx: 0,
                score: 0,
                streak: 0,
                hintsUsedTotal: 0,
                currentHintsShown: 0,
                canRetry: true,
                timer: null,
                timeRemaining: 1800,
                startTime: null,
                correctAnswersInRow: 0,
                wrongAnswersInRow: 0,
                userAnswers: [],
                difficultyLevel: 1 // 0: Easy, 1: Medium, 2: Hard
            },

            async openAssessment(assessmentId) {
                if (!assessmentId) return; // Must provide ID

                // Show Loading
                const assessContainer = document.getElementById('assessment-container');
                assessContainer.style.display = 'block';
                assessContainer.classList.add('active');
                assessContainer.style.opacity = '1';

                // Fetch Data
                try {
                    const response = await fetch(`/api/student/assessment/${assessmentId}/start`);
                    const data = await response.json();

                    if (data.error) throw new Error(data.error);

                    // Map to Internal State
                    this.assessment.questions = data.questions.map(q => ({
                        id: q.id,
                        text: q.question,
                        options: q.options,
                        correct: -1, // Hidden
                        hints: ["Think about the concept.", "Review your notes.", "Read the question carefully."], // Generic hints if not in DB
                        difficulty: "Medium",
                        topic: "General"
                    }));

                    this.assessment.timeRemaining = (data.duration || 30) * 60;
                    this.assessment.id = data.assessmentId;
                    this.assessment.title = data.title;

                    // Update Intro Screen Text
                    const introTitle = document.querySelector('#assess-intro h2');
                    const introMeta = document.querySelector('#assess-intro .assess-meta');
                    if (introTitle) introTitle.textContent = data.title;
                    if (introMeta) introMeta.textContent = `${this.assessment.questions.length} Questions • ${data.duration} Mins`;

                } catch (e) {
                    alert("Failed to load assessment: " + e.message);
                    this.closeAssessment();
                    return;
                }

                this.navTo('assessment');
                this.switchScreen('assess-intro');
            },


            closeAssessment() {
                const assessContainer = document.getElementById('assessment-container');
                document.body.style.overflow = 'auto'; // Unlock scroll

                assessContainer.classList.remove('active');
                assessContainer.style.opacity = '0';

                setTimeout(() => {
                    assessContainer.style.display = 'none';
                    this.navTo('home');

                    if (this.assessment.timer) {
                        clearInterval(this.assessment.timer);
                        this.assessment.timer = null;
                    }
                }, 400);
            },


            switchScreen(id) {
                const subScreens = document.querySelectorAll('#assessment-container .screen');
                subScreens.forEach(s => {
                    s.classList.remove('active');
                    s.style.display = 'none';
                });

                const target = document.getElementById(id);
                if (target) {
                    target.style.display = 'block';
                    setTimeout(() => {
                        target.classList.add('active');
                    }, 10);
                }
            },

            startQuiz() {
                // Reset State
                this.assessment.currentIdx = 0;
                this.assessment.score = 0;
                this.assessment.streak = 0;
                this.assessment.hintsUsedTotal = 0;
                this.assessment.timeRemaining = 1800;
                this.assessment.startTime = Date.now();
                this.assessment.correctAnswersInRow = 0;
                this.assessment.wrongAnswersInRow = 0;
                this.assessment.userAnswers = [];

                // 1. Lock page scroll during loading
                document.body.style.overflow = 'hidden';

                // 2. Set Controlled Loading State
                const qText = document.getElementById('q-text');
                const qOptions = document.getElementById('q-options');
                const hintSection = document.querySelector('.hint-section');

                if (qText) qText.textContent = "Loading Question...";
                if (qOptions) qOptions.innerHTML = "";
                if (hintSection) hintSection.style.display = 'none'; // Keep hints hidden until visible

                this.switchScreen('assess-quiz');
                this.startTimer();

                // 3. Controlled Loading Phase (1-2s maximum)
                // "User clicks Start Assessment -> Sees brief loading -> Immediately sees Question 1"
                setTimeout(() => {
                    this.renderQuestion();
                }, 1200);

                // 4. Fallback Safety Rule: If question fails to load in 2 seconds
                setTimeout(() => {
                    const currentElem = document.getElementById('q-text');
                    if (currentElem && currentElem.textContent === "Loading Question...") {
                        currentElem.textContent = "Question ready. Please continue.";
                        this.renderQuestion(); // Ensure render happens
                    }
                }, 2200);
            },

            startTimer() {
                const timerDisplay = document.getElementById('timer-display');
                const timerText = document.getElementById('timer-text');

                this.assessment.timer = setInterval(() => {
                    this.assessment.timeRemaining--;

                    const minutes = Math.floor(this.assessment.timeRemaining / 60);
                    const seconds = this.assessment.timeRemaining % 60;
                    if (timerText) timerText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} `;

                    // Warning when less than 5 minutes
                    if (this.assessment.timeRemaining <= 300) {
                        if (timerDisplay) timerDisplay.classList.add('warning');
                    }

                    // Auto-submit when time runs out
                    if (this.assessment.timeRemaining <= 0) {
                        clearInterval(this.assessment.timer);
                        this.finishAssessment();
                    }
                }, 1000);
            },

            renderQuestion() {
                const q = this.assessment.questions[this.assessment.currentIdx];
                const total = this.assessment.questions.length;

                // 5. Unlock page scroll after question appears
                document.body.style.overflow = 'auto';

                // Show Hint Section now that question is visible
                const hintSection = document.querySelector('.hint-section');
                if (hintSection) hintSection.style.display = 'block';

                // Reset per-question state
                this.assessment.currentHintsShown = 0;
                this.assessment.canRetry = true;

                // Update Header
                const elCurrent = document.getElementById('q-current');
                if (elCurrent) elCurrent.textContent = this.assessment.currentIdx + 1;

                const elTotal = document.getElementById('q-total');
                if (elTotal) elTotal.textContent = total;

                const elProgress = document.getElementById('quiz-progress');
                if (elProgress) elProgress.style.width = ((this.assessment.currentIdx) / total) * 100 + "%";

                const elDifficulty = document.getElementById('q-difficulty');
                if (elDifficulty) elDifficulty.textContent = q.difficulty;

                const elStreak = document.getElementById('q-streak');
                if (elStreak) elStreak.textContent = "Streak: " + this.assessment.streak;

                // Text
                const elText = document.getElementById('q-text');
                if (elText) elText.textContent = q.text;

                // Options
                const optContainer = document.getElementById('q-options');
                if (optContainer) {
                    optContainer.innerHTML = "";
                    q.options.forEach((opt, idx) => {
                        const btn = document.createElement('div');
                        btn.className = 'option-btn';
                        btn.innerHTML = `<span>${opt}</span> <span class="option-btn-choice">${["A", "B", "C", "D"][idx] || ""}</span>`;
                        btn.onclick = () => this.checkAnswer(idx, btn);
                        optContainer.appendChild(btn);
                    });
                }

                // Clear hints & Feedback
                const hintArea = document.getElementById('hint-display-area');
                if (hintArea) hintArea.innerHTML = "";

                const feedbackArea = document.getElementById('q-feedback');
                if (feedbackArea) {
                    feedbackArea.classList.add('hidden');
                    feedbackArea.classList.remove('correct', 'wrong');
                }
            },

            useHint() {
                const q = this.assessment.questions[this.assessment.currentIdx];
                if (this.assessment.currentHintsShown >= q.hints.length) return;

                const hintLabels = ["Concept Reminder", "Formula Reference", "Partial Solution"];
                const hintText = q.hints[this.assessment.currentHintsShown];

                const hintBox = document.createElement('div');
                hintBox.className = 'hint-box';
                hintBox.innerHTML = `<strong>${hintLabels[this.assessment.currentHintsShown]}:</strong> ${hintText}`;
                document.getElementById('hint-display-area').appendChild(hintBox);

                this.assessment.currentHintsShown++;
                this.assessment.hintsUsedTotal++;
            },

            checkAnswer(selectedIdx, btnElement) {
                const q = this.assessment.questions[this.assessment.currentIdx];
                const options = document.querySelectorAll('.option-btn');

                // 1. Record Answer
                // Ensure array is filled up to current index
                this.assessment.userAnswers[this.assessment.currentIdx] = selectedIdx;

                // 2. Visual Feedback (Selected State Only)
                options.forEach(o => o.classList.remove('selected', 'correct', 'wrong'));
                btnElement.classList.add('selected');

                // 3. Move Next (Delayed)
                setTimeout(() => this.nextQuestion(), 500);
            },

            nextQuestion() {
                this.assessment.currentIdx++;
                if (this.assessment.currentIdx < this.assessment.questions.length) {
                    this.renderQuestion();
                } else {
                    this.finishAssessment();
                }
            },

            async finishAssessment() {
                if (this.assessment.timer) {
                    clearInterval(this.assessment.timer);
                    this.assessment.timer = null;
                }

                document.body.style.overflow = 'auto'; // Unlock scroll

                // Show Loading / Submitting State
                const assessContainer = document.getElementById('assessment-container');
                assessContainer.innerHTML = '<div class="loading-screen"><h2>Submitting Assessment...</h2><div class="loader"></div></div>'; // Simple loader

                try {
                    // Prepare Payload
                    const answersMap = {};
                    this.assessment.questions.forEach((q, idx) => {
                        const ans = this.assessment.userAnswers[idx];
                        if (ans !== undefined) answersMap[q.id] = ans;
                    });

                    const response = await fetch('/api/student/assessment/submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            assessmentId: this.assessment.id,
                            studentId: 1, // Mock Student ID (In real app, get from session)
                            answers: answersMap
                        })
                    });

                    const result = await response.json();

                    // Render Results in-place or reload page
                    // Ideally, we restore the specific result visualization, 
                    // but for now let's just show the Score Card using the existing result screen if possible,
                    // or re-render it.

                    // Since I overwrote innerHTML above, I need to restore structure or just render result HTML.
                    // For simplicity, I'll alert and reload dashboard.
                    // A better UX is to render the result screen.

                    this.renderAssessmentResult(result);

                } catch (e) {
                    console.error(e);
                    alert("Submission failed. Please try again.");
                    // Restore View?
                    location.reload();
                }
            },

            renderAssessmentResult(result) {
                const container = document.getElementById('assessment-container');
                const percentage = Math.round(result.percentage);

                container.innerHTML = `
                    <div class="screen active" style="display:block; padding: 2rem; text-align: center;">
                        <h2 class="section-header-large">Assessment Complete!</h2>
                        <div class="circular-progress-container" style="margin: 2rem auto;">
                            <div class="circular-progress" style="background: conic-gradient(var(--fluorescent-cyan) ${percentage}%, var(--glass-border) 0%);">
                                <div class="inner-circle">
                                    <span class="score-text">${percentage}%</span>
                                    <span class="score-label">Score</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-xl">You scored ${result.score} out of ${result.total}</p>
                        <div class="margin-top-2">
                             <button class="btn-primary" onclick="app.closeAssessment()">Return to Dashboard</button>
                        </div>
                    </div>
                 `;
            },

            showExplanation() {
                // Placeholder if needed
                alert("Explanations are available in the review section.");
            },

            backToResults() {
                // Placeholder
            },

            switchExplanationMode(mode) {
                // Placeholder
            },

            retryWeakAreas() {
                // Placeholder
            },

            /* --- ROLE SELECTION LOGIC --- */
            selectedRole: null,

            selectRole(role) {
                this.selectedRole = role;

                // Update UI
                document.querySelectorAll('.role-card-item').forEach(el => el.classList.remove('selected'));
                document.getElementById(`role-card-${role}`).classList.add('selected');

                // Enable Button
                const btn = document.getElementById('role-continue-btn');
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            },

            confirmRole() {
                if (!this.selectedRole) return;

                localStorage.setItem('user_role', this.selectedRole);

                // Animate Out
                const roleCard = document.getElementById('role-select-card');
                if (roleCard) {
                    roleCard.style.opacity = '0';
                    roleCard.style.transform = 'translateY(-20px)';
                    roleCard.style.transition = 'all 0.3s ease';

                    setTimeout(() => {
                        roleCard.classList.add('hidden');

                        // Show Back Button
                        const backBtn = document.getElementById('auth-back-btn');
                        if (backBtn) backBtn.classList.add('visible');

                        // CONDITIONAL ROUTING BASED ON ROLE
                        if (this.selectedRole === 'parent') {
                            // SHOW PARENT LOGIN
                            const parentCard = document.getElementById('parent-login-card');
                            if (parentCard) {
                                parentCard.classList.remove('hidden');
                                parentCard.style.opacity = '0';
                                parentCard.style.transform = 'translateY(20px)';
                                parentCard.style.transition = 'all 0.5s ease';

                                requestAnimationFrame(() => {
                                    parentCard.style.opacity = '1';
                                    parentCard.style.transform = 'translateY(0)';
                                });
                            }
                        } else {
                            // SHOW STUDENT OR TEACHER LOGIN
                            const loginCard = document.getElementById('login-card');
                            if (loginCard) {
                                loginCard.classList.remove('hidden');
                                loginCard.dataset.role = this.selectedRole;

                                // Update Login Text & UI Logic
                                const loginTitle = loginCard.querySelector('h2');
                                if (loginTitle) {
                                    if (this.selectedRole === 'student') {
                                        loginTitle.textContent = "Student Portal";
                                    } else {
                                        loginTitle.textContent = "Teacher Portal";
                                    }

                                    // Role Helper Text
                                    const existingBadge = document.getElementById('role-helper-text');
                                    if (existingBadge) existingBadge.remove();

                                    const subHelper = document.createElement('div');
                                    subHelper.id = 'role-helper-text';
                                    subHelper.className = 'role-helper-text';
                                    subHelper.textContent = `Logging in as ${this.selectedRole === 'student' ? 'Student' : 'Teacher'}`;
                                    if (loginTitle.parentNode) loginTitle.parentNode.insertBefore(subHelper, loginTitle.nextSibling);
                                }

                                // Animate In
                                loginCard.style.opacity = '0';
                                loginCard.style.transform = 'translateY(20px)';
                                loginCard.style.transition = 'all 0.5s ease';

                                requestAnimationFrame(() => {
                                    loginCard.style.opacity = '1';
                                    loginCard.style.transform = 'translateY(0)';
                                });
                            }
                        }
                    }, 300);
                }
            },

            backToRoles() {
                const loginCard = document.getElementById('login-card');
                const signupCard = document.getElementById('signup-card');
                const parentLoginCard = document.getElementById('parent-login-card');
                const backBtn = document.getElementById('auth-back-btn');
                let activeCard = null;

                if (loginCard && !loginCard.classList.contains('hidden')) activeCard = loginCard;
                else if (signupCard && !signupCard.classList.contains('hidden')) activeCard = signupCard;
                else if (parentLoginCard && !parentLoginCard.classList.contains('hidden')) activeCard = parentLoginCard;

                // Hide Back Button
                if (backBtn) backBtn.classList.remove('visible');

                if (activeCard) {
                    activeCard.style.opacity = '0';
                    activeCard.style.transform = 'translateY(20px)';
                    activeCard.style.transition = 'all 0.3s ease';

                    setTimeout(() => {
                        activeCard.classList.add('hidden');

                        const roleCard = document.getElementById('role-select-card');
                        if (roleCard) {
                            roleCard.classList.remove('hidden');
                            roleCard.style.opacity = '0';
                            roleCard.style.transform = 'translateY(-20px)';
                            roleCard.style.transition = 'all 0.5s ease';

                            requestAnimationFrame(() => {
                                roleCard.style.opacity = '1';
                                roleCard.style.transform = 'translateY(0)';
                            });
                        }
                    }, 300);
                }
            },

            goToAchievements() {
                this.closeAssessment();
                setTimeout(() => {
                    this.navTo('achievements');
                }, 500);
            },

            toggleProfileDropdown() {
                const dd = document.getElementById('profile-dropdown');
                if (dd) {
                    dd.classList.toggle('active');
                    // Add/Remove click outside listener
                    if (dd.classList.contains('active')) {
                        setTimeout(() => document.addEventListener('click', this.closeProfileDropdownOnClick), 0);
                    } else {
                        document.removeEventListener('click', this.closeProfileDropdownOnClick);
                    }
                }
            },

            closeProfileDropdown() {
                const dd = document.getElementById('profile-dropdown');
                if (dd) {
                    dd.classList.remove('active');
                    document.removeEventListener('click', this.closeProfileDropdownOnClick);
                }
            },

            closeProfileDropdownOnClick(e) {
                const dd = document.getElementById('profile-dropdown');
                const btn = document.querySelector('.header-icon[onclick="app.toggleProfileDropdown()"]'); // Assuming this is your profile icon
                if (dd && !dd.contains(e.target) && (!btn || !btn.contains(e.target))) {
                    app.closeProfileDropdown();
                }
            },

            /* --- TEACHER CLASSES MANAGEMENT --- */
            teacherClassesData: [
                { id: '10-A', name: 'Class 10 - A', subject: 'Science', students: 24, performance: 78, term: 'Term 1' },
                { id: '9-B', name: 'Class 9 - B', subject: 'Physics', students: 18, performance: 92, term: 'Term 1' },
                { id: '10-B', name: 'Class 10 - B', subject: 'Maths', students: 30, performance: 65, term: 'Term 1' }
            ],

            openTeacherClasses() {
                const screen = document.getElementById('teacher-classes-screen');
                if (!screen) {
                    console.error("Critical: Teacher Classes Screen not found.");
                    this.renderDashboard(); // Fallback
                    return;
                }

                // 1. Switch View
                document.querySelectorAll('.screen').forEach(s => {
                    s.style.display = 'none';
                    s.classList.remove('active');
                    s.style.opacity = '0'; // Ensure others hidden
                });

                screen.style.display = 'block';
                screen.style.visibility = 'visible';

                void screen.offsetWidth; // Force Reflow

                screen.classList.add('active');
                screen.style.opacity = '1';

                // 2. Update Sidebar Active State
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                const navItem = document.querySelector('.nav-item[data-label="Classes"]');
                if (navItem) navItem.classList.add('active');

                // 3. Render
                try {
                    this.renderTeacherClasses();
                } catch (e) {
                    console.error("Render Classes Error:", e);
                }
            },

            openTeacherAnalytics() {
                const screen = document.getElementById('teacher-analytics-screen');
                if (!screen) {
                    console.error("Critical: Teacher Analytics Screen not found.");
                    this.renderDashboard(); // Fallback
                    return;
                }

                // 1. Switch View
                document.querySelectorAll('.screen').forEach(s => {
                    s.style.display = 'none';
                    s.classList.remove('active');
                    s.style.opacity = '0'; // Ensure others hidden
                });

                screen.style.display = 'block';
                screen.style.visibility = 'visible';

                void screen.offsetWidth; // Force Reflow

                screen.classList.add('active');
                screen.style.opacity = '1';

                // Trigger Animations safely
                const sections = screen.querySelectorAll('.dashboard-card');
                sections.forEach((s, index) => {
                    s.style.opacity = '0';
                    s.classList.remove('visible');
                    setTimeout(() => {
                        s.classList.add('visible');
                        s.style.opacity = '1';
                    }, index * 100);
                });

                // 2. Update Sidebar Active State
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                const navItem = document.querySelector('.nav-item[data-label="Reports"]');
                if (navItem) navItem.classList.add('active');
            },

            // --- ATTENDANCE MANAGEMENT (Dynamic with History) ---
            attendanceList: [
                { rollNo: "001", name: "Aarav Patel", status: "present" },
                { rollNo: "002", name: "Aditi Sharma", status: "present" },
                { rollNo: "003", name: "Arjun Singh", status: "absent" }
            ],

            // Temporary History Data (Mock Database)
            attendanceHistory: {
                "001": { name: "Aarav Patel", present: 18, absent: 2 },
                "002": { name: "Aditi Sharma", present: 15, absent: 5 },
                "003": { name: "Arjun Singh", present: 10, absent: 10 }
            },

            openTeacherAttendance() {
                const screen = document.getElementById('teacher-attendance-screen');
                if (!screen) {
                    console.error("Critical: Teacher Attendance Screen not found.");
                    this.renderDashboard(); // Fallback
                    return;
                }

                // 1. Switch View
                document.querySelectorAll('.screen').forEach(s => {
                    s.style.display = 'none';
                    s.classList.remove('active');
                    s.style.opacity = '0'; // Ensure others hidden
                });

                screen.style.display = 'block';
                screen.style.visibility = 'visible';

                void screen.offsetWidth; // Force Reflow

                screen.classList.add('active');
                screen.style.opacity = '1';

                // Trigger Animations safely
                const sections = screen.querySelectorAll('.dashboard-card');
                sections.forEach((s, index) => {
                    s.style.opacity = '0';
                    s.classList.remove('visible');
                    setTimeout(() => {
                        s.classList.add('visible');
                        s.style.opacity = '1';
                    }, index * 100);
                });

                // 2. Update Sidebar Active State
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                const navItem = document.querySelector('.nav-item[data-label="Attendance"]');
                if (navItem) navItem.classList.add('active');

                // 3. Render Table
                this.renderAttendanceList();
            },

            addStudent() {
                const rollNo = document.getElementById("rollNoInput").value.trim();
                const name = document.getElementById("studentNameInput").value.trim();

                if (!rollNo || !name) {
                    alert("Please enter roll number and name");
                    return;
                }

                // Prevent duplicates
                if (this.attendanceList.some(s => s.rollNo === rollNo)) {
                    alert("Roll number already exists");
                    return;
                }

                this.attendanceList.push({
                    rollNo,
                    name,
                    status: "present" // default
                });

                // Initialize History if not exists
                if (!this.attendanceHistory[rollNo]) {
                    this.attendanceHistory[rollNo] = { name: name, present: 0, absent: 0 };
                }

                document.getElementById("rollNoInput").value = "";
                document.getElementById("studentNameInput").value = "";

                this.renderAttendanceList();
            },

            renderAttendanceList() {
                const tbody = document.getElementById("attendanceTableBody");
                if (!tbody) return;
                tbody.innerHTML = "";

                this.attendanceList.forEach((student, index) => {
                    const row = document.createElement("tr");
                    row.className = "tr-hoverable";

                    row.innerHTML = `
                        <td class="td-cell">${student.rollNo}</td>
                        <td class="td-cell student-name" onclick="app.showAttendanceReport('${student.rollNo}')">
                            ${student.name}
                        </td>
                        <td class="td-cell-center">
                            <button class="status-btn ${student.status}"
                                onclick="app.toggleStatus(${index})">
                                ${student.status === "present" ? "Present" : "Absent"}
                            </button>
                        </td>
                        <td class="td-cell-center">
                            <button class="remove-btn" onclick="app.removeStudent(${index})">✖</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },

            toggleStatus(index) {
                const student = this.attendanceList[index];

                // Toggle Logic (UI State)
                student.status = student.status === "present" ? "absent" : "present";

                // Update History (Optimistic Update)
                /*
                const hist = this.attendanceHistory[student.rollNo];
                if (hist) {
                    if (student.status === 'present') {
                         hist.present++; hist.absent--;
                    } else {
                         hist.absent++; hist.present--;
                    }
                }
                */
                // Note: Real update happens on Save. For now just toggle UI.

                this.renderAttendanceList();
            },

            removeStudent(index) {
                if (!confirm("Remove this student?")) return;

                this.attendanceList.splice(index, 1);
                this.renderAttendanceList();
            },

            saveAttendance() {
                console.log({
                    class: "10-A",
                    subject: "Physics",
                    date: new Date().toISOString().split("T")[0],
                    attendance: this.attendanceList
                });

                alert("Attendance saved successfully ✅");
            },

            /* --- ATTENDANCE REPORT LOGIC --- */
            calculatePercentage(present, absent) {
                const total = present + absent;
                return total === 0 ? 0 : Math.round((present / total) * 100);
            },

            showAttendanceReport(rollNo) {
                const data = this.attendanceHistory[rollNo];
                if (!data) return alert("No attendance data found for this student (New admission?).");

                const total = data.present + data.absent;
                const percent = this.calculatePercentage(data.present, data.absent);

                // Update UI
                const nameEl = document.getElementById("reportStudentName");
                if (nameEl) nameEl.textContent = data.name;

                const totalEl = document.getElementById("totalDays");
                if (totalEl) totalEl.textContent = total;

                const presentEl = document.getElementById("presentDays");
                if (presentEl) presentEl.textContent = data.present;

                const absentEl = document.getElementById("absentDays");
                if (absentEl) absentEl.textContent = data.absent;

                const percentEl = document.getElementById("attendancePercent");
                if (percentEl) percentEl.textContent = percent + "%";

                // Progress Bar
                const bar = document.getElementById("attendanceProgress");
                if (bar) {
                    bar.style.width = percent + "%";
                    // Color coding
                    if (percent >= 75) bar.style.background = "#00d084";
                    else if (percent >= 50) bar.style.background = "#ffb020";
                    else bar.style.background = "#ff4d4d";
                }

                // Show Modal
                const modal = document.getElementById("attendanceModal");
                if (modal) {
                    modal.classList.add("active");
                }
            },

            closeAttendanceModal() {
                const modal = document.getElementById("attendanceModal");
                if (modal) {
                    modal.classList.remove("active");
                }
            },

            renderTeacherClasses() {
                const grid = document.getElementById('tc-class-grid');
                if (!grid) return;

                const filterClass = document.getElementById('tc-filter-class').value;
                const filterSubject = document.getElementById('tc-filter-subject').value;

                let classes = this.data.teacherClassesData;

                // Apply Filters
                if (filterClass !== 'all') {
                    classes = classes.filter(c => c.name.includes(filterClass));
                }
                if (filterSubject !== 'all') {
                    classes = classes.filter(c => c.subject === filterSubject);
                }

                if (!classes || classes.length === 0) {
                    this.renderEmptyState('tc-class-grid', "No classes found matching filters");
                    document.getElementById('tc-class-grid').style.display = 'grid'; // Ensure visible container
                    document.getElementById('tc-class-detail-view').classList.add('hidden');
                    return;
                }

                grid.innerHTML = classes.map(c => `
                    <div class="class-card" onclick="app.openClassDetail('${c.id}')">
                         <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div style="font-weight:700; color:white; margin-bottom:0.2rem; font-size: 1.1rem;">${c.name}</div>
                                <div style="font-size:0.85rem; color:var(--lavender-main);">${c.term} • ${c.subject}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 8px; font-size: 0.8rem;">
                                ${c.students} 👤
                            </div>
                        </div>
                        <div style="margin-top: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.4rem;">
                                <span>Avg Performance</span>
                                <span style="color: white;">${c.performance}%</span>
                            </div>
                            <div style="background:rgba(255,255,255,0.05); height:6px; border-radius:4px; overflow:hidden;">
                                <div style="background:${c.performance >= 80 ? '#10b981' : (c.performance >= 60 ? '#fbbf24' : '#ef4444')}; width:${c.performance}%; height:100%;"></div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; text-align: right; font-size: 0.8rem; color: var(--lavender-light);">
                            Click to manage →
                        </div>
                    </div>
                `).join('');

                // Ensure Grid is visible, Detail hidden
                document.getElementById('tc-class-grid').style.display = 'grid';
                document.getElementById('tc-class-detail-view').classList.add('hidden');
            },

            openClassDetail(id) {
                const cls = this.data.teacherClassesData.find(c => c.id == id);
                if (!cls) return;

                // Hide Grid, Show Detail
                document.getElementById('tc-class-grid').style.display = 'none';
                document.getElementById('tc-class-detail-view').classList.remove('hidden');

                // Set Title
                document.getElementById('tc-detail-title').textContent = `${cls.name} - ${cls.subject}`;

                // Default Tab
                this.switchClassTab('students');
            },

            closeClassDetail() {
                document.getElementById('tc-class-detail-view').classList.add('hidden');
                document.getElementById('tc-class-grid').style.display = 'grid';
            },

            switchClassTab(tab) {
                // Update UI tabs
                document.querySelectorAll('.tc-tab').forEach(t => t.classList.remove('active'));
                const activeTab = Array.from(document.querySelectorAll('.tc-tab')).find(t => t.textContent.toLowerCase().includes(tab.includes('skill') ? 'skill' : tab));
                if (activeTab) activeTab.classList.add('active');

                const content = document.getElementById('tc-tab-content');

                if (tab === 'students') {
                    content.innerHTML = `
                        <table class="table-full-width">
                            <thead>
                                <tr class="tr-header">
                                    <th class="td-pad">Name</th>
                                    <th class="td-pad">Roll No</th>
                                    <th class="td-pad">Attendance</th>
                                    <th class="td-pad">Score</th>
                                    <th class="td-pad">Status</th>
                                    <th class="td-pad">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="tr-item">
                                    <td class="td-pad">Arjun Sharma</td>
                                    <td class="td-pad">101</td>
                                    <td class="td-pad">95%</td>
                                    <td class="td-pad">88%</td>
                                    <td class="td-pad"><span class="text-green-span">🟢 Strong</span></td>
                                    <td class="td-pad"><button class="btn-secondary btn-small">View</button></td>
                                </tr>
                                <tr class="tr-item">
                                    <td class="td-pad">Priya Singh</td>
                                    <td class="td-pad">102</td>
                                    <td class="td-pad">82%</td>
                                    <td class="td-pad">65%</td>
                                    <td class="td-pad"><span class="text-yellow-span">🟡 Average</span></td>
                                    <td style="padding: 1rem;"><button class="btn-secondary" style="padding: 4px 8px; font-size: 0.75rem;">View</button></td>
                                </tr>
                                 <tr class="tr-item">
                                    <td class="td-pad">Rahul Verma</td>
                                    <td class="td-pad">103</td>
                                    <td class="td-pad">75%</td>
                                    <td class="td-pad">42%</td>
                                    <td class="td-pad"><span class="text-red-span">🔴 Weak</span></td>
                                    <td style="padding: 1rem;"><button class="btn-secondary" style="padding: 4px 8px; font-size: 0.75rem;">View</button></td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                } else if (tab === 'tests') {
                    content.innerHTML = `
                         <div class="flex-gap-1-mb-1-5">
                            <div class="teacher-action-card width-200">
                                <div class="text-xl">➕</div>
                                <div>Create Weekly Test</div>
                            </div>
                         </div>
                         <h3 class="h3-white-md">Recent Tests</h3>
                         <div class="flex-col-gap-1-mt-1">
                             <div class="test-item-card">
                                <div>
                                    <div class="text-white-bold-600">Weekly Test 3 - Thermodynamics</div>
                                    <div class="text-muted-sm-85">Completed • Avg Score: 72%</div>
                                </div>
                                <button class="btn-secondary">View Analysis</button>
                             </div>
                             <div class="test-item-card">
                                <div>
                                    <div class="text-white-bold-600">Pop Quiz - Formulas</div>
                                    <div class="text-muted-sm-85">Completed • Avg Score: 85%</div>
                                </div>
                                <button class="btn-secondary">View Analysis</button>
                             </div>
                         </div>
                    `;
                } else if (tab === 'performance') {
                    content.innerHTML = `
                         <div class="text-center-p3">
                            <div class="text-3rem-mb1">📊</div>
                            <h3 class="text-white">Performance Analytics</h3>
                            <p class="text-muted">Detailed charts and graphs will be rendered here.</p>
                            <div class="chart-placeholder">
                                [ Chart Placeholder ]
                            </div>
                         </div>
                    `;
                } else if (tab === 'skills') {
                    content.innerHTML = `
                         <div class="grid-2-col-gap-2">
                            <div class="alert-box-red">
                                <h3 class="header-red-gap">🔴 Critical Gaps</h3>
                                <ul class="list-gap">
                                    <li class="li-gap"><strong>Algebra:</strong> Quadratic Equations (45% class struggle)</li>
                                    <li><strong>Physics:</strong> Vector Resolution</li>
                                </ul>
                                <button class="btn-primary btn-red-action">Assign Revision Material</button>
                            </div>
                            <div class="alert-box-yellow">
                                <h3 class="header-yellow-gap">🟡 Needs Improvement</h3>
                                <ul class="list-gap">
                                    <li class="li-gap"><strong>Chemistry:</strong> Periodic Table trends</li>
                                    <li><strong>Biology:</strong> Cell structure diagrams</li>
                                </ul>
                                <button class="btn-secondary btn-mt-1">View Resources</button>
                            </div>
                         </div>
                    `;
                }
            },




            logout() {
                authSystem.logout();
            },

            /* --- PARENT DASHBOARD LOGIC --- */
            loadParentDashboard() {
                // 1. Update Sidebar FIRST (Critical to remove Student/Teacher items like Assessment)
                this.updateSidebar('parent');

                // 2. Hide Auth & Other Screens
                const authContainer = document.getElementById('auth-container');
                if (authContainer) authContainer.style.display = 'none';

                const screens = document.querySelectorAll('.dashboard-workspace > .screen');
                screens.forEach(s => {
                    s.classList.remove('active');
                    s.style.display = 'none';
                });

                const dashContainer = document.getElementById('dashboard-container');
                if (dashContainer) {
                    dashContainer.style.display = 'block';
                    dashContainer.style.opacity = '1';
                }

                // 3. Show Parent Dashboard
                const parentScreen = document.getElementById('parent-dashboard-screen');
                if (parentScreen) {
                    parentScreen.style.display = 'block';
                    setTimeout(() => {
                        parentScreen.classList.add('active');
                        parentScreen.style.opacity = '1';
                    }, 10);
                }

                // 4. Update Header (Safely)
                const studentName = this.data.currentUser?.linked_student?.name || 'Student';
                const headerName = document.getElementById('header-user-name');
                if (headerName) headerName.textContent = `Parent of ${studentName}`;

                const headerGrade = document.getElementById('header-user-grade');
                if (headerGrade) headerGrade.textContent = "Parent Portal";

                // 5. Populate Data
                this.populateParentData();
            },

            populateParentData() {
                // Feature 1: Reports
                const reportList = document.getElementById('parent-reports-list');
                if (reportList) {
                    const reports = [
                        { subject: 'Mathematics', date: 'Oct 15, 2023', teacher: 'Mr. Kapoor', desc: 'Arjun showed great improvement in Algebra. Needs more focus on geometric proofs.', unread: true },
                        { subject: 'Science', date: 'Oct 10, 2023', teacher: 'Mrs. Iyer', desc: 'Excellent performance in the weekly lab test. Very attentive in class.', unread: false },
                        { subject: 'English', date: 'Oct 05, 2023', teacher: 'Ms. David', desc: 'Homework submission was late. Please ensure he manages time better.', unread: false }
                    ];

                    if (!reports || reports.length === 0) {
                        this.renderEmptyState('parent-reports-list', "No new reports from teachers.");
                    } else {
                        reportList.innerHTML = reports.map(r => `
                            <div class="report-item ${r.unread ? 'unread' : ''}" onclick="this.classList.toggle('expanded')">
                                <div class="report-header">
                                    <span class="report-subject">${r.subject}</span>
                                    <span class="report-date">${r.date}</span>
                                </div>
                                <div class="report-desc">${r.desc}</div>
                                <div class="report-teacher">Teacher: ${r.teacher}</div>
                            </div>
                        `).join('');
                    }
                }

                // Feature 4: Missed Topics
                const missedList = document.getElementById('parent-missed-topics');
                if (missedList) {
                    const topics = [
                        { date: 'Oct 16', subject: 'Math', content: 'Pythagoras Theorem applications and proofs.' },
                        { date: 'Oct 16', subject: 'Physics', content: 'Newton’s Third Law detailed explanation.' },
                        { date: 'Oct 15', subject: 'Chemistry', content: 'Intro to Carbon Compounds.' }
                    ];

                    if (!topics || topics.length === 0) {
                        this.renderEmptyState('parent-missed-topics', "Great job! No missed topics.");
                    } else {
                        missedList.innerHTML = topics.map((t, i) => `
                            <div class="accordion-item ${i === 0 ? 'active' : ''}">
                                <div class="accordion-header" onclick="app.toggleAccordion(this)">
                                    <span class="flex-center-gap-05">
                                        <div class="topic-dot"></div>
                                        ${t.subject} - ${t.date}
                                    </span>
                                    <svg class="accordion-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                </div>
                                <div class="accordion-content">
                                    <div class="topic-row">${t.content}</div>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            },

            updateCharCount(textarea) {
                const count = textarea.value.length;
                document.getElementById('char-count').textContent = count;
            },

            sendLeaveReason() {
                const input = document.getElementById('leave-reason-input');
                const reason = input.value.trim();

                if (!reason) {
                    alert("Please enter a reason.");
                    return;
                }

                // Simulate API call
                const btn = event.currentTarget;
                btn.innerHTML = "Sending...";
                btn.disabled = true;

                setTimeout(() => {
                    btn.innerHTML = "Sent Successfully ✓";
                    btn.classList.add('btn-success'); // Assuming a success class or style
                    btn.style.background = "#10b981"; // Fallback green
                    input.value = "";
                    this.updateCharCount(input);

                    setTimeout(() => {
                        btn.innerHTML = "Send to Class Teacher";
                        btn.disabled = false;
                        btn.style.background = ""; // Reset
                    }, 3000);
                }, 1000);
            },

            toggleAccordion(header) {
                const item = header.parentElement;
                item.classList.toggle('active');
            },

            openEditProfile() {
                const modal = document.getElementById('edit-profile-modal');
                if (modal) {
                    modal.classList.add('active');
                    // Pre-fill Logic
                    const user = getLoggedInUser();
                    if (!user) return;

                    const nameInput = document.getElementById("editFullName");
                    if (nameInput) nameInput.value = user.fullName || "";

                    const classInput = document.getElementById("editClass");
                    if (classInput) classInput.value = user.class || "";

                    const bioInput = document.getElementById("editBio");
                    if (bioInput) bioInput.value = user.bio || "";

                    // Pre-select current avatar
                    selectedAvatar = user.avatar || "programmer"; // Default changed

                    // Highlight the selected avatar in the grid
                    // We need to match the key to the DOM element
                    setTimeout(() => {
                        document.querySelectorAll('.avatar-item').forEach(item => {
                            if (item.onclick && item.onclick.toString().includes(selectedAvatar)) {
                                item.classList.add('selected');
                            } else {
                                item.classList.remove('selected');
                            }
                        });
                    }, 0);
                }
            },

            closeEditProfile() {
                const modal = document.getElementById('edit-profile-modal');
                if (modal) modal.classList.remove('active');
            },

            // New Save Logic (Backend Connected)
            // ✅ STEP 3: Save Profile Logic (FIXED)
            saveProfileChanges() {
                const user = getLoggedInUser();
                if (!user) return alert("User not logged in");

                const nameInput = document.getElementById("editFullName");
                // Note: HTML might not have id="editClass", adding checking just in case
                const classInput = document.getElementById("editClass");
                const bioInput = document.getElementById("editBio");

                if (!nameInput) {
                    console.error("Full name input missing");
                    return;
                }

                // Update Local Object
                user.fullName = nameInput.value.trim() || user.fullName;
                if (classInput) user.class = classInput.value.trim() || user.class;
                user.bio = bioInput.value.trim() || user.bio;
                user.avatar = selectedAvatar || user.avatar || "programmer"; // 🔥 KEY FIX

                // ✅ Save updated user globally
                setLoggedInUser(user);

                // Optional: Update Backend
                const payload = {
                    fullName: user.fullName,
                    bio: user.bio,
                    avatar: user.avatar
                };

                // Fire and forget backend update or await it? 
                // User said "Update backend (optional), Update localStorage, Re-render".
                // We will try to update backend but proceed to render immediately for UI speed.
                const token = localStorage.getItem("token");
                if (token) {
                    fetch(`/api/user/update-profile`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${token}`
                        },
                        body: JSON.stringify(payload)
                    }).catch(e => console.error("Backend sync failed", e));
                }

                // ✅ Re-render everything
                renderUserUI(user);

                alert("Profile updated successfully ✅");
                this.closeEditProfile();
            },

            /* --- TEACHER ASSESSMENT LOGIC --- */
            openTeacherAssessment() {
                const landing = document.getElementById('teacher-assessment-landing');
                if (!landing) {
                    console.error("Critical: Teacher Assessment Landing Screen not found.");
                    this.renderDashboard(); // Fallback
                    return;
                }

                // 1. Hide Dashboard & Other Screens
                const screens = document.querySelectorAll('.dashboard-workspace > .screen, .screen');
                screens.forEach(s => {
                    s.classList.remove('active');
                    s.style.display = 'none';
                    s.style.opacity = '0'; // Ensure others are hidden
                });

                // 2. Show Landing
                landing.style.display = 'block';
                landing.style.visibility = 'visible';

                // Force Reflow
                void landing.offsetWidth;

                // 3. Update Active State
                landing.classList.add('active');
                landing.style.opacity = '1';

                // 4. Update Sidebar Active State
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                const navItem = document.querySelector('.nav-item[data-label="Assessment"]');
                if (navItem) navItem.classList.add('active');
            },

            openSubjectAssessments(subject) {
                // Hide Landing
                document.getElementById('teacher-assessment-landing').style.display = 'none';
                // Show List
                const listScreen = document.getElementById('teacher-assessment-subject-list');
                listScreen.style.display = 'block';

                // Force visibility
                void listScreen.offsetWidth;
                listScreen.classList.add('active');
                listScreen.style.opacity = '1';

                // Dynamic Title
                document.getElementById('subject-list-title').textContent = `${subject} – Assessments`;
            },

            openCreateAssessment() {
                // Hide all assess screens
                document.getElementById('teacher-assessment-landing').style.display = 'none';
                const listScreen = document.getElementById('teacher-assessment-subject-list');
                if (listScreen) listScreen.style.display = 'none';

                // Show Create
                const createScreen = document.getElementById('teacher-assessment-create');
                createScreen.style.display = 'block';

                // Force visibility
                void createScreen.offsetWidth;
                createScreen.classList.add('active');
                createScreen.style.opacity = '1';

                // Reset Form
                const container = document.getElementById('questions-container');
                if (container) container.innerHTML = '';
                const count = document.getElementById('question-count');
                if (count) count.textContent = '0 Questions Added';
            },

            addQuestion() {
                const container = document.getElementById('questions-container');
                if (!container) return;
                this.renderQuestionCard(container, null);

                const count = container.children.length;
                const countEl = document.getElementById('question-count');
                if (countEl) countEl.textContent = `${count} Questions Added`;
            },

            deleteQuestion(btn) {
                btn.closest('.question-card').remove();
                const container = document.getElementById('questions-container');
                const countEl = document.getElementById('question-count');
                if (container && countEl) countEl.textContent = `${container.children.length} Questions Added`;
            },

            async autoAdd30MCQs() {
                // Step 1: Validate Inputs
                const subject = document.getElementById('assess-subject').value;
                const classVal = document.getElementById('assess-class').value;

                if (!subject || !classVal) {
                    alert("Please select a Subject and Class first.");
                    return;
                }

                const btn = event.currentTarget || document.activeElement;
                const originalText = btn.innerHTML;
                btn.innerHTML = '⏳ Adding...';
                btn.disabled = true;

                try {
                    const targetClass = classVal.replace(/\D/g, '') || '10';

                    // Real Backend Fetch
                    const response = await fetch(`/api/teacher/questions?subject=${encodeURIComponent(subject)}&class=${targetClass}&limit=30`);
                    const result = await response.json();

                    if (!result.success || !result.questions || result.questions.length === 0) {
                        alert("No questions found for this criteria in the Question Bank.");
                        throw new Error("No questions found");
                    }

                    const questions = result.questions.map(q => ({
                        // Map DB columns to Frontend expected format
                        text: q.question,
                        options: [q.option_a, q.option_b, q.option_c, q.option_d],
                        correctAnswer: q.correct_index,
                        id: q.id
                    }));

                    if (questions.length < 30) {
                        // Optional: alert user if fewer than requested
                        // console.log(`Note: Only ${questions.length} questions returned.`);
                    }

                    // Step 4: Frontend Rendering
                    const container = document.getElementById('questions-container');

                    questions.forEach(q => {
                        this.renderQuestionCard(container, q);
                    });

                    // Update Count
                    const countEl = document.getElementById('question-count');
                    if (countEl) countEl.textContent = `${container.children.length} Questions Added`;

                } catch (e) {
                    console.error(e);
                    alert("Failed to fetch questions. Please check if the backend is running and data exists.");
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            },

            renderQuestionCard(container, data = null) {
                const count = container.children.length + 1;
                const qDiv = document.createElement('div');
                qDiv.className = 'question-card';
                // Store ID for publishing
                if (data && data.id) qDiv.setAttribute('data-id', data.id);

                const qText = data ? data.text : '';
                const optA = data ? data.options[0] : '';
                const optB = data ? data.options[1] : '';
                const optC = data ? data.options[2] : '';
                const optD = data ? data.options[3] : '';

                qDiv.innerHTML = `
                    <div class="q-header">
                        <span class="q-number">Q${count}</span>
                        <div class="q-actions">
                            <button class="icon-btn" onclick="this.closest('.question-card').remove(); app.updateQuestionCount();">🗑️</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Question Text</label>
                        <textarea class="form-input" rows="2" placeholder="e.g., What is the capital of France?">${qText}</textarea>
                    </div>
                    <div class="options-grid">
                        <div class="option-row">
                            <input type="radio" name="q${count}" class="option-radio" ${data && data.correctAnswer === 0 ? 'checked' : ''}>
                            <input type="text" class="input-modern" placeholder="Option A" value="${optA}">
                        </div>
                        <div class="option-row">
                            <input type="radio" name="q${count}" class="option-radio" ${data && data.correctAnswer === 1 ? 'checked' : ''}>
                            <input type="text" class="input-modern" placeholder="Option B" value="${optB}">
                        </div>
                        <div class="option-row">
                            <input type="radio" name="q${count}" class="option-radio" ${data && data.correctAnswer === 2 ? 'checked' : ''}>
                            <input type="text" class="input-modern" placeholder="Option C" value="${optC}">
                        </div>
                        <div class="option-row">
                            <input type="radio" name="q${count}" class="option-radio" ${data && data.correctAnswer === 3 ? 'checked' : ''}>
                            <input type="text" class="input-modern" placeholder="Option D" value="${optD}">
                        </div>
                    </div>
                `;
                container.appendChild(qDiv);
            },

            updateQuestionCount() {
                const container = document.getElementById('questions-container');
                const countEl = document.getElementById('question-count');
                if (countEl && container) countEl.textContent = `${container.children.length} Questions Added`;
            },

            async askTeacherAI() {
                const input = document.getElementById('teacher-ai-input');
                const responseDiv = document.getElementById('teacher-ai-response');
                const query = input.value.trim();

                if (!query) return;

                // UI Updates
                responseDiv.style.display = 'block';
                responseDiv.innerHTML = 'Thinking... <span class="animate-pulse">🤖</span>';

                try {
                    const response = await fetch('/api/modulator/rag', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ question: query })
                    });

                    const data = await response.json();

                    if (data.answer) {
                        // Simple formatting
                        responseDiv.innerHTML = `<strong>AI:</strong> ${data.answer.replace(/\n/g, '<br>')}`;
                    } else {
                        responseDiv.textContent = "Error: " + (data.message || "Failed to get response");
                    }
                } catch (e) {
                    console.error("AI Error:", e);
                    responseDiv.textContent = "Connection Error. Please try again.";
                }
            },

            currentAssessmentId: null,

            async saveDraft(event) {
                if (event) event.preventDefault();

                const title = document.getElementById('assess-title').value;
                const subject = document.getElementById('assess-subject').value;
                const classVal = document.getElementById('assess-class').value;
                const duration = document.getElementById('assess-duration').value || 30;

                if (!title || !subject || !classVal) {
                    alert("Please at least fill title, subject, and class to save draft.");
                    return;
                }

                // Get Questions
                const container = document.getElementById('questions-container');
                const cards = container.querySelectorAll('.question-card');
                const questionIds = [];
                cards.forEach(card => {
                    const id = card.getAttribute('data-id');
                    if (id) questionIds.push(parseInt(id));
                });

                const btn = event ? event.target : null;
                const originalText = btn ? btn.innerText : 'Save Draft';
                if (btn) { btn.innerText = "Saving..."; btn.disabled = true; }

                try {
                    const response = await fetch('/api/teacher/assessments/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title, subject, class: classVal, duration, questions: questionIds, status: 'DRAFT'
                        })
                    });
                    const result = await response.json();

                    if (result.success) {
                        this.currentAssessmentId = result.assessmentId;
                        alert("Draft Saved Successfully! ID: " + this.currentAssessmentId);
                    } else {
                        throw new Error(result.error);
                    }
                } catch (e) {
                    console.error(e);
                    alert("Failed to save draft");
                } finally {
                    if (btn) { btn.innerText = originalText; btn.disabled = false; }
                }
            },

            resetCreateAssessmentUI() {
                // Reset basic details
                document.getElementById("assess-title").value = "";
                document.getElementById("assess-subject").selectedIndex = 0;
                document.getElementById("assess-class").selectedIndex = 0;
                document.getElementById("assess-date").value = "";
                document.getElementById("assess-start").value = "";
                document.getElementById("assess-end").value = "";

                // Clear questions section
                document.getElementById("questions-container").innerHTML = "";

                // Reset state variables
                this.currentAssessmentId = null;

                // Reset counters
                const qCount = document.getElementById("question-count");
                if (qCount) qCount.innerText = "0 Questions Added";

                // Reset Badge if visible
                const statusBadge = document.getElementById("assessmentStatus");
                if (statusBadge) statusBadge.classList.add("hidden");
            },

            async saveAssessment(event) {
                if (event) event.preventDefault();
                console.log("Publish clicked...");

                const title = document.getElementById('assess-title')?.value;
                const subject = document.getElementById('assess-subject')?.value;
                const classVal = document.getElementById('assess-class')?.value;
                const dateVal = document.getElementById('assess-date')?.value;
                const startTime = document.getElementById('assess-start')?.value;
                const endTime = document.getElementById('assess-end')?.value; // Correct IDs from HTML

                // Safe duration access (if element exists) or default
                const durationEl = document.getElementById('assess-duration');
                const duration = durationEl ? durationEl.value : 30;

                if (!title || !subject || !classVal || !dateVal || !startTime || !endTime) {
                    alert("Please fill all assessment details: Title, Subject, Class, Date, Start Time, and End Time.");
                    return;
                }

                // Gather Questions
                const container = document.getElementById('questions-container');
                const cards = container.querySelectorAll('.question-card');
                const questionIds = [];

                cards.forEach(card => {
                    const id = card.getAttribute('data-id');
                    if (id) questionIds.push(parseInt(id));
                });

                // Validation Logger (DEBUG)
                console.log("Validation Check:", {
                    title,
                    subject,
                    classVal,
                    duration,
                    questionsCount: questionIds.length,
                    hasQuestions: questionIds.length > 0
                });

                if (questionIds.length === 0) {
                    alert("Please add at least one question (using 'Auto-Add' or Manual) that comes from the Question Bank.");
                    return;
                }

                const btn = document.querySelector('.btn-publish-action'); // Publish button
                const originalText = btn ? btn.textContent : 'Publish';
                if (btn) { btn.textContent = 'Publishing...'; btn.disabled = true; }

                // Payload Debug
                console.log("Publishing payload:", {
                    title,
                    subject,
                    class: classVal,
                    date: dateVal,
                    startTime,
                    endTime,
                    duration,
                    questions: questionIds,
                    status: 'PUBLISHED'
                });

                try {
                    let result;

                    if (this.currentAssessmentId) {
                        // ARCHITECTURE FIX: Update existing draft
                        const response = await fetch('/api/teacher/assessments/publish', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ assessmentId: this.currentAssessmentId })
                        });
                        result = await response.json();
                    } else {
                        // Create and Publish directly
                        const response = await fetch('/api/teacher/assessments/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                title,
                                subject,
                                // Normalize Class: "Class 10 - A" -> "10A"
                                class: classVal ? classVal.replace(/Class/i, '').replace(/[^0-9A-Z]/gi, '') : '10A',
                                date: dateVal,
                                startTime,
                                endTime,
                                duration,
                                questions: questionIds,
                                status: 'published'
                            })
                        });
                        result = await response.json();
                    }

                    if (result.success) {
                        alert('Assessment Published Successfully!');
                        // this.resetCreateAssessmentUI(); // Keep data to show status

                        // --- SHOW STATUS LOGIC (Requested Fix) ---
                        const now = new Date();

                        // Parse inputs for comparison ONLY (Display is raw)
                        const sDate = new Date(`${dateVal}T${startTime}`);
                        const eDate = new Date(`${dateVal}T${endTime}`);

                        let statusLabel = "🔵 Scheduled";

                        if (now >= sDate && now <= eDate) {
                            statusLabel = "🟢 Live";
                        } else if (now > eDate) {
                            statusLabel = "⚫ Completed";
                        } else {
                            statusLabel = "🔵 Scheduled";
                        }

                        // Update UI
                        const statusBox = document.getElementById("assessmentStatusBox");
                        const statusText = document.getElementById("assessmentStatusText");
                        const scheduleText = document.getElementById("assessmentScheduleText");

                        if (statusBox && statusText && scheduleText) {
                            statusBox.classList.remove("hidden");
                            statusText.innerText = `Assessment Status: ${statusLabel}`;
                            scheduleText.innerText = `Schedule: ${dateVal} | ${startTime} – ${endTime}`;
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (e) {
                    console.error(e);
                    alert("Failed to publish assessment: " + e.message);
                } finally {
                    if (btn) { btn.textContent = originalText; btn.disabled = false; }
                }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Theme Check
                if (localStorage.getItem('theme') === 'indigo') {
                    document.body.classList.add('theme-indigo');
                }

                // Explicit Button Binding
                const publishBtn = document.getElementById("publishAssessmentBtn");
                if (publishBtn) {
                    publishBtn.addEventListener("click", (e) => app.saveAssessment(e));
                } else {
                    console.error("Publish button not found in DOM");
                }

                // Role Check
                const savedRole = localStorage.getItem('user_role');
                if (savedRole && savedRole !== 'null') {
                    const roleCard = document.getElementById('role-select-card');
                    if (roleCard) roleCard.classList.add('hidden');

                    const loginCard = document.getElementById('login-card');
                    if (loginCard) {
                        loginCard.classList.remove('hidden');
                        // Ensure back button is visible on auto-load
                        const backBtn = document.getElementById('auth-back-btn');
                        if (backBtn) backBtn.classList.add('visible');

                        const loginTitle = loginCard.querySelector('h2');
                        if (loginTitle) {
                            loginTitle.textContent = (savedRole === 'student') ? "Student Portal" : "Teacher Portal";

                            // Add Badge
                            const existingBadge = document.getElementById('role-helper-text');
                            if (!existingBadge) {
                                const subHelper = document.createElement('div');
                                subHelper.id = 'role-helper-text';
                                subHelper.style.color = 'var(--lavender-main)';
                                subHelper.style.fontSize = '0.9rem';
                                subHelper.style.marginBottom = '1rem';
                                subHelper.textContent = `Logging in as ${savedRole === 'student' ? 'Student' : 'Teacher'}`;
                                if (loginTitle.parentNode) loginTitle.parentNode.insertBefore(subHelper, loginTitle.nextSibling);
                            }
                        }
                    }
                }

                app.init();

                // Check if user has opened Help before
                const helpOpened = localStorage.getItem('help_visited');
                const helpIcon = document.querySelector('.nav-item[data-label="Help & Support"]');

                if (helpOpened === 'true' && helpIcon) {
                    // User has already opened help, remove notification dot
                    helpIcon.classList.remove('has-notification');
                }
            } catch (e) {
                console.warn("Initial state suppressed for stability.");
            }
        });

        // 🔧 FIX 1 — FETCH LOGIC (ONLY ONCE)
        // ✅ FIX: Normalized Class Extraction
        function getStudentClassCode() {
            const user = getLoggedInUser();
            if (!user || !user.class) return null;

            // Normalize: "Class 10 - A" -> "10A"
            const match = user.class.match(/(\d+)\s*-?\s*([A-Z])/i);
            return match ? `${match[1]}${match[2].toUpperCase()}` : null;
        }

        // 🔧 FIX 1 — FETCH LOGIC (ONLY ONCE)
        function fetchAssessments() {
            const studentClass = getStudentClassCode();

            if (!studentClass) {
                // console.warn("Student class missing/invalid, skipping fetch");
                return;
            }

            const user = getLoggedInUser();
            // Only fetch if role is student (Safe check)
            if (user && user.role !== 'student') return;

            console.log("Student class used for fetch:", studentClass);

            fetch(`/api/student/assessments?class=${encodeURIComponent(studentClass)}`, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem("token")}`
                }
            })
                .then(res => res.json())
                .then(data => {
                    console.log("Student assessments loaded:", data.length);
                    app.renderAssessments(data);
                })
                .catch(err => {
                    console.error("Assessment fetch failed", err);
                });
        }

        window.addEventListener("load", fetchAssessments);

        // EXPOSE APP GLOBALLY TO FIX ONCLICK ISSUES
        window.app = app;

        // Populate specific profile details when loaded
        function populateProfileHeatmap(rangeVal) {
            const grid = document.getElementById('profile-heatmap');
            if (!grid) return;

            grid.innerHTML = '';
            const days = parseInt(rangeVal) || 30;

            // Adjust grid columns based on range for better UI
            // 7 days = 7 cols (Standard)
            // 30 days = 7 cols (Calendar view)
            // 90 days = 14 cols or condensed? Let's stick to 7 cols calendar view for all, just more rows.
            // Actually, prompt asked for "GitHub contribution heatmap" style (Cols = Days, Rows = Weeks ?? No, usually Cols=Weeks)
            // But prompt clarified: "Columns = Days, Rows = Weeks" -> Calendar style.

            const today = new Date();
            const fragment = document.createDocumentFragment();

            // Generate data going BACKWARDS from today
            // We need to render it chronologically usually? 
            // Better: Start date = Today - days. Iterate forward.

            const startDate = new Date();
            startDate.setDate(today.getDate() - days + 1);

            let totalActivity = 0;
            let activeDays = 0;
            let currentStreak = 0;
            let bestStreak = 0;
            let tempStreak = 0;

            for (let i = 0; i < days; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);

                const box = document.createElement('div');
                box.className = 'hm-cell';

                // Mock Activity Logic
                // Weekend (Sat/Sun) more activity? Or less? Prompt says "You learn best on weekends".
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                let intensity = 0;

                // Random base
                const seed = Math.random();
                if (isWeekend) {
                    // Higher chance of high intensity
                    if (seed > 0.3) intensity = Math.floor(Math.random() * 3) + 2; // 2,3,4
                    else intensity = Math.floor(Math.random() * 2); // 0,1
                } else {
                    // Weekdays
                    if (seed > 0.5) intensity = Math.floor(Math.random() * 4) + 1; // 1,2,3,4
                    else intensity = 0;
                }

                // Force today to be active
                if (i === days - 1) intensity = 4;

                box.classList.add(`hm-level-${intensity}`);

                // Interaction: Tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'hm-tooltip';
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const mins = intensity * 25 + Math.floor(Math.random() * 15);

                if (intensity === 0) {
                    tooltip.innerHTML = `<strong>${dateStr}</strong><br>No activity`;
                } else {
                    tooltip.innerHTML = `<strong>${dateStr}</strong><br>${mins} mins<br>${intensity} Assessments`;
                    totalActivity += mins;
                    activeDays++;
                    tempStreak++;
                }

                // Interaction: Click Modal
                box.onclick = () => {
                    const modal = document.getElementById('hm-detail-modal');
                    if (modal) {
                        modal.style.display = 'flex';
                        document.getElementById('hm-modal-date').textContent = dateStr;
                        document.getElementById('hm-modal-time').textContent = (intensity === 0 ? "0m" : mins + "m");
                        document.getElementById('hm-modal-assess').textContent = intensity;
                        const streakEl = document.getElementById('hm-modal-streak');
                        if (streakEl) {
                            if (intensity > 0) {
                                streakEl.textContent = "Active 🔥";
                                streakEl.style.color = "#10b981";
                            } else {
                                streakEl.textContent = "Inactive";
                                streakEl.style.color = "#ef4444";
                            }
                        }
                    }
                };

                if (intensity === 0) {
                    if (tempStreak > bestStreak) bestStreak = tempStreak;
                    tempStreak = 0;
                }

                box.appendChild(tooltip);

                // If it's a new week (Monday), maybe add a spacer or break if using flex? 
                // Using Grid 7 cols automatically handles wrapping if we start correctly.
                // To align days correctly (e.g. if start date is Wednesday, we need 3 empty slots?)
                // For simplicity in this demo, we just fill the grid flat. 
                // If we want true calendar alignment, we'd need empty fillers.

                fragment.appendChild(box);
            }

            // Append
            grid.appendChild(fragment);

            // Update Insights based on Data
            const insightText = document.getElementById('hm-insight-text');
            if (insightText) {
                if (days === 7) insightText.textContent = "Great focus over the last week! Keep the momentum.";
                else if (days === 90) insightText.textContent = "Long-term consistency is key. You're building a strong habit.";
                else insightText.textContent = "You learn significantly better on weekends. Try to maintain this pace on Mondays.";
            }

            // Update an AI Badge specific to Heatmap
            const badge = document.getElementById('hm-ai-badge');
            if (badge) {
                if (activeDays > days * 0.7) badge.textContent = "AI Insight: Highly Consistent!";
                else if (activeDays > days * 0.4) badge.textContent = "AI Insight: Good Progress";
                else badge.textContent = "AI Insight: Needs more focus";
            }
        }

        /* --- GLOBAL AVATAR LOGIC --- */
        // --- GLOBAL INITIALIZATION ---

        // Remove old global vars/funcs duplicated above
        // Kept for reference but cleaned up

        // This is where selectAvatar logic resides for the onclicks
        // We need to keep 'selectedAvatar' and 'selectAvatar' here or above.
        // I'll keep them here to ensure global scope for onclick attributes in HTML

        // ✅ STEP 6: Avatar Selection Logic
        // Note: selectedAvatar is declared at top if I moved helper function. 
        // But since I replaced the top block with helpers, I should check if I declared it there.
        // I did NOT declare 'selectedAvatar' in the top replacement chunk.
        // So I must declare it here.

        let selectedAvatar = null;

        function selectAvatar(key) {
            selectedAvatar = key;

            // Updated Selection UI
            document.querySelectorAll(".avatar-item").forEach(item => {
                // Try to match key
                // The onclick is `selectAvatar('programmer')`
                // We can just check the onclick attribute string or add data attributes.
                // For now, rely on click event target if available
                item.classList.remove("selected");
            });

            if (event && event.currentTarget) {
                event.currentTarget.classList.add("selected");
            } else {
                // Programmatic selection (e.g. on load)
                // Need to find element by key
                // Matches: onclick="selectAvatar('key')"
                // This is a bit hacky but works without changing HTML structure massively
                document.querySelectorAll(".avatar-item").forEach(item => {
                    if (item.getAttribute('onclick').includes(`'${key}'`)) {
                        item.classList.add('selected');
                    }
                });
            }
        }

        // Global refresh
        function refreshUserUI() {
            const user = getLoggedInUser();
            if (user) renderUserUI(user);
        }

        // Call this on page load to sync UI
        document.addEventListener('DOMContentLoaded', () => {
            refreshUserUI();
        });

        // -------------------------------------------------------------------------
        // ✅ FINAL FIX: Assessment Start Logic (Injected by Antigravity)
        // -------------------------------------------------------------------------

        // 1. Global Start Function for onclick
        window.startAssessment = function (assessmentId) {
            if (!assessmentId) return alert("Error: Assessment ID missing");
            console.log("Starting assessment:", assessmentId);
            localStorage.setItem("activeAssessmentId", assessmentId);
            window.location.href = `/student_exam.html?id=${assessmentId}`;
        };

        // 2. Ensure Render Logic Exists and links correctly
        app.renderAssessments = function (list) {
            const container = document.getElementById('assessments-list');
            if (!container) return; // Might be on a different page view? No, this ID should exist in DOM if parsed.

            if (!list || list.length === 0) {
                container.innerHTML = '<div style="padding:1rem; opacity:0.6;">No pending assessments found.</div>';
                return;
            }

            container.innerHTML = list.map(a => {
                // Ensure we have an ID to pass
                const aId = a.id || a.assessment_id;

                // Format Date
                let dateDisplay = a.date || "Scheduled";
                try {
                    if (a.date) dateDisplay = new Date(a.date).toLocaleDateString();
                } catch (e) { }

                return `
                <div class="assessment-card" style="display:flex; justify-content:space-between; align-items:center; padding:1.5rem; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:12px; margin-bottom:1rem;">
                    <div>
                        <h3 style="margin:0 0 0.5rem 0; font-size:1.1rem; color:white;">${a.title}</h3>
                        <div style="color:var(--text-muted); font-size:0.9rem;">
                            ${a.subject} • ${dateDisplay} • ${a.duration_minutes || a.duration || 30} mins
                        </div>
                    </div>
                    <button class="btn-primary" 
                            style="padding: 0.6rem 1.5rem;"
                            onclick="startAssessment('${aId}')">
                        Start
                    </button>
                </div>`;
            }).join('');
        };

        // FORGOT PASSWORD LOGIC
        function openForgotPassword() {
            document.getElementById("forgotModal").classList.remove("hidden");
        }

        function closeForgotPassword() {
            document.getElementById("forgotModal").classList.add("hidden");
        }

        async function resetPassword() {
            const email = document.getElementById("fp-email").value;
            const newPassword = document.getElementById("fp-new-password").value;
            const msg = document.getElementById("fp-message");

            if (!email || !newPassword) {
                msg.innerText = "Email and new password required";
                return;
            }

            msg.innerText = "Processing...";

            try {
                const res = await fetch("/api/auth/reset-password", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, newPassword })
                });

                const data = await res.json();
                msg.innerText = data.message;

                if (data.success) {
                    setTimeout(() => closeForgotPassword(), 2000);
                }
            } catch (e) {
                console.error(e);
                msg.innerText = "Server error. Try again later.";
            }
        }
    </script>
    <!-- Forgot Password Modal -->
    <div id="forgotModal" class="hidden">
        <div class="modal-content">
            <h3 class="fp-modal-title">Reset Password</h3>
            <p class="fp-modal-subtitle">Enter your email to set a new password.</p>

            <input type="email" id="fp-email" placeholder="Email Address" />
            <input type="password" id="fp-new-password" placeholder="New Password" />

            <button onclick="resetPassword()" class="btn-reset">Set New Password</button>
            <button onclick="closeForgotPassword()" class="btn-cancel">Cancel</button>

            <p id="fp-message" class="fp-modal-message"></p>
        </div>
    </div>
</body>

</html>